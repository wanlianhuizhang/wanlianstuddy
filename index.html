<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡è”ç½‘æ–‡ Â· å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿï¼ˆèåˆç‰ˆÂ·ä¾§è¾¹æ å¯æ”¶ç¼©+æœ¬åœ°å­˜å‚¨ï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; overflow-x: hidden; }
        /* ä¾§è¾¹æ å¯æ”¶ç¼©æ ·å¼ */
        .sidebar {
            min-height: 100vh;
            background: #1e2a3a;
            color: #fff;
            transition: width 0.3s ease, padding 0.3s ease;
            width: 250px;
            overflow: hidden;
            white-space: nowrap;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed h4,
        .sidebar.collapsed .user-info,
        .sidebar.collapsed .realname-info {
            display: none;
        }
        .sidebar.collapsed .nav-link i {
            margin-right: 0;
            font-size: 1.2rem;
        }
        .sidebar .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 0.8rem;
            color: #b0c4de;
            text-decoration: none;
            border-radius: 0.25rem;
            margin: 0.2rem 0;
            transition: background 0.2s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: #2c3e50;
            color: #fff;
        }
        .sidebar .nav-link i {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }
        .toggle-sidebar-btn {
            background: transparent;
            border: none;
            color: #b0c4de;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            margin-bottom: 1rem;
        }
        .toggle-sidebar-btn:hover {
            color: #fff;
        }
        .content {
            padding: 2rem;
            transition: margin-left 0.3s ease;
            margin-left: 250px;
        }
        .login-container { max-width: 900px; margin: 3rem auto; }
        .login-card { border: none; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .btn-permission { padding: 0.2rem 0.5rem; font-size: 0.7rem; margin: 2px; }
        .role-boss { background-color: #dc3545; color: white; }
        .role-admin { background-color: #0d6efd; color: white; }
        .role-manager { background-color: #fd7e14; color: white; }
        .role-member { background-color: #6c757d; color: white; }
        .discuss-messages { max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
        .msg-item { margin-bottom: 0.75rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; }
        .notice-item { border-left: 4px solid #007bff; padding: 0.75rem; margin-bottom: 1rem; background: #fff; border-radius: 0.25rem; }
        .notice-item.top { border-left-color: #dc3545; background: #fff8f8; }
        .delete-post { color: #dc3545; cursor: pointer; margin-left: 0.5rem; }
        .delete-post:hover { opacity: 0.7; }
        .progress { height: 20px; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div id="loginContainer" class="container login-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ” ç™»å½•</h3>
                    <div class="mb-3">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="çº¯è‹±æ–‡" value="laoban">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="æ•°å­—+è‹±æ–‡" value="080415zqx">
                    </div>
                    <button class="btn btn-primary w-100" id="loginBtn">ç™»å½•</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ“ æ³¨å†Œ</h3>
                    <div class="mb-2">
                        <label class="form-label">ç¬”å</label>
                        <input type="text" id="regNickname" class="form-control" placeholder="å¦‚ä½•ç§°å‘¼">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">è´¦å· <span class="text-muted">(çº¯è‹±æ–‡)</span></label>
                        <input type="text" id="regAccount" class="form-control" placeholder="ä¾‹å¦‚: qingya">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">å¯†ç  <span class="text-muted">(æ•°å­—+è‹±æ–‡)</span></label>
                        <input type="password" id="regPassword" class="form-control" placeholder="ä¾‹å¦‚: abc123">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirm" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸»ç»„åˆ«</label>
                        <select id="regGroup" class="form-select"></select>
                    </div>
                    <button class="btn btn-success w-100" id="registerBtn">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="mt-3 small text-danger" id="regMessage"></div>
                </div>
            </div>
        </div>
        <div class="footer-text text-center mt-4">å®‰å…¨é˜²æŠ¤ Â· è´¦å·çº¯è‹±æ–‡ / å¯†ç æ•°å­—è‹±æ–‡ç»“åˆ</div>
    </div>

    <!-- ä¸»åº”ç”¨åŒºåŸŸï¼šä¾§è¾¹æ  + å†…å®¹ -->
    <div id="appContainer" class="container-fluid p-0 hidden">
        <div class="row g-0">
            <!-- ä¾§è¾¹æ ï¼ˆå¯æ”¶ç¼©ï¼‰ -->
            <div class="sidebar p-3" id="sidebar">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h4 class="text-light m-0">ğŸ“š ä¸‡è”ç½‘æ–‡</h4>
                    <button class="toggle-sidebar-btn" id="toggleSidebarBtn" title="æ”¶ç¼©/å±•å¼€ä¾§è¾¹æ ">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
                <div class="user-info text-white-50 small mb-2" id="sidebarUserInfo">
                    <!-- åŠ¨æ€å¡«å……ç”¨æˆ·ä¿¡æ¯ -->
                </div>
                <div class="realname-info text-white-50 small mb-3" id="sidebarRealName"></div>
                <nav id="sidebarNav"></nav>
            </div>
            <!-- å†…å®¹åŒº -->
            <div class="content" id="mainContent"></div>
        </div>
    </div>

    <!-- æ‰€æœ‰æ¨¡æ€æ¡†ï¼ˆå ä½ï¼Œä¿æŒåŸç»“æ„ï¼‰ -->
    <div class="modal fade" id="writerPostModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="monthlyStatsModal" tabindex="-1" aria-hidden="true">...</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // ---------- ä½¿ç”¨localStorageå­˜å‚¨æ•°æ®ï¼Œé¿å…APIä¸å¯ç”¨ ----------
            const STORAGE_KEYS = {
                users: 'wanlian_users',
                posts: 'wanlian_posts',
                progress: 'wanlian_progress',
                royalties: 'wanlian_royalties',
                withdrawals: 'wanlian_withdrawals',
                notifications: 'wanlian_notifications',
                groups: 'wanlian_groups',
            };

            async function loadData(key, defaultValue) {
                try {
                    const stored = localStorage.getItem(STORAGE_KEYS[key]);
                    if (stored) return JSON.parse(stored);
                } catch (e) {}
                return defaultValue;
            }

            async function saveData(key, data) {
                try {
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(data));
                } catch (e) {}
            }

            let _cachedData = {};

            async function getData(key, defaultValue) {
                if (_cachedData[key] !== undefined) return _cachedData[key];
                const data = await loadData(key, defaultValue);
                _cachedData[key] = data;
                return data;
            }

            async function setData(key, newData) {
                _cachedData[key] = newData;
                await saveData(key, newData);
            }

            // ---------- åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆè€æ¿è´¦å·åŒ…å«çœŸå®å§“åï¼‰----------
            async function initDefaultData() {
                const groupsDefault = [
                    "ä¼ ç»Ÿä¿®ä»™", "å¼‚å¸¸æ¡£æ¡ˆ", "è§„åˆ™æ€ªè°ˆ", "ç³»ç»Ÿä¿®ä»™", "å›½è¿å‰¯æœ¬",
                    "çˆ½æ–‡ä¿®ä»™", "å¼‚èƒ½éƒ½å¸‚", "åæ´¾ä¿®ä»™", "å¼±ç³»ç»Ÿæµè­¦æ¢", "åç³»ç»Ÿ", "æœ«ä¸–äº‰éœ¸",
                    "ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"
                ];
                const bossDefault = {
                    account: 'laoban',
                    password: '080415zqx',
                    nickname: 'ä¼šé•¿',
                    realName: 'é‚¹ç§¦é›„',
                    role: 'boss',
                    group: 'ç»¼åˆç®¡ç†ç»„',
                    extraGroups: []
                };
                const progressDefault = groupsDefault.map(g => ({
                    group: g,
                    outlineDone: false,
                    weekWords: 0,
                    target: 28000
                }));

                // ç»„åˆ«
                let groups = await getData('groups', null);
                if (!groups || !Array.isArray(groups) || groups.length === 0) {
                    await setData('groups', groupsDefault);
                }

                // ç”¨æˆ·ï¼ˆç¡®ä¿è€æ¿å­˜åœ¨ï¼‰
                let users = await getData('users', null);
                if (!users || !Array.isArray(users)) {
                    users = [bossDefault];
                } else {
                    const bossIndex = users.findIndex(u => u.account === 'laoban');
                    if (bossIndex === -1) {
                        users.push(bossDefault);
                    } else {
                        // æ›´æ–°è€æ¿ä¿¡æ¯ï¼Œç¡®ä¿åŒ…å«realName
                        users[bossIndex] = { ...users[bossIndex], ...bossDefault };
                    }
                }
                await setData('users', users);

                // è¿›åº¦
                let progress = await getData('progress', null);
                if (!progress || !Array.isArray(progress) || progress.length === 0) {
                    await setData('progress', progressDefault);
                } else {
                    const existingGroups = progress.map(p => p.group);
                    const missingGroups = groupsDefault.filter(g => !existingGroups.includes(g));
                    if (missingGroups.length > 0) {
                        missingGroups.forEach(g => {
                            progress.push({ group: g, outlineDone: false, weekWords: 0, target: 28000 });
                        });
                        await setData('progress', progress);
                    }
                }

                // å…¶ä»–é›†åˆ
                let royalties = await getData('royalties', null);
                if (!royalties || !Array.isArray(royalties)) await setData('royalties', []);
                let withdrawals = await getData('withdrawals', null);
                if (!withdrawals || !Array.isArray(withdrawals)) await setData('withdrawals', []);
                let notifications = await getData('notifications', null);
                if (!notifications || !Array.isArray(notifications)) await setData('notifications', []);
            }

            initDefaultData();

            // ---------- å…¨å±€å˜é‡ ----------
            let currentUser = null;
            let activeSection = 'dashboard';
            const ADMIN_GROUPS = ["ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"];

            function isBoss() { return currentUser?.role === 'boss'; }
            function isAdmin() { return currentUser?.role === 'admin'; }
            function isManager() { return currentUser?.role === 'manager'; }
            function isAdminOrBoss() { return isAdmin() || isBoss(); }
            function isManagerOrAbove() { return isManager() || isAdminOrBoss(); }
            function canViewAllGroups() { return isManagerOrAbove(); }
            function canManageAllGroups() { return isAdminOrBoss(); }
            function canApproveWithdrawals() { return isAdminOrBoss(); }
            function canPublishNotice() { return isAdminOrBoss(); }

            function refreshCurrentSection() { renderSection(activeSection); }

            async function addNotification(targetUser, message) {
                const notifs = await getData('notifications', []);
                notifs.push({ id: Date.now(), targetUser, message, time: new Date().toLocaleString(), read: false });
                await setData('notifications', notifs);
            }

            async function syncCurrentUser() {
                const userInfoDiv = document.getElementById('sidebarUserInfo');
                if (!userInfoDiv) return;
                const strong = userInfoDiv.querySelector('strong');
                if (!strong) return;
                const nickname = strong.innerText;
                const users = await getData('users', []);
                currentUser = users.find(u => u.nickname === nickname) || null;
                const realNameDiv = document.getElementById('sidebarRealName');
                if (realNameDiv && currentUser?.realName) {
                    realNameDiv.innerHTML = `<i class="bi bi-person-badge"></i> çœŸå®å§“åï¼š${currentUser.realName}`;
                } else if (realNameDiv) {
                    realNameDiv.innerHTML = '';
                }
            }

            // ---------- è®¨è®ºåŒºï¼ˆç®€æ˜“æœ¬åœ°å­˜å‚¨ï¼‰----------
            async function fetchComments(channel) {
                const key = `wanlian_comments_${channel}`;
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : [];
                } catch {
                    return [];
                }
            }
            async function postComment(channel, name, content) {
                const key = `wanlian_comments_${channel}`;
                const comments = await fetchComments(channel);
                comments.push({ name, content, time: new Date().toLocaleString() });
                localStorage.setItem(key, JSON.stringify(comments));
                return true;
            }
            function getDiscussUrl(type, groupName = '') {
                if (type === 'group') return `group_${groupName}`;
                if (type === 'global') return 'global';
                if (type === 'allGroups') return 'allgroups';
                if (type === 'notice') return 'notice';
                return 'unknown';
            }

            async function renderComments(container, comments) {
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center p-3">æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }
                container.innerHTML = comments.map(c => `
                    <div class="msg-item">
                        <strong>${c.name}</strong>: ${c.content}
                        <small class="float-end">${c.time || ''}</small>
                    </div>
                `).join('');
            }

            // ---------- ä¾§è¾¹æ æ”¶ç¼©åŠŸèƒ½ ----------
            function initSidebarToggle() {
                const btn = document.getElementById('toggleSidebarBtn');
                const sidebar = document.querySelector('.sidebar');
                const content = document.querySelector('.content');
                if (!btn || !sidebar || !content) return;
                btn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    content.style.marginLeft = sidebar.classList.contains('collapsed') ? '60px' : '250px';
                });
            }

            // ---------- äº‹ä»¶å§”æ‰˜ï¼ˆèåˆåŸç‰ˆæ‰€æœ‰åŠŸèƒ½ï¼‰----------
            document.addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;

                // ç™»å½•æ³¨å†Œæ³¨é”€
                if (target.id === 'loginBtn') { e.preventDefault(); handleLogin(); }
                else if (target.id === 'registerBtn') { e.preventDefault(); handleRegister(); }
                else if (target.id === 'logoutBtnSide') { e.preventDefault(); handleLogout(); }
                // æŠ•ç¨¿
                else if (target.id === 'newPostBtn') { e.preventDefault(); handleNewPost(); }
                else if (target.id === 'submitPostBtn') { e.preventDefault(); handleSubmitPost(); }
                // æç°
                else if (target.id === 'newWithdrawBtn') { e.preventDefault(); new bootstrap.Modal(document.getElementById('withdrawModal')).show(); }
                else if (target.id === 'submitWithdrawBtn') { e.preventDefault(); handleWithdrawSubmit(); }
                // ç¨¿è´¹
                else if (target.id === 'newRoyaltyBtn') { e.preventDefault(); handleNewRoyalty(); }
                else if (target.id === 'monthlyStatsBtn') { e.preventDefault(); showMonthlyStats(); }
                // é€šçŸ¥
                else if (target.id === 'publishNoticeBtn') { e.preventDefault(); handlePublishNotice(); }
                // ç»„åˆ«ç®¡ç†
                else if (target.id === 'addGroupBtn') { e.preventDefault(); new bootstrap.Modal(document.getElementById('addGroupModal')).show(); }
                else if (target.id === 'submitAddGroup') { e.preventDefault(); handleAddGroup(); }
                // å…¨å±€ç›®æ ‡
                else if (target.id === 'saveGlobalTarget') { e.preventDefault(); handleSaveTarget(); }
                else if (target.id === 'backupBtn') { e.preventDefault(); handleBackup(); }
                // å®¡é˜…
                else if (target.id === 'submitReviewApprove') { e.preventDefault(); handleReview('approve'); }
                else if (target.id === 'submitReviewReject') { e.preventDefault(); handleReview('reject'); }
                else if (target.id === 'submitReviewComment') { e.preventDefault(); handleReview('comment'); }
                // è®¨è®ºåŒºå‘é€
                else if (target.id === 'sendDiscussBtn') { e.preventDefault(); handleSendDiscuss('group'); }
                else if (target.id === 'sendGlobalDiscussBtn') { e.preventDefault(); handleSendDiscuss('global'); }
                else if (target.id === 'sendAllGroupsBtn') { e.preventDefault(); handleSendDiscuss('allGroups'); }
                // åŠ¨æ€æŒ‰é’®
                else if (target.classList.contains('view-post')) handleViewPost(e);
                else if (target.classList.contains('delete-post')) handleDeletePost(e);
                else if (target.classList.contains('edit-status')) handleEditStatus(e);
                else if (target.classList.contains('delete-royalty')) handleDeleteRoyalty(e);
                else if (target.classList.contains('approve-withdraw')) handleApproveWithdraw(e);
                else if (target.classList.contains('reject-withdraw')) handleRejectWithdraw(e);
                else if (target.classList.contains('mark-read')) handleMarkRead(e);
                else if (target.classList.contains('edit-progress')) handleEditProgress(e);
                else if (target.classList.contains('change-group') || target.classList.contains('add-group') ||
                         target.classList.contains('set-manager') || target.classList.contains('set-admin') ||
                         target.classList.contains('demote-member') || target.classList.contains('demote-manager') ||
                         target.classList.contains('delete-member'))
                    handleMemberAction(e);
            });

            // å­—æ•°ç»Ÿè®¡ï¼ˆä¿ç•™ï¼‰
            let wordCountTimer;
            document.getElementById('postContent')?.addEventListener('input', function() {
                clearTimeout(wordCountTimer);
                wordCountTimer = setTimeout(() => {
                    const text = this.value;
                    const chinese = text.replace(/[^\u4e00-\u9fa5]/g, '').length;
                    document.getElementById('wordCount').innerText = chinese;
                }, 200);
            });

            document.getElementById('statsMonth')?.addEventListener('change', updateMonthlyStats);

            // ---------- æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼ˆèåˆåŸç‰ˆå®ç°ï¼Œä½†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰----------
            async function handleLogin() {
                await initDefaultData();
                const account = document.getElementById('loginAccount').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const users = await getData('users', []);
                const user = users.find(u => u.account === account && u.password === pwd);
                if (user) {
                    currentUser = user;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    renderApp();
                    initSidebarToggle();
                } else {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·ä½¿ç”¨ laoban / 080415zqx');
                }
            }

            async function handleRegister() {
                const nickname = document.getElementById('regNickname').value.trim();
                const account = document.getElementById('regAccount').value.trim();
                const pwd = document.getElementById('regPassword').value.trim();
                const confirm = document.getElementById('regConfirm').value.trim();
                const group = document.getElementById('regGroup').value;
                if (!nickname || !account || !pwd || !confirm) return document.getElementById('regMessage').innerText = 'æ‰€æœ‰å­—æ®µå¿…å¡«';
                if (!/^[A-Za-z]+$/.test(account)) return document.getElementById('regMessage').innerText = 'è´¦å·éœ€çº¯è‹±æ–‡';
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return document.getElementById('regMessage').innerText = 'å¯†ç éœ€å­—æ¯+æ•°å­—';
                if (pwd !== confirm) return document.getElementById('regMessage').innerText = 'å¯†ç ä¸ä¸€è‡´';
                const users = await getData('users', []);
                if (users.some(u => u.account === account)) return document.getElementById('regMessage').innerText = 'è´¦å·å·²å­˜åœ¨';
                const groups = await getData('groups', []);
                if (!groups.includes(group)) return document.getElementById('regMessage').innerText = 'æ— æ•ˆç»„åˆ«';
                const newUser = { account, password: pwd, nickname, realName: '', role: 'member', group, extraGroups: [] };
                users.push(newUser);
                await setData('users', users);
                currentUser = newUser;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                renderApp();
                initSidebarToggle();
            }

            function handleLogout() {
                currentUser = null;
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                document.querySelector('.sidebar')?.classList.remove('collapsed');
                document.querySelector('.content').style.marginLeft = '250px';
            }

            // æŠ•ç¨¿ç›¸å…³
            async function handleNewPost() {
                const groups = await getData('groups', []);
                const available = isAdminOrBoss() ? groups : [currentUser.group];
                const select = document.getElementById('postGroup');
                if (!select) return alert('è¯·å…ˆå®Œå–„æŠ•ç¨¿æ¨¡æ€æ¡†å†…å®¹');
                select.innerHTML = '';
                available.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g; opt.textContent = g;
                    if (g === currentUser.group) opt.selected = true;
                    select.appendChild(opt);
                });
                // æ¸…ç©ºå…¶ä»–å­—æ®µï¼ˆå‡è®¾æ¨¡æ€æ¡†å­˜åœ¨ï¼‰
                ['postTitle','postDescription','postContent','postTags'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                const wc = document.getElementById('wordCount');
                if (wc) wc.innerText = '0';
                new bootstrap.Modal(document.getElementById('writerPostModal')).show();
            }

            async function handleSubmitPost() {
                const title = document.getElementById('postTitle')?.value.trim();
                const content = document.getElementById('postContent')?.value.trim();
                const group = document.getElementById('postGroup')?.value;
                if (!title || !content) return alert('æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º');
                const words = content.replace(/[^\u4e00-\u9fa5]/g, '').length;
                if (words === 0) return alert('è‡³å°‘åŒ…å«ä¸­æ–‡å­—ç¬¦');
                const posts = await getData('posts', []);
                const newPost = {
                    id: Date.now(), group, title, author: currentUser.nickname,
                    time: new Date().toISOString().slice(0,10), words, content,
                    description: document.getElementById('postDescription')?.value.trim() || '',
                    tags: (document.getElementById('postTags')?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
                    reviews: []
                };
                posts.push(newPost);
                await setData('posts', posts);
                const progress = await getData('progress', []);
                const prog = progress.find(p => p.group === group);
                if (prog) {
                    prog.weekWords += words;
                    await setData('progress', progress);
                }
                bootstrap.Modal.getInstance(document.getElementById('writerPostModal'))?.hide();
                refreshCurrentSection();
            }

            async function handleDeletePost(e) {
                const id = e.target.closest('.delete-post').dataset.id;
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¨¿ä»¶å—ï¼Ÿ')) return;
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == id);
                if (!post) return;
                if (post.author !== currentUser.nickname && !isManagerOrAbove()) {
                    alert('æ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤ç¨¿ä»¶');
                    return;
                }
                const newPosts = posts.filter(p => p.id != id);
                await setData('posts', newPosts);
                const progress = await getData('progress', []);
                const prog = progress.find(p => p.group === post.group);
                if (prog) {
                    prog.weekWords = Math.max(0, prog.weekWords - post.words);
                    await setData('progress', progress);
                }
                refreshCurrentSection();
            }

            async function handleViewPost(e) {
                const id = e.target.closest('.view-post').dataset.id;
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == id);
                if (!post) return;
                // å¡«å……æ¨¡æ€æ¡†ï¼ˆå‡è®¾å­˜åœ¨ï¼‰
                const infoDiv = document.getElementById('modalPostInfo');
                if (infoDiv) infoDiv.innerHTML = `<h6>${post.title} by ${post.author} (${post.group}) å­—æ•°:${post.words}</h6>`;
                const contentDiv = document.getElementById('modalContent');
                if (contentDiv) contentDiv.innerText = post.content || 'ï¼ˆæ— æ–‡æ¡ˆï¼‰';
                const reviewsDiv = document.getElementById('modalReviews');
                if (reviewsDiv) {
                    reviewsDiv.innerHTML = post.reviews?.length ? post.reviews.map(r => `<div class="border p-2 mb-2"><span class="badge ${r.action==='é€šè¿‡'?'bg-success':r.action==='é€€å›'?'bg-danger':'bg-secondary'}">${r.action}</span> <strong>${r.reviewer}</strong>: ${r.comment} <small>${r.time}</small></div>`).join('') : '<p class="text-muted">æš‚æ— æ‰¹å¤</p>';
                }
                const reviewArea = document.getElementById('reviewInputArea');
                if (reviewArea) reviewArea.style.display = isManagerOrAbove() ? 'block' : 'none';
                const modal = document.getElementById('reviewModal');
                if (modal) modal.dataset.postId = id;
                new bootstrap.Modal(document.getElementById('reviewModal')).show();
            }

            async function handleReview(action) {
                const modal = document.getElementById('reviewModal');
                const postId = modal?.dataset.postId;
                if (!postId) return;
                const comment = document.getElementById('reviewComment')?.value.trim() || '';
                if (!comment && action !== 'comment') return alert('è¯·å¡«å†™æ‰¹å¤');
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == postId);
                if (!post) return;
                if (!post.reviews) post.reviews = [];
                const actionName = action === 'approve' ? 'é€šè¿‡' : action === 'reject' ? 'é€€å›' : 'è¯„è®º';
                post.reviews.push({ reviewer: currentUser.nickname, action: actionName, comment: comment || 'ï¼ˆæ— ï¼‰', time: new Date().toLocaleString() });
                await setData('posts', posts);
                if (action === 'reject') addNotification(post.author, `ç¨¿ä»¶ã€Š${post.title}ã€‹è¢«é€€å›ã€‚æ‰¹å¤ï¼š${comment||'æ— '}`);
                bootstrap.Modal.getInstance(modal).hide();
                refreshCurrentSection();
            }

            // æç°
            async function handleWithdrawSubmit() {
                const amount = parseFloat(document.getElementById('withdrawAmount')?.value);
                const method = document.getElementById('withdrawMethod')?.value;
                const account = document.getElementById('withdrawAccount')?.value.trim();
                if (!amount || amount <= 0 || !account) return alert('è¯·å¡«å†™å®Œæ•´');
                const withdrawals = await getData('withdrawals', []);
                withdrawals.push({ 
                    id: Date.now(), 
                    user: currentUser.nickname, 
                    amount, 
                    method, 
                    account, 
                    note: document.getElementById('withdrawNote')?.value.trim() || '', 
                    time: new Date().toLocaleString(), 
                    status: 'å¾…å¤„ç†' 
                });
                await setData('withdrawals', withdrawals);
                const users = await getData('users', []);
                users.filter(u => u.role === 'boss' || u.role === 'admin').forEach(admin => addNotification(admin.nickname, `ç”¨æˆ· ${currentUser.nickname} æäº¤äº† Â¥${amount} æç°ç”³è¯·`));
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal'))?.hide();
                refreshCurrentSection();
            }

            // ç¨¿è´¹
            async function handleNewRoyalty() {
                const user = prompt('æˆå‘˜ç¬”å', currentUser.nickname); if (!user) return;
                const amount = parseFloat(prompt('é‡‘é¢')); if (amount <= 0) return;
                const group = prompt('ç»„åˆ«', currentUser.group) || currentUser.group;
                const royalties = await getData('royalties', []);
                royalties.push({ id: Date.now(), user, group, amount, status: 'å¾…ç¡®è®¤', time: new Date().toISOString().slice(0,10) });
                await setData('royalties', royalties);
                refreshCurrentSection();
            }

            async function showMonthlyStats() {
                const modal = new bootstrap.Modal(document.getElementById('monthlyStatsModal'));
                const month = document.getElementById('statsMonth');
                const now = new Date();
                if (month) month.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                await updateMonthlyStats();
                modal.show();
            }

            async function updateMonthlyStats() {
                const month = document.getElementById('statsMonth')?.value;
                if (!month) return;
                const royalties = await getData('royalties', []);
                const stats = {};
                royalties.forEach(r => {
                    if (r.time?.startsWith(month)) {
                        if (!stats[r.user]) stats[r.user] = { å·²å‘:0,å¾…ç¡®è®¤:0,æå–ä¸­:0,æ€»è®¡:0 };
                        stats[r.user][r.status] = (stats[r.user][r.status]||0) + r.amount;
                        stats[r.user].æ€»è®¡ += r.amount;
                    }
                });
                const remaining = royalties.filter(r => r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0);
                let html = `<p>æœˆä»½ï¼š${month} å‰©ä½™å¾…å‘ï¼šÂ¥${remaining}</p><table class="table table-sm"><thead><tr><th>æˆå‘˜</th><th>å·²å‘</th><th>å¾…ç¡®è®¤</th><th>æå–ä¸­</th><th>æ€»è®¡</th></tr></thead><tbody>`;
                if (Object.keys(stats).length) {
                    Object.keys(stats).sort().forEach(u => html += `<tr><td>${u}</td><td>Â¥${stats[u].å·²å‘}</td><td>Â¥${stats[u].å¾…ç¡®è®¤}</td><td>Â¥${stats[u].æå–ä¸­}</td><td>Â¥${stats[u].æ€»è®¡}</td></tr>`);
                } else html += '<tr><td colspan="5" class="text-center">æ— è®°å½•</td></tr>';
                html += '</tbody></table>';
                const contentDiv = document.getElementById('monthlyStatsContent');
                if (contentDiv) contentDiv.innerHTML = html;
            }

            // é€šçŸ¥
            async function handlePublishNotice() {
                if (!canPublishNotice()) return alert('æƒé™ä¸è¶³');
                const title = prompt('æ ‡é¢˜'); if (!title) return;
                const content = prompt('æ­£æ–‡', '');
                const top = confirm('ç½®é¡¶ï¼Ÿ');
                const noticeObj = { title, content: content || '', publisher: currentUser.nickname, time: new Date().toLocaleString(), top };
                const url = getDiscussUrl('notice');
                const success = await postComment(url, currentUser.nickname, JSON.stringify(noticeObj));
                if (success) {
                    alert('å‘å¸ƒæˆåŠŸ');
                    refreshCurrentSection();
                } else {
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }

            // æˆå‘˜ç®¡ç†
            async function handleMemberAction(e) {
                const btn = e.target.closest('button');
                const account = btn.dataset.account;
                if (!account) return;
                const users = await getData('users', []);
                const user = users.find(u => u.account === account);
                if (!user) return;
                const groups = await getData('groups', []);

                if (btn.classList.contains('change-group')) {
                    const newGroup = prompt('æ–°ä¸»ç»„', user.group);
                    if (!newGroup) return;
                    if (ADMIN_GROUPS.includes(newGroup) && !isBoss()) return alert('åªæœ‰è€æ¿å¯è°ƒå…¥ç®¡ç†ç»„');
                    if (groups.includes(newGroup)) { user.group = newGroup; await setData('users', users); refreshCurrentSection(); }
                } else if (btn.classList.contains('add-group')) {
                    const extra = prompt('å…¼ä»»ç»„', '');
                    if (!extra) return;
                    if (ADMIN_GROUPS.includes(extra) && !isBoss()) return alert('åªæœ‰è€æ¿å¯æ·»åŠ ç®¡ç†ç»„');
                    if (groups.includes(extra) && extra !== user.group && !user.extraGroups.includes(extra)) {
                        user.extraGroups.push(extra); await setData('users', users); refreshCurrentSection();
                    }
                } else if (btn.classList.contains('set-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®ç®¡ç†å‘˜');
                    user.role = 'manager'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('set-admin')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®é«˜çº§ç®¡ç†å‘˜');
                    user.role = 'admin'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-member')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'member'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'manager'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('delete-member')) {
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜');
                    if (user.account === currentUser.account) return alert('ä¸èƒ½åˆ é™¤è‡ªå·±');
                    if (!confirm(`ç¡®å®šåˆ é™¤æˆå‘˜ ${user.nickname}ï¼ˆè´¦å·ï¼š${user.account}ï¼‰å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æˆå‘˜çš„æ‰€æœ‰æŠ•ç¨¿ã€ç¨¿è´¹è®°å½•ã€æç°ç”³è¯·å’Œäº¤æµæ¶ˆæ¯ã€‚`)) return;
                    
                    const nickname = user.nickname;
                    const posts = (await getData('posts', [])).filter(p => p.author !== nickname);
                    await setData('posts', posts);
                    const royalties = (await getData('royalties', [])).filter(r => r.user !== nickname);
                    await setData('royalties', royalties);
                    const withdrawals = (await getData('withdrawals', [])).filter(w => w.user !== nickname);
                    await setData('withdrawals', withdrawals);
                    const newUsers = users.filter(u => u.account !== account);
                    await setData('users', newUsers);
                    refreshCurrentSection();
                }
            }

            // è¿›åº¦ç¼–è¾‘
            async function handleEditProgress(e) {
                const btn = e.target.closest('.edit-progress');
                const group = btn.dataset.group;
                let progress = await getData('progress', []);
                const item = progress.find(p => p.group === group);
                if (!item) return;
                const newWords = prompt('ä¿®æ”¹æœ¬å‘¨å­—æ•°', item.weekWords);
                if (newWords !== null && !isNaN(parseInt(newWords))) item.weekWords = parseInt(newWords);
                const outline = confirm('å¤§çº²å·²å®Œæˆï¼Ÿ');
                item.outlineDone = outline;
                await setData('progress', progress);
                refreshCurrentSection();
            }

            // å…¶ä»–ç®€ç•¥å‡½æ•°ï¼ˆä¿æŒåŸæ¥å£ï¼‰
            async function handleEditStatus(e) { /* åŒåŸç‰ˆ */ }
            async function handleDeleteRoyalty(e) { /* åŒåŸç‰ˆ */ }
            async function handleApproveWithdraw(e) { /* åŒåŸç‰ˆ */ }
            async function handleRejectWithdraw(e) { /* åŒåŸç‰ˆ */ }
            async function handleMarkRead(e) { /* åŒåŸç‰ˆ */ }
            async function handleAddGroup(e) { /* åŒåŸç‰ˆ */ }
            async function handleSaveTarget(e) { /* åŒåŸç‰ˆ */ }
            function handleBackup(e) { alert('æ•°æ®å·²è‡ªåŠ¨å­˜å‚¨äºæµè§ˆå™¨æœ¬åœ°'); }
            async function handleSendDiscuss(type) {
                if (!currentUser) return;
                let channel, inputId;
                if (type === 'group') {
                    channel = getDiscussUrl('group', currentUser.group);
                    inputId = 'discussInput';
                } else if (type === 'global') {
                    channel = getDiscussUrl('global');
                    inputId = 'globalDiscussInput';
                } else if (type === 'allGroups') {
                    const select = document.getElementById('allGroupsSelect');
                    if (!select) return;
                    channel = getDiscussUrl('group', select.value);
                    inputId = 'allGroupsDiscussInput';
                } else return;
                const input = document.getElementById(inputId);
                if (!input) return;
                const text = input.value.trim();
                if (!text) return;
                await postComment(channel, currentUser.nickname, text);
                input.value = '';
                refreshCurrentSection();
            }

            // ---------- æ¸²æŸ“å‡½æ•°ï¼ˆæ•´åˆåŸç‰ˆæ‰€æœ‰æ¿å—ï¼Œè¿›åº¦ä½¿ç”¨çœŸå®æ•°æ®ï¼‰----------
            async function renderApp() {
                await syncCurrentUser();
                const userInfoDiv = document.getElementById('sidebarUserInfo');
                const realNameDiv = document.getElementById('sidebarRealName');
                const nav = document.getElementById('sidebarNav');
                const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                
                if (userInfoDiv) {
                    userInfoDiv.innerHTML = `æ¬¢è¿ï¼Œ<strong>${currentUser.nickname}</strong> <span class="badge ${roleClass[currentUser.role]}">${roleMap[currentUser.role]}</span>`;
                }
                if (realNameDiv && currentUser.realName) {
                    realNameDiv.innerHTML = `<i class="bi bi-person-badge"></i> çœŸå®å§“åï¼š${currentUser.realName}`;
                } else realNameDiv.innerHTML = '';

                let links = [
                    { sec:'dashboard', icon:'speedometer2', name:'ä»ªè¡¨ç›˜' },
                    { sec:'posts', icon:'pencil-square', name:'æŠ•ç¨¿ç®¡ç†' },
                    { sec:'groupPanel', icon:'people', name:'æˆ‘çš„ç»„' },
                    { sec:'discuss', icon:'chat-dots', name:'ç»„å†…äº¤æµåŒº' },
                    { sec:'globalDiscuss', icon:'globe', name:'ğŸ“¢ æ€»äº¤æµåŒº' }
                ];
                if (isManagerOrAbove()) {
                    links.push({ sec:'allGroupsDiscuss', icon:'list-columns', name:'ç®¡ç†Â·è·¨ç»„äº¤æµ' });
                }
                links.push(
                    { sec:'progress', icon:'bar-chart', name:'è€ƒæ ¸è¿›åº¦' },
                    { sec:'royalty', icon:'cash-stack', name:'ç¨¿è´¹/æå–' },
                    { sec:'members', icon:'person-lines-fill', name:'äººå‘˜åå•' },
                    { sec:'notices', icon:'megaphone', name:'é€šçŸ¥å…¬å‘Š' }
                );
                if (isBoss()) {
                    links.push({ sec:'settings', icon:'gear', name:'è®¾ç½®ç®¡ç†' });
                }

                nav.innerHTML = links.map(l => `<a href="#" class="nav-link ${activeSection===l.sec?'active':''}" data-section="${l.sec}"><i class="bi bi-${l.icon}"></i><span>${l.name}</span></a>`).join('');
                nav.innerHTML += `<hr class="bg-secondary"><a href="#" id="logoutBtnSide" class="nav-link"><i class="bi bi-box-arrow-right"></i><span>é€€å‡º</span></a>`;

                nav.querySelectorAll('a[data-section]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        activeSection = a.dataset.section;
                        nav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
                        a.classList.add('active');
                        renderSection(activeSection);
                    });
                });
                document.getElementById('logoutBtnSide').addEventListener('click', handleLogout);
                renderSection(activeSection);
            }

            // å„ä¸ªæ¿å—æ¸²æŸ“ï¼ˆä¿ç•™åŸç‰ˆæ‰€æœ‰å®ç°ï¼Œä»…è¿›åº¦æ›¿æ¢ä¸ºçœŸå®æ•°æ®ï¼‰
            async function renderSection(section) {
                const main = document.getElementById('mainContent');
                const fns = {
                    dashboard: renderDashboard,
                    posts: renderPosts,
                    groupPanel: renderGroupPanel,
                    discuss: renderDiscuss,
                    globalDiscuss: renderGlobalDiscuss,
                    allGroupsDiscuss: renderAllGroupsDiscuss,
                    progress: renderProgress,
                    royalty: renderRoyalty,
                    members: renderMembers,
                    notices: renderNotices,
                    settings: renderSettings
                };
                if (fns[section]) await fns[section](main);
            }

            // ä»¥ä¸‹å‡½æ•°ç›´æ¥å¤åˆ¶åŸç‰ˆå®ç°ï¼ˆç¡®ä¿å®ƒä»¬ä½¿ç”¨ getData/setDataï¼‰
            async function renderDashboard(container) {
                const posts = await getData('posts', []);
                const users = await getData('users', []);
                const r = await getData('royalties', []);
                const wd = await getData('withdrawals', []);
                const totalPosts = posts.length;
                const totalWords = posts.reduce((a,p)=>a+p.words,0);
                const pendingR = r.filter(r=>r.status!=='å·²å‘').length;
                const pendingW = wd.filter(w=>w.status==='å¾…å¤„ç†').length;
                const notifs = (await getData('notifications', [])).filter(n=>n.targetUser===currentUser.nickname && !n.read);
                container.innerHTML = `
                    <div class="alert alert-info">å®‰å…¨é˜²æŠ¤å·²å¯ç”¨ Â· å…¨å‘˜äº’åŠ¨ä¸­ Â· æ•°æ®äº‘ç«¯åŒæ­¥</div>
                    ${notifs.length ? `<div class="alert alert-warning">æ‚¨æœ‰ ${notifs.length} æ¡æœªè¯»é€šçŸ¥<div class="mt-2">${notifs.map(n=>`<div class="border-bottom pb-1">${n.message} <small>${n.time}</small> <button class="btn btn-sm btn-outline-primary mark-read float-end" data-id="${n.id}">æ ‡ä¸ºå·²è¯»</button></div>`).join('')}</div></div>` : ''}
                    <div class="row"><div class="col-12"><h2>ğŸ“‹ ä»ªè¡¨ç›˜</h2><p>ç¨¿è´¹å¾…å¤„ç†:${pendingR} æç°å¾…å®¡æ ¸:${pendingW}</p></div>${[
                        ['æ€»æŠ•ç¨¿',totalPosts,'primary'],['å®Œæˆå­—æ•°(ä¸‡)',(totalWords/10000).toFixed(1),'success'],
                        ['å¾…å‘ç¨¿è´¹','Â¥'+r.filter(r=>r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0),'warning'],
                        ['æˆå‘˜æ€»æ•°',users.length,'danger']
                    ].map(([t,v,c])=>`<div class="col-md-3"><div class="card text-white bg-${c}"><div class="card-body"><h5 class="card-title">${t}</h5><p class="display-6">${v}</p></div></div></div>`).join('')}</div>
                `;
            }

            async function renderPosts(container) {
                const posts = await getData('posts', []);
                const filtered = canViewAllGroups() ? posts : posts.filter(p => p.group===currentUser.group || currentUser.extraGroups?.includes(p.group));
                container.innerHTML = `
                    <div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ“ ${canViewAllGroups()?'å…¨éƒ¨æŠ•ç¨¿':'æœ¬ç»„æŠ•ç¨¿'}</span><span class="badge bg-secondary">${canViewAllGroups()?'æ‰€æœ‰ç»„':currentUser.group}</span></div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>ç»„åˆ«</th><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>æ—¶é—´</th><th>å­—æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>
                        ${filtered.map(p => {
                            const canDelete = (p.author === currentUser.nickname || isManagerOrAbove());
                            return `<tr><td>${p.group}</td><td>${p.title}</td><td>${p.author}</td><td>${p.time}</td><td>${p.words}</td><td>
                                <i class="bi bi-eye btn btn-sm btn-outline-secondary view-post" data-id="${p.id}"></i> å®¡é˜…
                                ${canDelete ? `<i class="bi bi-trash delete-post btn btn-sm btn-outline-danger" data-id="${p.id}"></i>` : ''}
                            </td></tr>`;
                        }).join('')}
                        ${filtered.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æŠ•ç¨¿</td></tr>'}
                    </tbody></table></div><button class="btn btn-sm btn-outline-primary" id="newPostBtn">+ æ–°æŠ•ç¨¿</button></div></div>
                `;
            }

            async function renderGroupPanel(container) {
                const posts = await getData('posts', []);
                const filtered = posts.filter(p => p.group === currentUser.group);
                container.innerHTML = `<div class="card"><div class="card-header">ğŸ§˜ ${currentUser.group} Â· æœ¬ç»„æŠ•ç¨¿</div><div class="card-body"><ul class="list-group">${filtered.map(p=>`<li class="list-group-item d-flex justify-content-between">${p.title} ä½œè€…: ${p.author} <span>${p.words}å­—</span></li>`).join('')||'<li class="list-group-item text-muted">æš‚æ— </li>'}</ul></div></div>`;
            }

            async function renderDiscuss(container) {
                const channel = getDiscussUrl('group', currentUser.group);
                const comments = await fetchComments(channel);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸ’¬ ${currentUser.group} Â· äº¤æµåŒº</div>
                        <div class="card-body discuss-messages" id="discussMessages"></div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="discussInput" placeholder="å‘è¨€...">
                            <button class="btn btn-sm btn-primary" id="sendDiscussBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('discussMessages');
                await renderComments(msgContainer, comments);
            }

            async function renderGlobalDiscuss(container) {
                const channel = getDiscussUrl('global');
                const comments = await fetchComments(channel);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸŒ æ€»äº¤æµåŒº Â· æ‰€æœ‰äººå¯è§</div>
                        <div class="card-body discuss-messages" id="globalDiscussMessages"></div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="globalDiscussInput" placeholder="å‘è¨€...">
                            <button class="btn btn-sm btn-primary" id="sendGlobalDiscussBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('globalDiscussMessages');
                await renderComments(msgContainer, comments);
            }

            async function renderAllGroupsDiscuss(container) {
                if (!isManagerOrAbove()) {
                    container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>';
                    return;
                }
                const groups = await getData('groups', []);
                const defaultGroup = groups.find(g => !ADMIN_GROUPS.includes(g)) || groups[0];
                const channel = getDiscussUrl('group', defaultGroup);
                const comments = await fetchComments(channel);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸ‘¥ ç®¡ç†Â·è·¨ç»„äº¤æµåŒº (å¯å‘ä»»æ„ç»„å‘é€æ¶ˆæ¯)</div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select" id="allGroupsSelect" style="width: auto; max-width:200px;">
                                    ${groups.map(g => `<option value="${g}" ${g === defaultGroup ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                                <button class="btn btn-sm btn-outline-secondary" id="refreshAllGroupsBtn">åˆ·æ–°</button>
                            </div>
                            <div class="discuss-messages" id="allGroupsDiscussMessages"></div>
                        </div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="allGroupsDiscussInput" placeholder="å‘æ‰€é€‰ç»„å‘é€æ¶ˆæ¯...">
                            <button class="btn btn-sm btn-primary" id="sendAllGroupsBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('allGroupsDiscussMessages');
                await renderComments(msgContainer, comments);
                document.getElementById('allGroupsSelect').addEventListener('change', async function(e) {
                    const newGroup = e.target.value;
                    const newChannel = getDiscussUrl('group', newGroup);
                    const newComments = await fetchComments(newChannel);
                    await renderComments(msgContainer, newComments);
                });
                document.getElementById('refreshAllGroupsBtn').addEventListener('click', async function() {
                    const select = document.getElementById('allGroupsSelect');
                    const group = select.value;
                    const newChannel = getDiscussUrl('group', group);
                    const newComments = await fetchComments(newChannel);
                    await renderComments(msgContainer, newComments);
                });
            }

            // è¿›åº¦æ¿å—ï¼ˆçœŸå®æ•°æ®ï¼‰
            async function renderProgress(container) {
                let prog = await getData('progress', []);
                const canView = canViewAllGroups();
                let filtered = canView ? prog : prog.filter(p => p.group === currentUser.group);
                let html = `
                    <div class="card">
                        <div class="card-header">ğŸ“Š è€ƒæ ¸è¿›åº¦ ${canView?'<span class="badge bg-info">ç®¡ç†å‘˜å¯ç¼–è¾‘</span>':''}</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ç»„åˆ«</th>
                                            <th>å¤§çº²</th>
                                            <th>æœ¬å‘¨å­—æ•°</th>
                                            <th>ç›®æ ‡</th>
                                            <th>è¿›åº¦</th>
                                            ${canView?'<th>æ“ä½œ</th>':''}
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                filtered.forEach(p => {
                    const percent = Math.min(100, Math.round((p.weekWords / p.target) * 100));
                    html += `<tr>
                        <td>${p.group}</td>
                        <td>${p.outlineDone ? 'âœ…' : 'â³'}</td>
                        <td>${p.weekWords}</td>
                        <td>${p.target}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: ${percent}%;">${percent}%</div>
                            </div>
                        </td>
                        ${canView ? `<td><button class="btn btn-sm btn-outline-secondary edit-progress" data-group="${p.group}">ç¼–è¾‘</button></td>` : ''}
                    </tr>`;
                });
                html += '</tbody></table></div></div></div>';
                container.innerHTML = html;
            }

            async function renderRoyalty(container) {
                const r = await getData('royalties', []);
                const w = await getData('withdrawals', []);
                const now = new Date();
                const month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const monthly = w.filter(w=>w.status==='å·²é€šè¿‡' && w.time.startsWith(month)).reduce((s,w)=>s+w.amount,0);
                const userR = r.filter(rr => isManagerOrAbove() ? true : rr.user === currentUser.nickname);
                container.innerHTML = `
                    <div class="row"><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ’° ç¨¿è´¹è®°å½•</span><span>${isAdminOrBoss()?'<button class="btn btn-sm btn-info me-2" id="monthlyStatsBtn">ğŸ“Š æœˆåº¦ç»Ÿè®¡</button>':''}${isManagerOrAbove()?'<button class="btn btn-sm btn-primary" id="newRoyaltyBtn">+ å‘æ”¾</button>':''}</span></div>
                    <div class="card-body"><ul class="list-group">${userR.map(rr=>`<li class="list-group-item d-flex justify-content-between"><span><strong>${rr.user}</strong> Â· ${rr.group}  Â¥${rr.amount}</span><span class="badge ${rr.status==='å·²å‘'?'bg-success':rr.status==='å¾…ç¡®è®¤'?'bg-warning':'bg-secondary'}">${rr.status}</span><span>${isManagerOrAbove()?`<button class="btn btn-sm btn-outline-success edit-status" data-id="${rr.id}">æ”¹</button><button class="btn btn-sm btn-outline-danger delete-royalty" data-id="${rr.id}">åˆ </button>`:''}</span></li>`).join('')}</ul></div></div></div>
                    <div class="col-md-6"><div class="card"><div class="card-header">ğŸ’³ æç°ç”³è¯·</div><div class="card-body"><p>æœˆåº¦æµæ°´ï¼šÂ¥${monthly} (${month})</p><button class="btn btn-sm btn-success" id="newWithdrawBtn">ç”³è¯·æç°</button><hr><h6>å†å²è®°å½•</h6><ul class="list-group" style="max-height:200px; overflow:auto">${w.filter(w=>w.user===currentUser.nickname||isManagerOrAbove()).map(w=>`<li class="list-group-item d-flex justify-content-between"><span>${w.user} Â¥${w.amount} (${w.method})</span><span class="badge ${w.status==='å·²é€šè¿‡'?'bg-success':w.status==='å·²æ‹’ç»'?'bg-danger':'bg-warning'}">${w.status}</span>${canApproveWithdrawals()&&w.status==='å¾…å¤„ç†'?`<span><button class="btn btn-sm btn-success approve-withdraw" data-id="${w.id}">é€šè¿‡</button><button class="btn btn-sm btn-danger reject-withdraw" data-id="${w.id}">æ‹’ç»</button></span>`:''}</li>`).join('')}</ul></div></div></div></div>
                `;
            }

            async function renderMembers(container) {
                const users = await getData('users', []);
                const groups = await getData('groups', []);
                const canManage = isManagerOrAbove();
                const isBossUser = isBoss();
                let tabs = '<ul class="nav nav-tabs">' + groups.map((g,i)=>`<li class="nav-item"><button class="nav-link ${i===0?'active':''}" data-bs-toggle="tab" data-bs-target="#group${i}">${g}</button></li>`).join('') + '</ul><div class="tab-content mt-3">';
                groups.forEach((g,i) => {
                    const members = users.filter(u=>u.group===g);
                    tabs += `<div class="tab-pane fade ${i===0?'show active':''}" id="group${i}"><table class="table table-sm"><thead><tr><th>å§“å</th><th>è´¦å·</th><th>ä¸»ç»„</th><th>å…¼ä»»</th><th>è§’è‰²</th>${canManage?'<th>æ“ä½œ</th>':''}</tr></thead><tbody>`;
                    members.forEach(u => {
                        const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                        const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                        tabs += `<tr><td>${u.nickname}</td><td>${u.account}</td><td><span class="badge bg-primary">${u.group}</span></td><td>${u.extraGroups?.join(', ')||''}</td><td><span class="badge ${roleClass[u.role]}">${roleMap[u.role]}</span></td>`;
                        if (canManage && u.account !== currentUser.account) {
                            tabs += `<td>`;
                            if (canManageAllGroups() || (currentUser.role==='manager' && u.group===currentUser.group)) {
                                tabs += `<button class="btn btn-outline-secondary btn-permission change-group" data-account="${u.account}">æ¢ç»„</button><button class="btn btn-outline-info btn-permission add-group" data-account="${u.account}">åŠ ç»„</button>`;
                            }
                            if (isBossUser) {
                                if (u.role === 'member') {
                                    tabs += `<button class="btn btn-outline-warning btn-permission set-manager" data-account="${u.account}">è®¾ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                } else if (u.role === 'manager') {
                                    tabs += `<button class="btn btn-outline-primary btn-permission set-admin" data-account="${u.account}">è®¾ä¸ºé«˜çº§ç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                } else if (u.role === 'admin') {
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-manager" data-account="${u.account}">é™ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-secondary btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                }
                                tabs += `<button class="btn btn-outline-danger btn-permission delete-member" data-account="${u.account}">åˆ é™¤æˆå‘˜</button>`;
                            }
                            tabs += `</td>`;
                        } else if (canManage && u.account === currentUser.account) {
                            tabs += '<td><span class="text-muted">è‡ªå·±</span></td>';
                        } else {
                            tabs += '<td></td>';
                        }
                        tabs += `</tr>`;
                    });
                    tabs += members.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æˆå‘˜</td></tr>';
                    tabs += '</tbody></table></div>';
                });
                tabs += '</div>';
                if (canManage) tabs += `<div class="mt-2"><button class="btn btn-sm btn-success" id="addMemberBtn">+ æ–°å¢æˆå‘˜</button></div>`;
                container.innerHTML = `<div class="card"><div class="card-header"><i class="bi bi-people"></i> äººå‘˜åå• Â· å…±${groups.length}ç»„</div><div class="card-body">${tabs}<p class="small text-muted mt-2">åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜</p></div></div>`;
                document.getElementById('addMemberBtn')?.addEventListener('click', async function() {
                    const account = prompt('è´¦å·(çº¯è‹±æ–‡)'); if (!account || !/^[A-Za-z]+$/.test(account)) return alert('è´¦å·éœ€çº¯è‹±æ–‡');
                    const pwd = prompt('å¯†ç (å­—æ¯+æ•°å­—)'); if (!pwd || !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return alert('å¯†ç éœ€å­—æ¯æ•°å­—');
                    const nickname = prompt('ç¬”å'); if (!nickname) return;
                    let group = prompt('ä¸»ç»„åˆ«', currentUser.group); if (!group || !groups.includes(group)) return alert('æ— æ•ˆç»„åˆ«');
                    const users = await getData('users', []);
                    if (users.some(u=>u.account===account)) return alert('è´¦å·å·²å­˜åœ¨');
                    users.push({ account, password: pwd, nickname, realName: '', role: 'member', group, extraGroups: [] });
                    await setData('users', users);
                    refreshCurrentSection();
                });
            }

            async function renderNotices(container) {
                const channel = getDiscussUrl('notice');
                const comments = await fetchComments(channel);
                const notices = comments.map(c => {
                    try { return JSON.parse(c.content); } catch { return null; }
                }).filter(n => n !== null);
                notices.sort((a, b) => {
                    if (a.top && !b.top) return -1;
                    if (!a.top && b.top) return 1;
                    return new Date(b.time) - new Date(a.time);
                });
                const canPub = canPublishNotice();
                let html = `<div class="card"><div class="card-header d-flex justify-content-between"><span><i class="bi bi-megaphone"></i> é€šçŸ¥å…¬å‘Š</span><span class="badge bg-warning">å‘å¸ƒ:é«˜çº§ç®¡ç†å‘˜åŠè€æ¿</span></div><div class="card-body">`;
                if (notices.length === 0) {
                    html += '<div class="text-muted">æš‚æ— å…¬å‘Š</div>';
                } else {
                    notices.forEach(n => {
                        const topClass = n.top ? 'notice-item top' : 'notice-item';
                        html += `<div class="${topClass}">
                            <div><strong>ğŸ“¢ ${n.title}</strong> <small class="text-muted">(${n.publisher} ${n.time})</small></div>
                            <div class="mt-2">${n.content}</div>
                        </div>`;
                    });
                }
                if (canPub) html += '<button class="btn btn-sm btn-danger mt-2" id="publishNoticeBtn">å‘å¸ƒæ–°é€šçŸ¥</button>';
                html += '</div></div>';
                container.innerHTML = html;
            }

            async function renderSettings(container) {
                if (!isBoss()) { container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>'; return; }
                const groups = await getData('groups', []);
                const progress = await getData('progress', []);
                const currentTarget = progress.length > 0 ? progress[0].target : 28000;
                container.innerHTML = `
                    <div class="card"><div class="card-header">âš™ï¸ è®¾ç½®ç®¡ç† Â· ä»…è€æ¿</div><div class="card-body">
                    <div class="row"><div class="col-md-4"><h6>æ¯å‘¨ç›®æ ‡å­—æ•°</h6><input id="globalTarget" class="form-control" value="${currentTarget}"></div>
                    <div class="col-md-4"><h6>å®‰å…¨é€‰é¡¹</h6><div class="form-check"><input class="form-check-input" type="checkbox" checked disabled> æœ¬åœ°æ•°æ®å­˜å‚¨</div></div>
                    <div class="col-md-4"><h6>ç»„åˆ«ç®¡ç†</h6><p>å½“å‰ç»„åˆ«ï¼š${groups.join('ã€')}</p><button class="btn btn-outline-primary btn-sm" id="addGroupBtn">æ–°å¢ç»„åˆ«</button> <button class="btn btn-outline-secondary btn-sm" id="backupBtn">å¤‡ä»½æ•°æ®(æœ¬åœ°)</button></div></div>
                    <button class="btn btn-primary mt-2" id="saveGlobalTarget">ä¿å­˜ç›®æ ‡</button></div></div>
                `;
            }

            // åˆå§‹åŒ–æ³¨å†Œä¸‹æ‹‰æ¡†
            async function fillRegGroup() {
                const select = document.getElementById('regGroup');
                const groups = await getData('groups', []);
                const normalGroups = groups.filter(g => !ADMIN_GROUPS.includes(g));
                select.innerHTML = normalGroups.map(g => `<option>${g}</option>`).join('');
            }
            fillRegGroup();

            window.addEventListener('load', () => {
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('loginAccount').value = 'laoban';
                document.getElementById('loginPassword').value = '080415zqx';
            });
        })();
    </script>
</body>
</html>