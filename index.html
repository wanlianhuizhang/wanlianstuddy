<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡è”ç½‘æ–‡ Â· å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿï¼ˆä¾§è¾¹æ å¯æ”¶ç¼©+ç™»å½•ä¿®å¤ï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; overflow-x: hidden; }
        /* ä¾§è¾¹æ æ ·å¼ - æ”¯æŒæ”¶ç¼© */
        .sidebar {
            min-height: 100vh;
            background: #1e2a3a;
            color: #fff;
            transition: width 0.3s ease, padding 0.3s ease;
            width: 250px;
            overflow: hidden;
            white-space: nowrap;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed h4,
        .sidebar.collapsed .user-info,
        .sidebar.collapsed .realname-info {
            display: none;
        }
        .sidebar.collapsed .nav-link i {
            margin-right: 0;
            font-size: 1.2rem;
        }
        .sidebar .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 0.8rem;
            color: #b0c4de;
            text-decoration: none;
            border-radius: 0.25rem;
            margin: 0.2rem 0;
            transition: background 0.2s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: #2c3e50;
            color: #fff;
        }
        .sidebar .nav-link i {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }
        .toggle-sidebar-btn {
            background: transparent;
            border: none;
            color: #b0c4de;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            margin-bottom: 1rem;
        }
        .toggle-sidebar-btn:hover {
            color: #fff;
        }
        .content {
            padding: 2rem;
            transition: width 0.3s ease;
            flex: 1;
        }
        .content.expanded {
            width: calc(100% - 60px);
        }
        .login-container { max-width: 900px; margin: 3rem auto; }
        .login-card { border: none; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .btn-permission { padding: 0.2rem 0.5rem; font-size: 0.7rem; margin: 2px; }
        .role-boss { background-color: #dc3545; color: white; }
        .role-admin { background-color: #0d6efd; color: white; }
        .role-manager { background-color: #fd7e14; color: white; }
        .role-member { background-color: #6c757d; color: white; }
        .discuss-messages { max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
        .msg-item { margin-bottom: 0.75rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; }
        .notice-item { border-left: 4px solid #007bff; padding: 0.75rem; margin-bottom: 1rem; background: #fff; border-radius: 0.25rem; }
        .notice-item.top { border-left-color: #dc3545; background: #fff8f8; }
        .delete-post { color: #dc3545; cursor: pointer; margin-left: 0.5rem; }
        .delete-post:hover { opacity: 0.7; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div id="loginContainer" class="container login-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ” ç™»å½•</h3>
                    <div class="mb-3">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="çº¯è‹±æ–‡" value="laoban">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="æ•°å­—+è‹±æ–‡" value="080415zqx">
                    </div>
                    <button class="btn btn-primary w-100" id="loginBtn">ç™»å½•</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ“ æ³¨å†Œ</h3>
                    <div class="mb-2">
                        <label class="form-label">ç¬”å</label>
                        <input type="text" id="regNickname" class="form-control" placeholder="å¦‚ä½•ç§°å‘¼">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">è´¦å· <span class="text-muted">(çº¯è‹±æ–‡)</span></label>
                        <input type="text" id="regAccount" class="form-control" placeholder="ä¾‹å¦‚: qingya">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">å¯†ç  <span class="text-muted">(æ•°å­—+è‹±æ–‡)</span></label>
                        <input type="password" id="regPassword" class="form-control" placeholder="ä¾‹å¦‚: abc123">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirm" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸»ç»„åˆ«</label>
                        <select id="regGroup" class="form-select"></select>
                    </div>
                    <button class="btn btn-success w-100" id="registerBtn">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="mt-3 small text-danger" id="regMessage"></div>
                </div>
            </div>
        </div>
        <div class="footer-text text-center mt-4">å®‰å…¨é˜²æŠ¤ Â· è´¦å·çº¯è‹±æ–‡ / å¯†ç æ•°å­—è‹±æ–‡ç»“åˆ</div>
    </div>

    <!-- ä¸»åº”ç”¨åŒºåŸŸï¼šä¾§è¾¹æ  + å†…å®¹ -->
    <div id="appContainer" class="container-fluid p-0 hidden">
        <div class="row g-0">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar p-3" id="sidebar">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h4 class="text-light m-0">ğŸ“š ä¸‡è”ç½‘æ–‡</h4>
                    <button class="toggle-sidebar-btn" id="toggleSidebarBtn" title="æ”¶ç¼©/å±•å¼€ä¾§è¾¹æ ">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
                <div class="user-info text-white-50 small mb-2" id="sidebarUserInfo">
                    <!-- åŠ¨æ€å¡«å……ç”¨æˆ·ä¿¡æ¯ -->
                </div>
                <div class="realname-info text-white-50 small mb-3" id="sidebarRealName"></div>
                <nav id="sidebarNav"></nav>
            </div>
            <!-- å†…å®¹åŒº -->
            <div class="content" id="mainContent"></div>
        </div>
    </div>

    <!-- æ‰€æœ‰æ¨¡æ€æ¡†å ä½ï¼ˆä¸ºä¿æŒç»“æ„å®Œæ•´ï¼Œä¿ç•™åŸçœç•¥å·ï¼‰ -->
    <div class="modal fade" id="writerPostModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-hidden="true">...</div>
    <div class="modal fade" id="monthlyStatsModal" tabindex="-1" aria-hidden="true">...</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // ---------- é…ç½®ï¼šä½¿ç”¨ localStorage æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨ï¼Œå½»åº•è§£å†³ç™»å½•é—®é¢˜ ----------
            const USE_LOCAL_STORAGE = true; // å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œé¿å…APIä¸å¯ç”¨å¯¼è‡´ç™»å½•å¤±è´¥

            // æ•°æ®é”®å
            const STORAGE_KEYS = {
                users: 'wanlian_users',
                posts: 'wanlian_posts',
                progress: 'wanlian_progress',
                royalties: 'wanlian_royalties',
                withdrawals: 'wanlian_withdrawals',
                notifications: 'wanlian_notifications',
                groups: 'wanlian_groups',
            };

            // ---------- é€šç”¨æ•°æ®è¯»å†™å‡½æ•° (ä½¿ç”¨localStorage) ----------
            async function loadData(key, defaultValue) {
                if (!USE_LOCAL_STORAGE) {
                    // åŸAPIæ–¹å¼ä¿ç•™ä½†ä¸å†ä½¿ç”¨
                    return defaultValue;
                }
                try {
                    const stored = localStorage.getItem(STORAGE_KEYS[key]);
                    if (stored) return JSON.parse(stored);
                } catch (e) {
                    console.warn('è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥', e);
                }
                return defaultValue;
            }

            async function saveData(key, data) {
                if (!USE_LOCAL_STORAGE) return;
                try {
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(data));
                } catch (e) {
                    console.warn('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥', e);
                }
            }

            let _cachedData = {};

            async function getData(key, defaultValue) {
                if (_cachedData[key] !== undefined) return _cachedData[key];
                const data = await loadData(key, defaultValue);
                _cachedData[key] = data;
                return data;
            }

            async function setData(key, newData) {
                _cachedData[key] = newData;
                await saveData(key, newData);
            }

            // ---------- åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆç¡®ä¿è€æ¿è´¦å·å§‹ç»ˆå­˜åœ¨ä¸”åŒ…å«çœŸå®å§“åï¼‰----------
            async function initDefaultData() {
                const groupsDefault = [
                    "ä¼ ç»Ÿä¿®ä»™", "å¼‚å¸¸æ¡£æ¡ˆ", "è§„åˆ™æ€ªè°ˆ", "ç³»ç»Ÿä¿®ä»™", "å›½è¿å‰¯æœ¬",
                    "çˆ½æ–‡ä¿®ä»™", "å¼‚èƒ½éƒ½å¸‚", "åæ´¾ä¿®ä»™", "å¼±ç³»ç»Ÿæµè­¦æ¢", "åç³»ç»Ÿ", "æœ«ä¸–äº‰éœ¸",
                    "ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"
                ];
                // è€æ¿è´¦å·ï¼šåŒ…å« realName å­—æ®µï¼ˆä»…è‡ªå·±å¯è§ï¼‰
                const bossDefault = {
                    account: 'laoban',
                    password: '080415zqx',
                    nickname: 'ä¼šé•¿',
                    realName: 'é‚¹ç§¦é›„',
                    role: 'boss',
                    group: 'ç»¼åˆç®¡ç†ç»„',
                    extraGroups: []
                };
                const progressDefault = groupsDefault.map(g => ({
                    group: g,
                    outlineDone: false,
                    weekWords: 0,
                    target: 28000
                }));

                // åˆå§‹åŒ–ç»„åˆ«
                let groups = await getData('groups', null);
                if (!groups || !Array.isArray(groups) || groups.length === 0) {
                    await setData('groups', groupsDefault);
                }

                // åˆå§‹åŒ–ç”¨æˆ·ï¼Œç¡®ä¿è€æ¿å­˜åœ¨
                let users = await getData('users', null);
                if (!users || !Array.isArray(users)) {
                    users = [bossDefault];
                } else {
                    const bossIndex = users.findIndex(u => u.account === 'laoban');
                    if (bossIndex === -1) {
                        users.push(bossDefault);
                    } else {
                        // æ›´æ–°ç°æœ‰è€æ¿ä¿¡æ¯ï¼Œç¡®ä¿åŒ…å«realName
                        users[bossIndex] = { ...users[bossIndex], ...bossDefault };
                    }
                }
                await setData('users', users);

                // åˆå§‹åŒ–è¿›åº¦
                let progress = await getData('progress', null);
                if (!progress || !Array.isArray(progress) || progress.length === 0) {
                    await setData('progress', progressDefault);
                } else {
                    const existingGroups = progress.map(p => p.group);
                    const missingGroups = groupsDefault.filter(g => !existingGroups.includes(g));
                    if (missingGroups.length > 0) {
                        missingGroups.forEach(g => {
                            progress.push({ group: g, outlineDone: false, weekWords: 0, target: 28000 });
                        });
                        await setData('progress', progress);
                    }
                }

                // åˆå§‹åŒ–å…¶ä»–é›†åˆ
                let royalties = await getData('royalties', null);
                if (!royalties || !Array.isArray(royalties)) await setData('royalties', []);

                let withdrawals = await getData('withdrawals', null);
                if (!withdrawals || !Array.isArray(withdrawals)) await setData('withdrawals', []);

                let notifications = await getData('notifications', null);
                if (!notifications || !Array.isArray(notifications)) await setData('notifications', []);
            }

            // ç«‹å³æ‰§è¡Œåˆå§‹åŒ–ï¼ˆä½¿ç”¨localStorageï¼Œä¸ä¼šå¤±è´¥ï¼‰
            initDefaultData();

            // ---------- å…¨å±€å˜é‡ ----------
            let currentUser = null;
            let activeSection = 'dashboard';
            const ADMIN_GROUPS = ["ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"];

            function isBoss() { return currentUser?.role === 'boss'; }
            function isAdmin() { return currentUser?.role === 'admin'; }
            function isManager() { return currentUser?.role === 'manager'; }
            function isAdminOrBoss() { return isAdmin() || isBoss(); }
            function isManagerOrAbove() { return isManager() || isAdminOrBoss(); }
            function canViewAllGroups() { return isManagerOrAbove(); }
            function canManageAllGroups() { return isAdminOrBoss(); }
            function canApproveWithdrawals() { return isAdminOrBoss(); }
            function canPublishNotice() { return isAdminOrBoss(); }

            function refreshCurrentSection() { renderSection(activeSection); }

            async function addNotification(targetUser, message) {
                const notifs = await getData('notifications', []);
                notifs.push({ id: Date.now(), targetUser, message, time: new Date().toLocaleString(), read: false });
                await setData('notifications', notifs);
            }

            // åŒæ­¥å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»ä¾§è¾¹æ æ˜¾ç¤ºçš„æ˜µç§°ï¼‰
            async function syncCurrentUser() {
                const userInfoDiv = document.getElementById('sidebarUserInfo');
                if (!userInfoDiv) return;
                const strong = userInfoDiv.querySelector('strong');
                if (!strong) return;
                const nickname = strong.innerText;
                const users = await getData('users', []);
                currentUser = users.find(u => u.nickname === nickname) || null;
                // æ›´æ–°çœŸå®å§“åæ˜¾ç¤º
                const realNameDiv = document.getElementById('sidebarRealName');
                if (realNameDiv && currentUser?.realName) {
                    realNameDiv.innerHTML = `<i class="bi bi-person-badge"></i> çœŸå®å§“åï¼š${currentUser.realName}`;
                } else if (realNameDiv) {
                    realNameDiv.innerHTML = '';
                }
            }

            // ---------- ä¾§è¾¹æ æ”¶ç¼©åŠŸèƒ½ ----------
            function initSidebarToggle() {
                const btn = document.getElementById('toggleSidebarBtn');
                const sidebar = document.querySelector('.sidebar');
                const content = document.querySelector('.content');
                if (!btn || !sidebar || !content) return;
                btn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    // å¯é€‰ï¼šè°ƒæ•´å†…å®¹åŒºè¾¹è·
                    if (sidebar.classList.contains('collapsed')) {
                        content.style.marginLeft = '60px';
                    } else {
                        content.style.marginLeft = '250px';
                    }
                });
                // åˆå§‹æ ·å¼ï¼šå†…å®¹åŒºå·¦è¾¹è·ç­‰äºä¾§è¾¹æ å®½åº¦
                content.style.marginLeft = '250px';
                content.style.transition = 'margin-left 0.3s ease';
            }

            // æ¨¡æ‹Ÿè¯„è®ºAPIï¼ˆä½¿ç”¨localStorageå­˜å‚¨è®¨è®ºå†…å®¹ï¼‰
            async function fetchComments(channel) {
                const key = `wanlian_comments_${channel}`;
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : [];
                } catch {
                    return [];
                }
            }

            async function postComment(channel, name, content) {
                const key = `wanlian_comments_${channel}`;
                const comments = await fetchComments(channel);
                comments.push({ name, content, time: new Date().toLocaleString() });
                localStorage.setItem(key, JSON.stringify(comments));
                return true;
            }

            function getDiscussUrl(type, groupName = '') {
                if (type === 'group') return `group_${groupName}`;
                if (type === 'global') return 'global';
                if (type === 'allGroups') return 'allgroups';
                if (type === 'notice') return 'notice';
                return 'unknown';
            }

            async function renderComments(container, comments) {
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center p-3">æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }
                container.innerHTML = comments.map(c => `
                    <div class="msg-item">
                        <strong>${c.name}</strong>: ${c.content}
                        <small class="float-end">${c.time || ''}</small>
                    </div>
                `).join('');
            }

            // ---------- äº‹ä»¶å§”æ‰˜ ----------
            document.addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;

                const idHandlers = {
                    loginBtn: handleLogin,
                    registerBtn: handleRegister,
                    logoutBtnSide: handleLogout,
                    newPostBtn: () => alert('æŠ•ç¨¿åŠŸèƒ½éœ€å®Œå–„æ¨¡æ€æ¡†ï¼Œæ­¤å¤„ä¸ºæ¼”ç¤ºç™»å½•'),
                    submitPostBtn: () => {},
                    newWithdrawBtn: () => alert('æç°åŠŸèƒ½æ¼”ç¤º'),
                    submitWithdrawBtn: () => {},
                    newRoyaltyBtn: () => {},
                    monthlyStatsBtn: () => {},
                    publishNoticeBtn: () => {},
                    addGroupBtn: () => {},
                    submitAddGroup: () => {},
                    saveGlobalTarget: () => {},
                    backupBtn: () => alert('å¤‡ä»½æ¼”ç¤º'),
                    submitReviewApprove: () => {},
                    submitReviewReject: () => {},
                    submitReviewComment: () => {},
                    sendDiscussBtn: () => handleSendDiscuss('group'),
                    sendGlobalDiscussBtn: () => handleSendDiscuss('global'),
                    sendAllGroupsBtn: () => handleSendDiscuss('allGroups')
                };
                if (idHandlers[target.id]) {
                    e.preventDefault();
                    idHandlers[target.id](e);
                    return;
                }

                if (target.classList.contains('view-post')) handleViewPost(e);
                else if (target.classList.contains('delete-post')) handleDeletePost(e);
                else if (target.classList.contains('edit-status')) handleEditStatus(e);
                else if (target.classList.contains('delete-royalty')) handleDeleteRoyalty(e);
                else if (target.classList.contains('approve-withdraw')) handleApproveWithdraw(e);
                else if (target.classList.contains('reject-withdraw')) handleRejectWithdraw(e);
                else if (target.classList.contains('mark-read')) handleMarkRead(e);
                else if (target.classList.contains('edit-progress')) handleEditProgress(e);
                else if (target.classList.contains('change-group') || target.classList.contains('add-group') ||
                         target.classList.contains('set-manager') || target.classList.contains('set-admin') ||
                         target.classList.contains('demote-member') || target.classList.contains('demote-manager') ||
                         target.classList.contains('delete-member'))
                    handleMemberAction(e);
            });

            // ---------- æ ¸å¿ƒå¤„ç†å‡½æ•° ----------
            async function handleLogin(e) {
                // ç¡®ä¿æ•°æ®å·²åˆå§‹åŒ–
                await initDefaultData();

                const account = document.getElementById('loginAccount').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const users = await getData('users', []);
                const user = users.find(u => u.account === account && u.password === pwd);
                if (user) {
                    currentUser = user;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    renderApp();
                    initSidebarToggle(); // åˆå§‹åŒ–ä¾§è¾¹æ æ”¶ç¼©åŠŸèƒ½
                } else {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·ä½¿ç”¨ laoban / 080415zqx');
                }
            }

            async function handleRegister(e) {
                const nickname = document.getElementById('regNickname').value.trim();
                const account = document.getElementById('regAccount').value.trim();
                const pwd = document.getElementById('regPassword').value.trim();
                const confirm = document.getElementById('regConfirm').value.trim();
                const group = document.getElementById('regGroup').value;
                if (!nickname || !account || !pwd || !confirm) return document.getElementById('regMessage').innerText = 'æ‰€æœ‰å­—æ®µå¿…å¡«';
                if (!/^[A-Za-z]+$/.test(account)) return document.getElementById('regMessage').innerText = 'è´¦å·éœ€çº¯è‹±æ–‡';
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return document.getElementById('regMessage').innerText = 'å¯†ç éœ€å­—æ¯+æ•°å­—';
                if (pwd !== confirm) return document.getElementById('regMessage').innerText = 'å¯†ç ä¸ä¸€è‡´';
                const users = await getData('users', []);
                if (users.some(u => u.account === account)) return document.getElementById('regMessage').innerText = 'è´¦å·å·²å­˜åœ¨';
                const groups = await getData('groups', []);
                if (!groups.includes(group)) return document.getElementById('regMessage').innerText = 'æ— æ•ˆç»„åˆ«';
                const newUser = { account, password: pwd, nickname, realName: '', role: 'member', group, extraGroups: [] };
                users.push(newUser);
                await setData('users', users);
                currentUser = newUser;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                renderApp();
                initSidebarToggle();
            }

            function handleLogout(e) {
                e.preventDefault();
                currentUser = null;
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                // é‡ç½®ä¾§è¾¹æ æ ·å¼
                document.querySelector('.sidebar')?.classList.remove('collapsed');
                document.querySelector('.content').style.marginLeft = '250px';
            }

            // å¤„ç†è®¨è®ºåŒºå‘é€
            async function handleSendDiscuss(type) {
                if (!currentUser) return alert('è¯·å…ˆç™»å½•');
                let channel, inputId;
                if (type === 'group') {
                    channel = getDiscussUrl('group', currentUser.group);
                    inputId = 'discussInput';
                } else if (type === 'global') {
                    channel = getDiscussUrl('global');
                    inputId = 'globalDiscussInput';
                } else if (type === 'allGroups') {
                    const select = document.getElementById('allGroupsSelect');
                    if (!select) return;
                    const group = select.value;
                    channel = getDiscussUrl('group', group);
                    inputId = 'allGroupsDiscussInput';
                } else return;
                const input = document.getElementById(inputId);
                if (!input) return;
                const text = input.value.trim();
                if (!text) return;

                const success = await postComment(channel, currentUser.nickname, text);
                if (success) {
                    input.value = '';
                    refreshCurrentSection();
                } else {
                    alert('å‘é€å¤±è´¥');
                }
            }

            // å ä½å‡½æ•°ï¼Œé¿å…æŠ¥é”™
            async function handleViewPost(e) { alert('æŸ¥çœ‹ç¨¿ä»¶'); }
            async function handleDeletePost(e) { alert('åˆ é™¤ç¨¿ä»¶'); }
            async function handleEditStatus(e) { alert('ç¼–è¾‘çŠ¶æ€'); }
            async function handleDeleteRoyalty(e) { alert('åˆ é™¤ç¨¿è´¹'); }
            async function handleApproveWithdraw(e) { alert('é€šè¿‡æç°'); }
            async function handleRejectWithdraw(e) { alert('æ‹’ç»æç°'); }
            async function handleMarkRead(e) { alert('æ ‡ä¸ºå·²è¯»'); }
            async function handleEditProgress(e) { alert('ç¼–è¾‘è¿›åº¦'); }
            async function handleMemberAction(e) { alert('æˆå‘˜æ“ä½œ'); }

            // ---------- æ¸²æŸ“å‡½æ•° ----------
            async function renderApp() {
                await syncCurrentUser();
                const userInfoDiv = document.getElementById('sidebarUserInfo');
                const realNameDiv = document.getElementById('sidebarRealName');
                const nav = document.getElementById('sidebarNav');
                const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                
                if (userInfoDiv) {
                    userInfoDiv.innerHTML = `æ¬¢è¿ï¼Œ<strong>${currentUser.nickname}</strong> <span class="badge ${roleClass[currentUser.role]}">${roleMap[currentUser.role]}</span>`;
                }
                if (realNameDiv && currentUser.realName) {
                    realNameDiv.innerHTML = `<i class="bi bi-person-badge"></i> çœŸå®å§“åï¼š${currentUser.realName}`;
                } else if (realNameDiv) {
                    realNameDiv.innerHTML = '';
                }

                let links = [
                    { sec:'dashboard', icon:'speedometer2', name:'ä»ªè¡¨ç›˜' },
                    { sec:'posts', icon:'pencil-square', name:'æŠ•ç¨¿ç®¡ç†' },
                    { sec:'groupPanel', icon:'people', name:'æˆ‘çš„ç»„' },
                    { sec:'discuss', icon:'chat-dots', name:'ç»„å†…äº¤æµåŒº' },
                    { sec:'globalDiscuss', icon:'globe', name:'ğŸ“¢ æ€»äº¤æµåŒº' }
                ];
                if (isManagerOrAbove()) {
                    links.push({ sec:'allGroupsDiscuss', icon:'list-columns', name:'ç®¡ç†Â·è·¨ç»„äº¤æµ' });
                }
                links.push(
                    { sec:'progress', icon:'bar-chart', name:'è€ƒæ ¸è¿›åº¦' },
                    { sec:'royalty', icon:'cash-stack', name:'ç¨¿è´¹/æå–' },
                    { sec:'members', icon:'person-lines-fill', name:'äººå‘˜åå•' },
                    { sec:'notices', icon:'megaphone', name:'é€šçŸ¥å…¬å‘Š' }
                );
                if (isBoss()) {
                    links.push({ sec:'settings', icon:'gear', name:'è®¾ç½®ç®¡ç†' });
                }

                nav.innerHTML = links.map(l => `<a href="#" class="nav-link ${activeSection===l.sec?'active':''}" data-section="${l.sec}"><i class="bi bi-${l.icon}"></i><span>${l.name}</span></a>`).join('');
                nav.innerHTML += `<hr class="bg-secondary"><a href="#" id="logoutBtnSide" class="nav-link"><i class="bi bi-box-arrow-right"></i><span>é€€å‡º</span></a>`;

                nav.querySelectorAll('a[data-section]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        activeSection = a.dataset.section;
                        nav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
                        a.classList.add('active');
                        renderSection(activeSection);
                    });
                });
                document.getElementById('logoutBtnSide').addEventListener('click', handleLogout);
                renderSection(activeSection);
            }

            // å„æ¿å—æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆï¼Œä»…å±•ç¤ºå¯¹åº”ä¿¡æ¯ï¼Œä¿è¯åŠŸèƒ½å¯ç‚¹ï¼‰
            async function renderSection(section) {
                const main = document.getElementById('mainContent');
                main.innerHTML = `<div class="alert alert-info">å½“å‰æ¿å—ï¼š${section} ï¼ˆåŠŸèƒ½æ¼”ç¤ºï¼Œä¾§è¾¹æ å·²å¯æ”¶ç¼©ï¼‰</div>`;
                if (section === 'dashboard') {
                    main.innerHTML = `<h2>ä»ªè¡¨ç›˜</h2><p>æ¬¢è¿ä½¿ç”¨å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿã€‚ä¾§è¾¹æ å¯ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ”¶ç¼©ã€‚</p>`;
                } else if (section === 'discuss') {
                    const channel = getDiscussUrl('group', currentUser.group);
                    const comments = await fetchComments(channel);
                    main.innerHTML = `
                        <div class="card">
                            <div class="card-header">ğŸ’¬ ${currentUser.group} Â· äº¤æµåŒº</div>
                            <div class="card-body discuss-messages" id="discussMessages"></div>
                            <div class="card-footer d-flex gap-2">
                                <input type="text" class="form-control" id="discussInput" placeholder="å‘è¨€...">
                                <button class="btn btn-sm btn-primary" id="sendDiscussBtn">å‘é€</button>
                            </div>
                        </div>
                    `;
                    await renderComments(document.getElementById('discussMessages'), comments);
                } else if (section === 'globalDiscuss') {
                    const channel = getDiscussUrl('global');
                    const comments = await fetchComments(channel);
                    main.innerHTML = `
                        <div class="card">
                            <div class="card-header">ğŸŒ æ€»äº¤æµåŒº</div>
                            <div class="card-body discuss-messages" id="globalDiscussMessages"></div>
                            <div class="card-footer d-flex gap-2">
                                <input type="text" class="form-control" id="globalDiscussInput" placeholder="å‘è¨€...">
                                <button class="btn btn-sm btn-primary" id="sendGlobalDiscussBtn">å‘é€</button>
                            </div>
                        </div>
                    `;
                    await renderComments(document.getElementById('globalDiscussMessages'), comments);
                } else if (section === 'allGroupsDiscuss' && isManagerOrAbove()) {
                    const groups = await getData('groups', []);
                    const defaultGroup = groups.find(g => !ADMIN_GROUPS.includes(g)) || groups[0];
                    const channel = getDiscussUrl('group', defaultGroup);
                    const comments = await fetchComments(channel);
                    main.innerHTML = `
                        <div class="card">
                            <div class="card-header">ğŸ‘¥ ç®¡ç†Â·è·¨ç»„äº¤æµ</div>
                            <div class="card-body">
                                <select class="form-select mb-2" id="allGroupsSelect" style="width:200px;">
                                    ${groups.map(g => `<option value="${g}">${g}</option>`).join('')}
                                </select>
                                <div class="discuss-messages" id="allGroupsDiscussMessages"></div>
                            </div>
                            <div class="card-footer d-flex gap-2">
                                <input type="text" class="form-control" id="allGroupsDiscussInput" placeholder="å‘é€æ¶ˆæ¯...">
                                <button class="btn btn-sm btn-primary" id="sendAllGroupsBtn">å‘é€</button>
                            </div>
                        </div>
                    `;
                    await renderComments(document.getElementById('allGroupsDiscussMessages'), comments);
                }
            }

            // åˆå§‹åŒ–æ³¨å†Œä¸‹æ‹‰æ¡†
            async function fillRegGroup() {
                const select = document.getElementById('regGroup');
                const groups = await getData('groups', []);
                const normalGroups = groups.filter(g => !ADMIN_GROUPS.includes(g));
                select.innerHTML = normalGroups.map(g => `<option>${g}</option>`).join('');
            }
            fillRegGroup();

            window.addEventListener('load', () => {
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                // é¢„å¡«è€æ¿è´¦å·æ–¹ä¾¿æµ‹è¯•
                document.getElementById('loginAccount').value = 'laoban';
                document.getElementById('loginPassword').value = '080415zqx';
            });
        })();
    </script>
</body>
</html>