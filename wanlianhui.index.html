<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡è”ç½‘æ–‡ Â· å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #1e2a3a; color: #fff; }
        .sidebar a { color: #b0c4de; text-decoration: none; padding: 0.5rem 1rem; display: block; border-radius: 0.25rem; margin: 0.2rem 0; }
        .sidebar a:hover, .sidebar a.active { background: #2c3e50; color: #fff; }
        .content { padding: 2rem; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.05); border: none; margin-bottom: 1.5rem; }
        .login-container { max-width: 900px; margin: 3rem auto; }
        .login-card { border: none; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .btn-permission { padding: 0.2rem 0.5rem; font-size: 0.7rem; margin: 2px; }
        .role-boss { background-color: #dc3545; color: white; }
        .role-admin { background-color: #0d6efd; color: white; }
        .role-manager { background-color: #fd7e14; color: white; }
        .role-member { background-color: #6c757d; color: white; }
        .discuss-messages { max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
        .msg-item { margin-bottom: 0.75rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; }
        .notice-item { border-left: 4px solid #007bff; padding: 0.75rem; margin-bottom: 1rem; background: #fff; border-radius: 0.25rem; }
        .notice-item.top { border-left-color: #dc3545; background: #fff8f8; }
        .delete-post { color: #dc3545; cursor: pointer; margin-left: 0.5rem; }
        .delete-post:hover { opacity: 0.7; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div id="loginContainer" class="container login-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ” ç™»å½•</h3>
                    <div class="mb-3">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="çº¯è‹±æ–‡">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="æ•°å­—+è‹±æ–‡">
                    </div>
                    <button class="btn btn-primary w-100" id="loginBtn">ç™»å½•</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ“ æ³¨å†Œ</h3>
                    <div class="mb-2">
                        <label class="form-label">ç¬”å</label>
                        <input type="text" id="regNickname" class="form-control" placeholder="å¦‚ä½•ç§°å‘¼">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">è´¦å· <span class="text-muted">(çº¯è‹±æ–‡)</span></label>
                        <input type="text" id="regAccount" class="form-control" placeholder="ä¾‹å¦‚: qingya">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">å¯†ç  <span class="text-muted">(æ•°å­—+è‹±æ–‡)</span></label>
                        <input type="password" id="regPassword" class="form-control" placeholder="ä¾‹å¦‚: abc123">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirm" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸»ç»„åˆ«</label>
                        <select id="regGroup" class="form-select"></select>
                    </div>
                    <button class="btn btn-success w-100" id="registerBtn">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="mt-3 small text-danger" id="regMessage"></div>
                </div>
            </div>
        </div>
        <div class="footer-text text-center mt-4">å®‰å…¨é˜²æŠ¤ Â· è´¦å·çº¯è‹±æ–‡ / å¯†ç æ•°å­—è‹±æ–‡ç»“åˆ</div>
    </div>

    <!-- ä¸»åº”ç”¨åŒºåŸŸ -->
    <div id="appContainer" class="container-fluid p-0 hidden">
        <div class="row g-0">
            <div class="col-md-2 sidebar p-3" id="sidebar"></div>
            <div class="col-md-10 content" id="mainContent"></div>
        </div>
    </div>

    <!-- æŠ•ç¨¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="writerPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“ å‘å¸ƒæ–°ä½œå“</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="postForm">
                        <div class="mb-3"><label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label><input type="text" class="form-control" id="postTitle"></div>
                        <div class="mb-3"><label class="form-label">ç®€ä»‹</label><textarea class="form-control" id="postDescription" rows="2"></textarea></div>
                        <div class="mb-3"><label class="form-label">æ­£æ–‡ <span class="text-danger">*</span></label><textarea class="form-control" id="postContent" rows="8"></textarea><div class="form-text mt-1">å­—æ•°ç»Ÿè®¡ï¼š<span id="wordCount">0</span> å­—</div></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">æ‰€å±ç»„åˆ«</label><select class="form-select" id="postGroup"></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">æ ‡ç­¾</label><input type="text" class="form-control" id="postTags" placeholder="ä»™ä¾ , çˆ½æ–‡"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="submitPostBtn">å‘å¸ƒæŠ•ç¨¿</button></div>
            </div>
        </div>
    </div>

    <!-- æç°æ¨¡æ€æ¡† -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ’° ç”³è¯·æç°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3"><label class="form-label">é‡‘é¢</label><input type="number" class="form-control" id="withdrawAmount" min="1" step="0.01" required></div>
                        <div class="mb-3"><label class="form-label">æ–¹å¼</label><select class="form-select" id="withdrawMethod"><option value="å¾®ä¿¡">å¾®ä¿¡</option><option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option><option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option></select></div>
                        <div class="mb-3"><label class="form-label">è´¦å·</label><input type="text" class="form-control" id="withdrawAccount" required></div>
                        <div class="mb-3"><label class="form-label">å¤‡æ³¨</label><input type="text" class="form-control" id="withdrawNote"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-success" id="submitWithdrawBtn">æäº¤</button></div>
            </div>
        </div>
    </div>

    <!-- å®¡é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“„ å®¡é˜…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div id="modalPostInfo"></div><hr>
                    <h6>ğŸ“ å†…å®¹</h6><div id="modalContent" class="border p-3 bg-light" style="max-height:200px; overflow:auto;"></div><hr>
                    <h6>ğŸ’¬ æ‰¹å¤</h6><div id="modalReviews" class="mb-3"></div>
                    <div id="reviewInputArea" class="mt-2">
                        <textarea id="reviewComment" class="form-control" rows="2" placeholder="æ‰¹å¤..."></textarea>
                        <div class="mt-2"><button class="btn btn-sm btn-success" id="submitReviewApprove">é€šè¿‡</button><button class="btn btn-sm btn-warning" id="submitReviewReject">é€€å›</button><button class="btn btn-sm btn-secondary" id="submitReviewComment">è¯„è®º</button></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ç»„åˆ«æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">â• æ–°å¢ç»„åˆ«</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" class="form-control" id="newGroupName" placeholder="ç»„åˆ«åç§°"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="submitAddGroup">æ·»åŠ </button></div></div></div>
    </div>

    <!-- æœˆåº¦ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="monthlyStatsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“Š æœˆåº¦ç¨¿è´¹ç»Ÿè®¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">é€‰æ‹©æœˆä»½</label><input type="month" class="form-control" id="statsMonth"></div>
                    <div id="monthlyStatsContent"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // ---------- API é…ç½® ----------
            const COMMENT_API = "https://api.jsdelivr.net/comment";
            const BASE_URL = window.location.origin + window.location.pathname;

            const DATA_URLS = {
                users: BASE_URL + '#data/users',
                posts: BASE_URL + '#data/posts',
                progress: BASE_URL + '#data/progress',
                royalties: BASE_URL + '#data/royalties',
                withdrawals: BASE_URL + '#data/withdrawals',
                notifications: BASE_URL + '#data/notifications',
                groups: BASE_URL + '#data/groups',
            };

            // ---------- é€šç”¨æ•°æ®è¯»å†™å‡½æ•° ----------
            async function loadData(url, defaultValue) {
                try {
                    const res = await fetch(`${COMMENT_API}?url=${encodeURIComponent(url)}`);
                    const comments = await res.json();
                    if (comments && comments.length > 0) {
                        const latest = comments.sort((a, b) => new Date(b.time) - new Date(a.time))[0];
                        return JSON.parse(latest.content);
                    }
                } catch (e) {
                    console.error(`åŠ è½½æ•°æ®å¤±è´¥ ${url}`, e);
                }
                return defaultValue;
            }

            async function saveData(url, data) {
                try {
                    await fetch(COMMENT_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            url: url,
                            name: 'system',
                            content: JSON.stringify(data),
                        }),
                    });
                } catch (e) {
                    console.error(`ä¿å­˜æ•°æ®å¤±è´¥ ${url}`, e);
                    throw e;
                }
            }

            let _cachedData = {};

            async function getData(key, defaultValue) {
                if (_cachedData[key] !== undefined) return _cachedData[key];
                const data = await loadData(DATA_URLS[key], defaultValue);
                _cachedData[key] = data;
                return data;
            }

            async function setData(key, newData) {
                _cachedData[key] = newData;
                await saveData(DATA_URLS[key], newData);
            }

            // ---------- åˆå§‹åŒ–é»˜è®¤æ•°æ® ----------
            async function initDefaultData() {
                const groupsDefault = [
                    "ä¼ ç»Ÿä¿®ä»™", "å¼‚å¸¸æ¡£æ¡ˆ", "è§„åˆ™æ€ªè°ˆ", "ç³»ç»Ÿä¿®ä»™", "å›½è¿å‰¯æœ¬",
                    "çˆ½æ–‡ä¿®ä»™", "å¼‚èƒ½éƒ½å¸‚", "åæ´¾ä¿®ä»™", "å¼±ç³»ç»Ÿæµè­¦æ¢", "åç³»ç»Ÿ", "æœ«ä¸–äº‰éœ¸",
                    "ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"
                ];
                const usersDefault = [{
                    account: 'laoban',
                    password: '080415zqx',
                    nickname: 'ä¼šé•¿',
                    role: 'boss',
                    group: 'ç»¼åˆç®¡ç†ç»„',
                    extraGroups: []
                }];
                const progressDefault = groupsDefault.map(g => ({
                    group: g,
                    outlineDone: false,
                    weekWords: 0,
                    target: 28000
                }));

                let groups = await getData('groups', null);
                if (!groups) await setData('groups', groupsDefault);

                let users = await getData('users', null);
                if (!users) await setData('users', usersDefault);

                let progress = await getData('progress', null);
                if (!progress) await setData('progress', progressDefault);

                let royalties = await getData('royalties', null);
                if (!royalties) await setData('royalties', []);

                let withdrawals = await getData('withdrawals', null);
                if (!withdrawals) await setData('withdrawals', []);

                let notifications = await getData('notifications', null);
                if (!notifications) await setData('notifications', []);
            }

            initDefaultData();

            // ---------- å…¨å±€å˜é‡ ----------
            let currentUser = null;
            let activeSection = 'dashboard';
            const ADMIN_GROUPS = ["ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"];

            function isBoss() { return currentUser?.role === 'boss'; }
            function isAdmin() { return currentUser?.role === 'admin'; }
            function isManager() { return currentUser?.role === 'manager'; }
            function isAdminOrBoss() { return isAdmin() || isBoss(); }
            function isManagerOrAbove() { return isManager() || isAdminOrBoss(); }
            function canViewAllGroups() { return isManagerOrAbove(); }
            function canManageAllGroups() { return isAdminOrBoss(); }
            function canApproveWithdrawals() { return isAdminOrBoss(); }
            function canPublishNotice() { return isAdminOrBoss(); }

            function refreshCurrentSection() { renderSection(activeSection); }

            async function addNotification(targetUser, message) {
                const notifs = await getData('notifications', []);
                notifs.push({ id: Date.now(), targetUser, message, time: new Date().toLocaleString(), read: false });
                await setData('notifications', notifs);
            }

            async function syncCurrentUser() {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar) return;
                const strong = sidebar.querySelector('.text-white-50 strong');
                if (!strong) return;
                const nickname = strong.innerText;
                const users = await getData('users', []);
                currentUser = users.find(u => u.nickname === nickname) || null;
            }

            // ---------- è¯„è®º API è¾…åŠ© ----------
            async function fetchComments(url) {
                try {
                    const res = await fetch(`${COMMENT_API}?url=${encodeURIComponent(url)}`);
                    return await res.json();
                } catch (e) {
                    console.error('åŠ è½½è¯„è®ºå¤±è´¥', e);
                    return [];
                }
            }

            async function postComment(url, name, content) {
                try {
                    await fetch(COMMENT_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ url, name, content })
                    });
                    return true;
                } catch (e) {
                    console.error('å‘è¡¨è¯„è®ºå¤±è´¥', e);
                    return false;
                }
            }

            function getDiscussUrl(type, groupName = '') {
                if (type === 'group') return BASE_URL + '#discuss/group/' + encodeURIComponent(groupName);
                if (type === 'global') return BASE_URL + '#discuss/global';
                if (type === 'allGroups') return BASE_URL + '#discuss/allgroups';
                if (type === 'notice') return BASE_URL + '#notice';
                return BASE_URL;
            }

            async function renderComments(container, comments) {
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center p-3">æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }
                container.innerHTML = comments.map(c => `
                    <div class="msg-item">
                        <strong>${c.name}</strong>: ${c.content}
                        <small class="float-end">${c.time || ''}</small>
                    </div>
                `).join('');
            }

            // ---------- äº‹ä»¶å§”æ‰˜ ----------
            document.addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;

                const idHandlers = {
                    loginBtn: handleLogin,
                    registerBtn: handleRegister,
                    logoutBtnSide: handleLogout,
                    newPostBtn: handleNewPost,
                    submitPostBtn: handleSubmitPost,
                    newWithdrawBtn: () => new bootstrap.Modal(document.getElementById('withdrawModal')).show(),
                    submitWithdrawBtn: handleWithdrawSubmit,
                    newRoyaltyBtn: handleNewRoyalty,
                    monthlyStatsBtn: showMonthlyStats,
                    publishNoticeBtn: handlePublishNotice,
                    addGroupBtn: () => new bootstrap.Modal(document.getElementById('addGroupModal')).show(),
                    submitAddGroup: handleAddGroup,
                    saveGlobalTarget: handleSaveTarget,
                    backupBtn: handleBackup,
                    submitReviewApprove: () => handleReview('approve'),
                    submitReviewReject: () => handleReview('reject'),
                    submitReviewComment: () => handleReview('comment'),
                    sendDiscussBtn: () => handleSendDiscuss('group'),
                    sendGlobalDiscussBtn: () => handleSendDiscuss('global'),
                    sendAllGroupsBtn: () => handleSendDiscuss('allGroups')
                };
                if (idHandlers[target.id]) {
                    e.preventDefault();
                    idHandlers[target.id](e);
                    return;
                }

                if (target.classList.contains('view-post')) handleViewPost(e);
                else if (target.classList.contains('delete-post')) handleDeletePost(e);
                else if (target.classList.contains('edit-status')) handleEditStatus(e);
                else if (target.classList.contains('delete-royalty')) handleDeleteRoyalty(e);
                else if (target.classList.contains('approve-withdraw')) handleApproveWithdraw(e);
                else if (target.classList.contains('reject-withdraw')) handleRejectWithdraw(e);
                else if (target.classList.contains('mark-read')) handleMarkRead(e);
                else if (target.classList.contains('edit-progress')) handleEditProgress(e);
                else if (target.classList.contains('change-group') || target.classList.contains('add-group') ||
                         target.classList.contains('set-manager') || target.classList.contains('set-admin') ||
                         target.classList.contains('demote-member') || target.classList.contains('demote-manager') ||
                         target.classList.contains('delete-member'))
                    handleMemberAction(e);
            });

            let wordCountTimer;
            document.getElementById('postContent')?.addEventListener('input', function() {
                clearTimeout(wordCountTimer);
                wordCountTimer = setTimeout(() => {
                    const text = this.value;
                    const chinese = text.replace(/[^\u4e00-\u9fa5]/g, '').length;
                    document.getElementById('wordCount').innerText = chinese;
                }, 200);
            });

            document.getElementById('statsMonth')?.addEventListener('change', updateMonthlyStats);

            // ---------- ç¨¿ä»¶åˆ é™¤åŠŸèƒ½ ----------
            async function handleDeletePost(e) {
                const id = e.target.closest('.delete-post').dataset.id;
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¨¿ä»¶å—ï¼Ÿ')) return;
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == id);
                if (!post) return;
                // æƒé™æ£€æŸ¥ï¼šä½œè€…æœ¬äºº æˆ– ç®¡ç†å‘˜/è€æ¿
                if (post.author !== currentUser.nickname && !isManagerOrAbove()) {
                    alert('æ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤ç¨¿ä»¶');
                    return;
                }
                const newPosts = posts.filter(p => p.id != id);
                await setData('posts', newPosts);
                // æ›´æ–°è¿›åº¦ï¼šå‡å»è¯¥ç¨¿ä»¶çš„å­—æ•°
                const progress = await getData('progress', []);
                const prog = progress.find(p => p.group === post.group);
                if (prog) {
                    prog.weekWords = Math.max(0, prog.weekWords - post.words);
                    await setData('progress', progress);
                }
                refreshCurrentSection();
            }

            // ---------- æ ¸å¿ƒå¤„ç†å‡½æ•° ----------
            async function handleLogin(e) {
                const account = document.getElementById('loginAccount').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const users = await getData('users', []);
                const user = users.find(u => u.account === account && u.password === pwd);
                if (user) {
                    currentUser = user;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    renderApp();
                } else alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
            }

            async function handleRegister(e) {
                const nickname = document.getElementById('regNickname').value.trim();
                const account = document.getElementById('regAccount').value.trim();
                const pwd = document.getElementById('regPassword').value.trim();
                const confirm = document.getElementById('regConfirm').value.trim();
                const group = document.getElementById('regGroup').value;
                if (!nickname || !account || !pwd || !confirm) return document.getElementById('regMessage').innerText = 'æ‰€æœ‰å­—æ®µå¿…å¡«';
                if (!/^[A-Za-z]+$/.test(account)) return document.getElementById('regMessage').innerText = 'è´¦å·éœ€çº¯è‹±æ–‡';
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return document.getElementById('regMessage').innerText = 'å¯†ç éœ€å­—æ¯+æ•°å­—';
                if (pwd !== confirm) return document.getElementById('regMessage').innerText = 'å¯†ç ä¸ä¸€è‡´';
                const users = await getData('users', []);
                if (users.some(u => u.account === account)) return document.getElementById('regMessage').innerText = 'è´¦å·å·²å­˜åœ¨';
                const groups = await getData('groups', []);
                if (!groups.includes(group)) return document.getElementById('regMessage').innerText = 'æ— æ•ˆç»„åˆ«';
                const newUser = { account, password: pwd, nickname, role: 'member', group, extraGroups: [] };
                users.push(newUser);
                await setData('users', users);
                currentUser = newUser;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                renderApp();
            }

            function handleLogout(e) {
                e.preventDefault();
                currentUser = null;
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            }

            async function handleNewPost(e) {
                e.preventDefault();
                const groups = await getData('groups', []);
                const available = isAdminOrBoss() ? groups : [currentUser.group];
                const select = document.getElementById('postGroup');
                select.innerHTML = '';
                available.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g; opt.textContent = g;
                    if (g === currentUser.group) opt.selected = true;
                    select.appendChild(opt);
                });
                document.getElementById('postTitle').value = '';
                document.getElementById('postDescription').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('postTags').value = '';
                document.getElementById('wordCount').innerText = '0';
                new bootstrap.Modal(document.getElementById('writerPostModal')).show();
            }

            async function handleSubmitPost(e) {
                const title = document.getElementById('postTitle').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const group = document.getElementById('postGroup').value;
                if (!title || !content) return alert('æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º');
                const words = content.replace(/[^\u4e00-\u9fa5]/g, '').length;
                if (words === 0) return alert('è‡³å°‘åŒ…å«ä¸­æ–‡å­—ç¬¦');
                const posts = await getData('posts', []);
                const newPost = {
                    id: Date.now(), group, title, author: currentUser.nickname,
                    time: new Date().toISOString().slice(0,10), words, content,
                    description: document.getElementById('postDescription').value.trim(),
                    tags: document.getElementById('postTags').value.split(',').map(s=>s.trim()).filter(Boolean),
                    reviews: []
                };
                posts.push(newPost);
                await setData('posts', posts);
                const progress = await getData('progress', []);
                const prog = progress.find(p => p.group === group);
                if (prog) {
                    prog.weekWords += words;
                    await setData('progress', progress);
                }
                bootstrap.Modal.getInstance(document.getElementById('writerPostModal')).hide();
                refreshCurrentSection();
            }

            async function handleViewPost(e) {
                const id = e.target.closest('.view-post').dataset.id;
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == id);
                if (!post) return;
                document.getElementById('modalPostInfo').innerHTML = `<h6>${post.title} by ${post.author} (${post.group}) å­—æ•°:${post.words}</h6>`;
                document.getElementById('modalContent').innerText = post.content || 'ï¼ˆæ— æ–‡æ¡ˆï¼‰';
                const reviewsDiv = document.getElementById('modalReviews');
                reviewsDiv.innerHTML = post.reviews?.length ? post.reviews.map(r => `<div class="border p-2 mb-2"><span class="badge ${r.action==='é€šè¿‡'?'bg-success':r.action==='é€€å›'?'bg-danger':'bg-secondary'}">${r.action}</span> <strong>${r.reviewer}</strong>: ${r.comment} <small>${r.time}</small></div>`).join('') : '<p class="text-muted">æš‚æ— æ‰¹å¤</p>';
                document.getElementById('reviewInputArea').style.display = isManagerOrAbove() ? 'block' : 'none';
                document.getElementById('reviewModal').dataset.postId = id;
                new bootstrap.Modal(document.getElementById('reviewModal')).show();
            }

            async function handleReview(action) {
                const modal = document.getElementById('reviewModal');
                const postId = modal.dataset.postId;
                const comment = document.getElementById('reviewComment').value.trim();
                if (!comment && action !== 'comment') return alert('è¯·å¡«å†™æ‰¹å¤');
                const posts = await getData('posts', []);
                const post = posts.find(p => p.id == postId);
                if (!post) return;
                if (!post.reviews) post.reviews = [];
                const actionName = action === 'approve' ? 'é€šè¿‡' : action === 'reject' ? 'é€€å›' : 'è¯„è®º';
                post.reviews.push({ reviewer: currentUser.nickname, action: actionName, comment: comment || 'ï¼ˆæ— ï¼‰', time: new Date().toLocaleString() });
                await setData('posts', posts);
                if (action === 'reject') addNotification(post.author, `ç¨¿ä»¶ã€Š${post.title}ã€‹è¢«é€€å›ã€‚æ‰¹å¤ï¼š${comment||'æ— '}`);
                bootstrap.Modal.getInstance(modal).hide();
                refreshCurrentSection();
            }

            async function handleWithdrawSubmit(e) {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const method = document.getElementById('withdrawMethod').value;
                const account = document.getElementById('withdrawAccount').value.trim();
                if (!amount || amount <= 0 || !account) return alert('è¯·å¡«å†™å®Œæ•´');
                const withdrawals = await getData('withdrawals', []);
                withdrawals.push({ id: Date.now(), user: currentUser.nickname, amount, method, account, note: document.getElementById('withdrawNote').value.trim(), time: new Date().toLocaleString(), status: 'å¾…å¤„ç†' });
                await setData('withdrawals', withdrawals);
                const users = await getData('users', []);
                users.filter(u => u.role === 'boss' || u.role === 'admin').forEach(admin => addNotification(admin.nickname, `ç”¨æˆ· ${currentUser.nickname} æäº¤äº† Â¥${amount} æç°ç”³è¯·`));
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                refreshCurrentSection();
            }

            async function handleNewRoyalty(e) {
                const user = prompt('æˆå‘˜ç¬”å', currentUser.nickname); if (!user) return;
                const amount = parseFloat(prompt('é‡‘é¢')); if (amount <= 0) return;
                const group = prompt('ç»„åˆ«', currentUser.group) || currentUser.group;
                const royalties = await getData('royalties', []);
                royalties.push({ id: Date.now(), user, group, amount, status: 'å¾…ç¡®è®¤', time: new Date().toISOString().slice(0,10) });
                await setData('royalties', royalties);
                refreshCurrentSection();
            }

            async function showMonthlyStats() {
                const modal = new bootstrap.Modal(document.getElementById('monthlyStatsModal'));
                const month = document.getElementById('statsMonth');
                const now = new Date();
                month.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                await updateMonthlyStats();
                modal.show();
            }

            async function updateMonthlyStats() {
                const month = document.getElementById('statsMonth').value;
                if (!month) return;
                const royalties = await getData('royalties', []);
                const stats = {};
                royalties.forEach(r => {
                    if (r.time?.startsWith(month)) {
                        if (!stats[r.user]) stats[r.user] = { å·²å‘:0,å¾…ç¡®è®¤:0,æå–ä¸­:0,æ€»è®¡:0 };
                        stats[r.user][r.status] = (stats[r.user][r.status]||0) + r.amount;
                        stats[r.user].æ€»è®¡ += r.amount;
                    }
                });
                const remaining = royalties.filter(r => r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0);
                let html = `<p>æœˆä»½ï¼š${month} å‰©ä½™å¾…å‘ï¼šÂ¥${remaining}</p><table class="table table-sm"><thead><tr><th>æˆå‘˜</th><th>å·²å‘</th><th>å¾…ç¡®è®¤</th><th>æå–ä¸­</th><th>æ€»è®¡</th></tr></thead><tbody>`;
                if (Object.keys(stats).length) {
                    Object.keys(stats).sort().forEach(u => html += `<tr><td>${u}</td><td>Â¥${stats[u].å·²å‘}</td><td>Â¥${stats[u].å¾…ç¡®è®¤}</td><td>Â¥${stats[u].æå–ä¸­}</td><td>Â¥${stats[u].æ€»è®¡}</td></tr>`);
                } else html += '<tr><td colspan="5" class="text-center">æ— è®°å½•</td></tr>';
                html += '</tbody></table>';
                document.getElementById('monthlyStatsContent').innerHTML = html;
            }

            async function handlePublishNotice(e) {
                if (!canPublishNotice()) return alert('æƒé™ä¸è¶³');
                const title = prompt('æ ‡é¢˜'); if (!title) return;
                const content = prompt('æ­£æ–‡', '');
                const top = confirm('ç½®é¡¶ï¼Ÿ');
                const noticeObj = { title, content: content || '', publisher: currentUser.nickname, time: new Date().toLocaleString(), top };
                const url = getDiscussUrl('notice');
                const success = await postComment(url, currentUser.nickname, JSON.stringify(noticeObj));
                if (success) {
                    alert('å‘å¸ƒæˆåŠŸ');
                    refreshCurrentSection();
                } else {
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }

            async function handleMarkRead(e) {
                const id = e.target.closest('.mark-read').dataset.id;
                const notifs = await getData('notifications', []);
                const idx = notifs.findIndex(n => n.id == id);
                if (idx !== -1) notifs[idx].read = true;
                await setData('notifications', notifs);
                refreshCurrentSection();
            }

            async function handleMemberAction(e) {
                const btn = e.target.closest('button');
                const account = btn.dataset.account;
                if (!account) return;
                const users = await getData('users', []);
                const user = users.find(u => u.account === account);
                if (!user) return;
                const groups = await getData('groups', []);

                if (btn.classList.contains('change-group')) {
                    const newGroup = prompt('æ–°ä¸»ç»„', user.group);
                    if (!newGroup) return;
                    if (ADMIN_GROUPS.includes(newGroup) && !isBoss()) return alert('åªæœ‰è€æ¿å¯è°ƒå…¥ç®¡ç†ç»„');
                    if (groups.includes(newGroup)) { user.group = newGroup; await setData('users', users); refreshCurrentSection(); }
                } else if (btn.classList.contains('add-group')) {
                    const extra = prompt('å…¼ä»»ç»„', '');
                    if (!extra) return;
                    if (ADMIN_GROUPS.includes(extra) && !isBoss()) return alert('åªæœ‰è€æ¿å¯æ·»åŠ ç®¡ç†ç»„');
                    if (groups.includes(extra) && extra !== user.group && !user.extraGroups.includes(extra)) {
                        user.extraGroups.push(extra); await setData('users', users); refreshCurrentSection();
                    }
                } else if (btn.classList.contains('set-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®ç®¡ç†å‘˜');
                    user.role = 'manager'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('set-admin')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®é«˜çº§ç®¡ç†å‘˜');
                    user.role = 'admin'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-member')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'member'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'manager'; await setData('users', users); refreshCurrentSection(); 
                } else if (btn.classList.contains('delete-member')) {
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜');
                    if (user.account === currentUser.account) return alert('ä¸èƒ½åˆ é™¤è‡ªå·±');
                    if (!confirm(`ç¡®å®šåˆ é™¤æˆå‘˜ ${user.nickname}ï¼ˆè´¦å·ï¼š${user.account}ï¼‰å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æˆå‘˜çš„æ‰€æœ‰æŠ•ç¨¿ã€ç¨¿è´¹è®°å½•ã€æç°ç”³è¯·å’Œäº¤æµæ¶ˆæ¯ã€‚`)) return;
                    
                    const nickname = user.nickname;
                    const posts = (await getData('posts', [])).filter(p => p.author !== nickname);
                    await setData('posts', posts);
                    const royalties = (await getData('royalties', [])).filter(r => r.user !== nickname);
                    await setData('royalties', royalties);
                    const withdrawals = (await getData('withdrawals', [])).filter(w => w.user !== nickname);
                    await setData('withdrawals', withdrawals);
                    const newUsers = users.filter(u => u.account !== account);
                    await setData('users', newUsers);
                    refreshCurrentSection();
                }
            }

            async function handleEditProgress(e) {
                const btn = e.target.closest('.edit-progress');
                const group = btn.dataset.group;
                let progress = await getData('progress', []);
                const item = progress.find(p => p.group === group);
                if (!item) return;
                const newWords = prompt('ä¿®æ”¹æœ¬å‘¨å­—æ•°', item.weekWords);
                if (newWords && !isNaN(newWords)) item.weekWords = parseInt(newWords);
                const outline = confirm('å¤§çº²å·²å®Œæˆï¼Ÿ');
                item.outlineDone = outline;
                await setData('progress', progress);
                refreshCurrentSection();
            }

            async function handleEditStatus(e) {
                const id = e.target.closest('.edit-status').dataset.id;
                let royalties = await getData('royalties', []);
                const r = royalties.find(r => r.id == id);
                if (!r) return;
                const ns = prompt('æ–°çŠ¶æ€ï¼šå·²å‘/å¾…ç¡®è®¤/æå–ä¸­', r.status);
                if (ns && ['å·²å‘','å¾…ç¡®è®¤','æå–ä¸­'].includes(ns)) { r.status = ns; await setData('royalties', royalties); refreshCurrentSection(); }
            }

            async function handleDeleteRoyalty(e) {
                const id = e.target.closest('.delete-royalty').dataset.id;
                if (!confirm('åˆ é™¤ï¼Ÿ')) return;
                const royalties = (await getData('royalties', [])).filter(r => r.id != id);
                await setData('royalties', royalties);
                refreshCurrentSection();
            }

            async function handleApproveWithdraw(e) {
                const id = e.target.closest('.approve-withdraw').dataset.id;
                let withdrawals = await getData('withdrawals', []);
                const w = withdrawals.find(w => w.id == id);
                if (w) { w.status = 'å·²é€šè¿‡'; await setData('withdrawals', withdrawals); addNotification(w.user, `æç° Â¥${w.amount} å·²é€šè¿‡`); refreshCurrentSection(); }
            }

            async function handleRejectWithdraw(e) {
                const id = e.target.closest('.reject-withdraw').dataset.id;
                let withdrawals = await getData('withdrawals', []);
                const w = withdrawals.find(w => w.id == id);
                if (w) { w.status = 'å·²æ‹’ç»'; await setData('withdrawals', withdrawals); addNotification(w.user, `æç° Â¥${w.amount} è¢«æ‹’ç»`); refreshCurrentSection(); }
            }

            async function handleAddGroup(e) {
                const newGroup = document.getElementById('newGroupName').value.trim();
                if (!newGroup) return;
                const groups = await getData('groups', []);
                if (groups.includes(newGroup)) return alert('å·²å­˜åœ¨');
                groups.push(newGroup);
                await setData('groups', groups);
                let progress = await getData('progress', []);
                if (!progress.some(p => p.group === newGroup)) {
                    progress.push({ group: newGroup, outlineDone: false, weekWords: 0, target: 28000 });
                    await setData('progress', progress);
                }
                bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
                document.getElementById('newGroupName').value = '';
                refreshCurrentSection();
            }

            async function handleSaveTarget(e) {
                const newTarget = parseInt(document.getElementById('globalTarget').value, 10);
                if (newTarget > 0) {
                    let progress = await getData('progress', []);
                    progress.forEach(p => p.target = newTarget);
                    await setData('progress', progress);
                    alert('ç›®æ ‡å·²æ›´æ–°');
                    refreshCurrentSection();
                }
            }

            function handleBackup(e) {
                alert('äº‘ç«¯æ•°æ®æ— éœ€å¤‡ä»½ï¼Œå¦‚éœ€æœ¬åœ°å¤‡ä»½è¯·æ‰‹åŠ¨å¤åˆ¶');
            }

            async function handleSendDiscuss(type) {
                if (!currentUser) return alert('è¯·å…ˆç™»å½•');
                let url, inputId;
                if (type === 'group') {
                    url = getDiscussUrl('group', currentUser.group);
                    inputId = 'discussInput';
                } else if (type === 'global') {
                    url = getDiscussUrl('global');
                    inputId = 'globalDiscussInput';
                } else if (type === 'allGroups') {
                    const select = document.getElementById('allGroupsSelect');
                    if (!select) return;
                    const group = select.value;
                    url = getDiscussUrl('group', group);
                    inputId = 'allGroupsDiscussInput';
                } else return;
                const input = document.getElementById(inputId);
                if (!input) return;
                const text = input.value.trim();
                if (!text) return;

                const success = await postComment(url, currentUser.nickname, text);
                if (success) {
                    input.value = '';
                    refreshCurrentSection();
                } else {
                    alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }

            // ---------- æ¸²æŸ“å‡½æ•° ----------
            async function renderApp() {
                await syncCurrentUser();
                const sidebar = document.getElementById('sidebar');
                const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                let links = [
                    { sec:'dashboard', icon:'speedometer2', name:'ä»ªè¡¨ç›˜' },
                    { sec:'posts', icon:'pencil-square', name:'æŠ•ç¨¿ç®¡ç†' },
                    { sec:'groupPanel', icon:'people', name:'æˆ‘çš„ç»„' },
                    { sec:'discuss', icon:'chat-dots', name:'ç»„å†…äº¤æµåŒº' },
                    { sec:'globalDiscuss', icon:'globe', name:'ğŸ“¢ æ€»äº¤æµåŒº' }
                ];
                if (isManagerOrAbove()) {
                    links.push({ sec:'allGroupsDiscuss', icon:'list-columns', name:'ç®¡ç†Â·è·¨ç»„äº¤æµ' });
                }
                links.push(
                    { sec:'progress', icon:'bar-chart', name:'è€ƒæ ¸è¿›åº¦' },
                    { sec:'royalty', icon:'cash-stack', name:'ç¨¿è´¹/æå–' },
                    { sec:'members', icon:'person-lines-fill', name:'äººå‘˜åå•' },
                    { sec:'notices', icon:'megaphone', name:'é€šçŸ¥å…¬å‘Š' }
                );
                if (isBoss()) {
                    links.push({ sec:'settings', icon:'gear', name:'è®¾ç½®ç®¡ç†' });
                }
                sidebar.innerHTML = `
                    <h4 class="text-center mb-4 text-light">ğŸ“š ä¸‡è”ç½‘æ–‡</h4>
                    <div class="mb-3 text-white-50 small">æ¬¢è¿ï¼Œ<strong>${currentUser.nickname}</strong> <span class="badge ${roleClass[currentUser.role]}">${roleMap[currentUser.role]}</span></div>
                    <nav>
                        ${links.map(l => `<a href="#" class="nav-link ${activeSection===l.sec?'active':''}" data-section="${l.sec}"><i class="bi bi-${l.icon}"></i> ${l.name}</a>`).join('')}
                        <hr class="bg-secondary"><a href="#" id="logoutBtnSide"><i class="bi bi-box-arrow-right"></i> é€€å‡º</a>
                    </nav>
                `;
                sidebar.querySelectorAll('nav a[data-section]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        activeSection = a.dataset.section;
                        sidebar.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
                        a.classList.add('active');
                        renderSection(activeSection);
                    });
                });
                renderSection(activeSection);
            }

            async function renderSection(section) {
                const main = document.getElementById('mainContent');
                const fns = {
                    dashboard: renderDashboard,
                    posts: renderPosts,
                    groupPanel: renderGroupPanel,
                    discuss: renderDiscuss,
                    globalDiscuss: renderGlobalDiscuss,
                    allGroupsDiscuss: renderAllGroupsDiscuss,
                    progress: renderProgress,
                    royalty: renderRoyalty,
                    members: renderMembers,
                    notices: renderNotices,
                    settings: renderSettings
                };
                if (fns[section]) await fns[section](main);
            }

            async function renderDashboard(container) {
                const posts = await getData('posts', []);
                const users = await getData('users', []);
                const r = await getData('royalties', []);
                const wd = await getData('withdrawals', []);
                const totalPosts = posts.length;
                const totalWords = posts.reduce((a,p)=>a+p.words,0);
                const pendingR = r.filter(r=>r.status!=='å·²å‘').length;
                const pendingW = wd.filter(w=>w.status==='å¾…å¤„ç†').length;
                const notifs = (await getData('notifications', [])).filter(n=>n.targetUser===currentUser.nickname && !n.read);
                container.innerHTML = `
                    <div class="alert alert-info">å®‰å…¨é˜²æŠ¤å·²å¯ç”¨ Â· å…¨å‘˜äº’åŠ¨ä¸­ Â· æ•°æ®äº‘ç«¯åŒæ­¥</div>
                    ${notifs.length ? `<div class="alert alert-warning">æ‚¨æœ‰ ${notifs.length} æ¡æœªè¯»é€šçŸ¥<div class="mt-2">${notifs.map(n=>`<div class="border-bottom pb-1">${n.message} <small>${n.time}</small> <button class="btn btn-sm btn-outline-primary mark-read float-end" data-id="${n.id}">æ ‡ä¸ºå·²è¯»</button></div>`).join('')}</div></div>` : ''}
                    <div class="row"><div class="col-12"><h2>ğŸ“‹ ä»ªè¡¨ç›˜</h2><p>ç¨¿è´¹å¾…å¤„ç†:${pendingR} æç°å¾…å®¡æ ¸:${pendingW}</p></div>${[
                        ['æ€»æŠ•ç¨¿',totalPosts,'primary'],['å®Œæˆå­—æ•°(ä¸‡)',(totalWords/10000).toFixed(1),'success'],
                        ['å¾…å‘ç¨¿è´¹','Â¥'+r.filter(r=>r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0),'warning'],
                        ['æˆå‘˜æ€»æ•°',users.length,'danger']
                    ].map(([t,v,c])=>`<div class="col-md-3"><div class="card text-white bg-${c}"><div class="card-body"><h5 class="card-title">${t}</h5><p class="display-6">${v}</p></div></div></div>`).join('')}</div>
                `;
            }

            async function renderPosts(container) {
                const posts = await getData('posts', []);
                const filtered = canViewAllGroups() ? posts : posts.filter(p => p.group===currentUser.group || currentUser.extraGroups?.includes(p.group));
                container.innerHTML = `
                    <div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ“ ${canViewAllGroups()?'å…¨éƒ¨æŠ•ç¨¿':'æœ¬ç»„æŠ•ç¨¿'}</span><span class="badge bg-secondary">${canViewAllGroups()?'æ‰€æœ‰ç»„':currentUser.group}</span></div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>ç»„åˆ«</th><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>æ—¶é—´</th><th>å­—æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>
                        ${filtered.map(p => {
                            const canDelete = (p.author === currentUser.nickname || isManagerOrAbove());
                            return `<tr><td>${p.group}</td><td>${p.title}</td><td>${p.author}</td><td>${p.time}</td><td>${p.words}</td><td>
                                <i class="bi bi-eye btn btn-sm btn-outline-secondary view-post" data-id="${p.id}"></i> å®¡é˜…
                                ${canDelete ? `<i class="bi bi-trash delete-post btn btn-sm btn-outline-danger" data-id="${p.id}"></i>` : ''}
                            </td></tr>`;
                        }).join('')}
                        ${filtered.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æŠ•ç¨¿</td></tr>'}
                    </tbody></table></div><button class="btn btn-sm btn-outline-primary" id="newPostBtn">+ æ–°æŠ•ç¨¿</button></div></div>
                `;
            }

            async function renderGroupPanel(container) {
                const posts = await getData('posts', []);
                const filtered = posts.filter(p => p.group === currentUser.group);
                container.innerHTML = `<div class="card"><div class="card-header">ğŸ§˜ ${currentUser.group} Â· æœ¬ç»„æŠ•ç¨¿</div><div class="card-body"><ul class="list-group">${filtered.map(p=>`<li class="list-group-item d-flex justify-content-between">${p.title} ä½œè€…: ${p.author} <span>${p.words}å­—</span></li>`).join('')||'<li class="list-group-item text-muted">æš‚æ— </li>'}</ul></div></div>`;
            }

            async function renderDiscuss(container) {
                const url = getDiscussUrl('group', currentUser.group);
                const comments = await fetchComments(url);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸ’¬ ${currentUser.group} Â· äº¤æµåŒº</div>
                        <div class="card-body discuss-messages" id="discussMessages"></div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="discussInput" placeholder="å‘è¨€...">
                            <button class="btn btn-sm btn-primary" id="sendDiscussBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('discussMessages');
                await renderComments(msgContainer, comments);
            }

            async function renderGlobalDiscuss(container) {
                const url = getDiscussUrl('global');
                const comments = await fetchComments(url);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸŒ æ€»äº¤æµåŒº Â· æ‰€æœ‰äººå¯è§</div>
                        <div class="card-body discuss-messages" id="globalDiscussMessages"></div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="globalDiscussInput" placeholder="å‘è¨€...">
                            <button class="btn btn-sm btn-primary" id="sendGlobalDiscussBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('globalDiscussMessages');
                await renderComments(msgContainer, comments);
            }

            async function renderAllGroupsDiscuss(container) {
                if (!isManagerOrAbove()) {
                    container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>';
                    return;
                }
                const groups = await getData('groups', []);
                const defaultGroup = groups.find(g => !ADMIN_GROUPS.includes(g)) || groups[0];
                const url = getDiscussUrl('group', defaultGroup);
                const comments = await fetchComments(url);

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">ğŸ‘¥ ç®¡ç†Â·è·¨ç»„äº¤æµåŒº (å¯å‘ä»»æ„ç»„å‘é€æ¶ˆæ¯)</div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select" id="allGroupsSelect" style="width: auto; max-width:200px;">
                                    ${groups.map(g => `<option value="${g}" ${g === defaultGroup ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                                <button class="btn btn-sm btn-outline-secondary" id="refreshAllGroupsBtn">åˆ·æ–°</button>
                            </div>
                            <div class="discuss-messages" id="allGroupsDiscussMessages"></div>
                        </div>
                        <div class="card-footer d-flex gap-2">
                            <input type="text" class="form-control" id="allGroupsDiscussInput" placeholder="å‘æ‰€é€‰ç»„å‘é€æ¶ˆæ¯...">
                            <button class="btn btn-sm btn-primary" id="sendAllGroupsBtn">å‘é€</button>
                        </div>
                    </div>
                `;
                const msgContainer = document.getElementById('allGroupsDiscussMessages');
                await renderComments(msgContainer, comments);

                document.getElementById('allGroupsSelect').addEventListener('change', async function(e) {
                    const newGroup = e.target.value;
                    const newUrl = getDiscussUrl('group', newGroup);
                    const newComments = await fetchComments(newUrl);
                    await renderComments(msgContainer, newComments);
                });
                document.getElementById('refreshAllGroupsBtn').addEventListener('click', async function() {
                    const select = document.getElementById('allGroupsSelect');
                    const group = select.value;
                    const newUrl = getDiscussUrl('group', group);
                    const newComments = await fetchComments(newUrl);
                    await renderComments(msgContainer, newComments);
                });
            }

            async function renderProgress(container) {
                let prog = await getData('progress', []);
                const canView = canViewAllGroups();
                let filtered = canView ? prog : prog.filter(p => p.group === currentUser.group);
                container.innerHTML = `
                    <div class="card"><div class="card-header">ğŸ“Š è€ƒæ ¸è¿›åº¦ ${canView?'<span class="badge bg-info">ç®¡ç†å‘˜å¯ç¼–è¾‘</span>':''}</div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead><tr><th>ç»„åˆ«</th><th>å¤§çº²</th><th>æœ¬å‘¨å­—æ•°</th><th>ç›®æ ‡</th><th>è¿›åº¦</th>${canView?'<th>æ“ä½œ</th>':''}</tr></thead><tbody>
                        ${filtered.map(p => {
                            const percent = Math.min(100, Math.round(p.weekWords/p.target*100));
                            return `<tr><td>${p.group}</td><td>${p.outlineDone?'âœ…':'â³'}</td><td>${p.weekWords}</td><td>${p.target}</td><td><div class="progress"><div class="progress-bar" style="width:${percent}%">${percent}%</div></div></td>${canView?`<td><button class="btn btn-sm btn-outline-secondary edit-progress" data-group="${p.group}">ç¼–è¾‘</button></td>`:''}</tr>`;
                        }).join('')}
                    </tbody></table></div></div></div>
                `;
            }

            async function renderRoyalty(container) {
                const r = await getData('royalties', []);
                const w = await getData('withdrawals', []);
                const now = new Date();
                const month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const monthly = w.filter(w=>w.status==='å·²é€šè¿‡' && w.time.startsWith(month)).reduce((s,w)=>s+w.amount,0);
                const userR = r.filter(rr => isManagerOrAbove() ? true : rr.user === currentUser.nickname);
                container.innerHTML = `
                    <div class="row"><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ’° ç¨¿è´¹è®°å½•</span><span>${isAdminOrBoss()?'<button class="btn btn-sm btn-info me-2" id="monthlyStatsBtn">ğŸ“Š æœˆåº¦ç»Ÿè®¡</button>':''}${isManagerOrAbove()?'<button class="btn btn-sm btn-primary" id="newRoyaltyBtn">+ å‘æ”¾</button>':''}</span></div>
                    <div class="card-body"><ul class="list-group">${userR.map(rr=>`<li class="list-group-item d-flex justify-content-between"><span><strong>${rr.user}</strong> Â· ${rr.group}  Â¥${rr.amount}</span><span class="badge ${rr.status==='å·²å‘'?'bg-success':rr.status==='å¾…ç¡®è®¤'?'bg-warning':'bg-secondary'}">${rr.status}</span><span>${isManagerOrAbove()?`<button class="btn btn-sm btn-outline-success edit-status" data-id="${rr.id}">æ”¹</button><button class="btn btn-sm btn-outline-danger delete-royalty" data-id="${rr.id}">åˆ </button>`:''}</span></li>`).join('')}</ul></div></div></div>
                    <div class="col-md-6"><div class="card"><div class="card-header">ğŸ’³ æç°ç”³è¯·</div><div class="card-body"><p>æœˆåº¦æµæ°´ï¼šÂ¥${monthly} (${month})</p><button class="btn btn-sm btn-success" id="newWithdrawBtn">ç”³è¯·æç°</button><hr><h6>å†å²è®°å½•</h6><ul class="list-group" style="max-height:200px; overflow:auto">${w.filter(w=>w.user===currentUser.nickname||isManagerOrAbove()).map(w=>`<li class="list-group-item d-flex justify-content-between"><span>${w.user} Â¥${w.amount} (${w.method})</span><span class="badge ${w.status==='å·²é€šè¿‡'?'bg-success':w.status==='å·²æ‹’ç»'?'bg-danger':'bg-warning'}">${w.status}</span>${canApproveWithdrawals()&&w.status==='å¾…å¤„ç†'?`<span><button class="btn btn-sm btn-success approve-withdraw" data-id="${w.id}">é€šè¿‡</button><button class="btn btn-sm btn-danger reject-withdraw" data-id="${w.id}">æ‹’ç»</button></span>`:''}</li>`).join('')}</ul></div></div></div></div>
                `;
            }

            async function renderMembers(container) {
                const users = await getData('users', []);
                const groups = await getData('groups', []);
                const canManage = isManagerOrAbove();
                const isBossUser = isBoss();
                let tabs = '<ul class="nav nav-tabs">' + groups.map((g,i)=>`<li class="nav-item"><button class="nav-link ${i===0?'active':''}" data-bs-toggle="tab" data-bs-target="#group${i}">${g}</button></li>`).join('') + '</ul><div class="tab-content mt-3">';
                groups.forEach((g,i) => {
                    const members = users.filter(u=>u.group===g);
                    tabs += `<div class="tab-pane fade ${i===0?'show active':''}" id="group${i}"><table class="table table-sm"><thead><tr><th>å§“å</th><th>è´¦å·</th><th>ä¸»ç»„</th><th>å…¼ä»»</th><th>è§’è‰²</th>${canManage?'<th>æ“ä½œ</th>':''}</tr></thead><tbody>`;
                    members.forEach(u => {
                        const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                        const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                        tabs += `<tr><td>${u.nickname}</td><td>${u.account}</td><td><span class="badge bg-primary">${u.group}</span></td><td>${u.extraGroups?.join(', ')||''}</td><td><span class="badge ${roleClass[u.role]}">${roleMap[u.role]}</span></td>`;
                        if (canManage && u.account !== currentUser.account) {
                            tabs += `<td>`;
                            if (canManageAllGroups() || (currentUser.role==='manager' && u.group===currentUser.group)) {
                                tabs += `<button class="btn btn-outline-secondary btn-permission change-group" data-account="${u.account}">æ¢ç»„</button><button class="btn btn-outline-info btn-permission add-group" data-account="${u.account}">åŠ ç»„</button>`;
                            }
                            if (isBossUser) {
                                if (u.role === 'member') {
                                    tabs += `<button class="btn btn-outline-warning btn-permission set-manager" data-account="${u.account}">è®¾ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                } else if (u.role === 'manager') {
                                    tabs += `<button class="btn btn-outline-primary btn-permission set-admin" data-account="${u.account}">è®¾ä¸ºé«˜çº§ç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                } else if (u.role === 'admin') {
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-manager" data-account="${u.account}">é™ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-secondary btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                }
                                tabs += `<button class="btn btn-outline-danger btn-permission delete-member" data-account="${u.account}">åˆ é™¤æˆå‘˜</button>`;
                            }
                            tabs += `</td>`;
                        } else if (canManage && u.account === currentUser.account) {
                            tabs += '<td><span class="text-muted">è‡ªå·±</span></td>';
                        } else {
                            tabs += '<td></td>';
                        }
                        tabs += `</tr>`;
                    });
                    tabs += members.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æˆå‘˜</td></tr>';
                    tabs += '</tbody></table></div>';
                });
                tabs += '</div>';
                if (canManage) tabs += `<div class="mt-2"><button class="btn btn-sm btn-success" id="addMemberBtn">+ æ–°å¢æˆå‘˜</button></div>`;
                container.innerHTML = `<div class="card"><div class="card-header"><i class="bi bi-people"></i> äººå‘˜åå• Â· å…±${groups.length}ç»„</div><div class="card-body">${tabs}<p class="small text-muted mt-2">åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜</p></div></div>`;
                document.getElementById('addMemberBtn')?.addEventListener('click', async function() {
                    const account = prompt('è´¦å·(çº¯è‹±æ–‡)'); if (!account || !/^[A-Za-z]+$/.test(account)) return alert('è´¦å·éœ€çº¯è‹±æ–‡');
                    const pwd = prompt('å¯†ç (å­—æ¯+æ•°å­—)'); if (!pwd || !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return alert('å¯†ç éœ€å­—æ¯æ•°å­—');
                    const nickname = prompt('ç¬”å'); if (!nickname) return;
                    let group = prompt('ä¸»ç»„åˆ«', currentUser.group); if (!group || !groups.includes(group)) return alert('æ— æ•ˆç»„åˆ«');
                    const users = await getData('users', []);
                    if (users.some(u=>u.account===account)) return alert('è´¦å·å·²å­˜åœ¨');
                    users.push({ account, password: pwd, nickname, role: 'member', group, extraGroups: [] });
                    await setData('users', users);
                    refreshCurrentSection();
                });
            }

            async function renderNotices(container) {
                const url = getDiscussUrl('notice');
                const comments = await fetchComments(url);
                const notices = comments.map(c => {
                    try { return JSON.parse(c.content); } catch { return null; }
                }).filter(n => n !== null);
                notices.sort((a, b) => {
                    if (a.top && !b.top) return -1;
                    if (!a.top && b.top) return 1;
                    return new Date(b.time) - new Date(a.time);
                });
                const canPub = canPublishNotice();
                let html = `<div class="card"><div class="card-header d-flex justify-content-between"><span><i class="bi bi-megaphone"></i> é€šçŸ¥å…¬å‘Š</span><span class="badge bg-warning">å‘å¸ƒ:é«˜çº§ç®¡ç†å‘˜åŠè€æ¿</span></div><div class="card-body">`;
                if (notices.length === 0) {
                    html += '<div class="text-muted">æš‚æ— å…¬å‘Š</div>';
                } else {
                    notices.forEach(n => {
                        const topClass = n.top ? 'notice-item top' : 'notice-item';
                        html += `<div class="${topClass}">
                            <div><strong>ğŸ“¢ ${n.title}</strong> <small class="text-muted">(${n.publisher} ${n.time})</small></div>
                            <div class="mt-2">${n.content}</div>
                        </div>`;
                    });
                }
                if (canPub) html += '<button class="btn btn-sm btn-danger mt-2" id="publishNoticeBtn">å‘å¸ƒæ–°é€šçŸ¥</button>';
                html += '</div></div>';
                container.innerHTML = html;
            }

            async function renderSettings(container) {
                if (!isBoss()) { container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>'; return; }
                const groups = await getData('groups', []);
                const progress = await getData('progress', []);
                const currentTarget = progress.length > 0 ? progress[0].target : 28000;
                container.innerHTML = `
                    <div class="card"><div class="card-header">âš™ï¸ è®¾ç½®ç®¡ç† Â· ä»…è€æ¿</div><div class="card-body">
                    <div class="row"><div class="col-md-4"><h6>æ¯å‘¨ç›®æ ‡å­—æ•°</h6><input id="globalTarget" class="form-control" value="${currentTarget}"></div>
                    <div class="col-md-4"><h6>å®‰å…¨é€‰é¡¹</h6><div class="form-check"><input class="form-check-input" type="checkbox" checked disabled> äº‘ç«¯æ•°æ®åŠ å¯†å­˜å‚¨</div></div>
                    <div class="col-md-4"><h6>ç»„åˆ«ç®¡ç†</h6><p>å½“å‰ç»„åˆ«ï¼š${groups.join('ã€')}</p><button class="btn btn-outline-primary btn-sm" id="addGroupBtn">æ–°å¢ç»„åˆ«</button> <button class="btn btn-outline-secondary btn-sm" id="backupBtn">å¤‡ä»½æ•°æ®(æœ¬åœ°)</button></div></div>
                    <button class="btn btn-primary mt-2" id="saveGlobalTarget">ä¿å­˜ç›®æ ‡</button></div></div>
                `;
            }

            // åˆå§‹åŒ–æ³¨å†Œä¸‹æ‹‰æ¡†
            async function fillRegGroup() {
                const select = document.getElementById('regGroup');
                const groups = await getData('groups', []);
                const normalGroups = groups.filter(g => !ADMIN_GROUPS.includes(g));
                select.innerHTML = normalGroups.map(g => `<option>${g}</option>`).join('');
            }
            fillRegGroup();

            window.addEventListener('load', () => {
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            });
        })();
    </script>
</body>
</html>