<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡è”ç½‘æ–‡ Â· å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿï¼ˆæœ€ç»ˆä¼˜åŒ–ç‰ˆï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #1e2a3a; color: #fff; }
        .sidebar a { color: #b0c4de; text-decoration: none; padding: 0.5rem 1rem; display: block; border-radius: 0.25rem; margin: 0.2rem 0; }
        .sidebar a:hover, .sidebar a.active { background: #2c3e50; color: #fff; }
        .content { padding: 2rem; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.05); border: none; margin-bottom: 1.5rem; }
        .login-container { max-width: 900px; margin: 3rem auto; }
        .login-card { border: none; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .btn-permission { padding: 0.2rem 0.5rem; font-size: 0.7rem; margin: 2px; }
        .role-boss { background-color: #dc3545; color: white; }
        .role-admin { background-color: #0d6efd; color: white; }
        .role-manager { background-color: #fd7e14; color: white; }
        .role-member { background-color: #6c757d; color: white; }
        .discuss-messages { max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
        .msg-item { margin-bottom: 0.75rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; }
        .error-boundary { padding: 1rem; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 0.25rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div id="loginContainer" class="container login-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ” ç™»å½•</h3>
                    <div class="mb-3">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="çº¯è‹±æ–‡">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="æ•°å­—+è‹±æ–‡">
                    </div>
                    <button class="btn btn-primary w-100" id="loginBtn">ç™»å½•</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ“ æ³¨å†Œ</h3>
                    <div class="mb-2">
                        <label class="form-label">ç¬”å</label>
                        <input type="text" id="regNickname" class="form-control" placeholder="å¦‚ä½•ç§°å‘¼">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">è´¦å· <span class="text-muted">(çº¯è‹±æ–‡)</span></label>
                        <input type="text" id="regAccount" class="form-control" placeholder="ä¾‹å¦‚: qingya">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">å¯†ç  <span class="text-muted">(æ•°å­—+è‹±æ–‡)</span></label>
                        <input type="password" id="regPassword" class="form-control" placeholder="ä¾‹å¦‚: abc123">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirm" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸»ç»„åˆ« (ä»…åˆ›ä½œç»„)</label>
                        <select id="regGroup" class="form-select"></select>
                    </div>
                    <button class="btn btn-success w-100" id="registerBtn">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="mt-3 small text-danger" id="regMessage"></div>
                </div>
            </div>
        </div>
        <div class="footer-text text-center mt-4">å®‰å…¨é˜²æŠ¤ Â· è´¦å·çº¯è‹±æ–‡ / å¯†ç æ•°å­—è‹±æ–‡ç»“åˆ</div>
    </div>

    <!-- ä¸»åº”ç”¨åŒºåŸŸ -->
    <div id="appContainer" class="container-fluid p-0 hidden">
        <div class="row g-0">
            <div class="col-md-2 sidebar p-3" id="sidebar"></div>
            <div class="col-md-10 content" id="mainContent"></div>
        </div>
    </div>

    <!-- æŠ•ç¨¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="writerPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“ å‘å¸ƒæ–°ä½œå“</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="postForm">
                        <div class="mb-3"><label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label><input type="text" class="form-control" id="postTitle"></div>
                        <div class="mb-3"><label class="form-label">ç®€ä»‹</label><textarea class="form-control" id="postDescription" rows="2"></textarea></div>
                        <div class="mb-3"><label class="form-label">æ­£æ–‡ <span class="text-danger">*</span></label><textarea class="form-control" id="postContent" rows="8"></textarea><div class="form-text mt-1">å­—æ•°ç»Ÿè®¡ï¼š<span id="wordCount">0</span> å­—</div></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">æ‰€å±ç»„åˆ«</label><select class="form-select" id="postGroup"></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">æ ‡ç­¾</label><input type="text" class="form-control" id="postTags" placeholder="ä»™ä¾ , çˆ½æ–‡"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="submitPostBtn">å‘å¸ƒæŠ•ç¨¿</button></div>
            </div>
        </div>
    </div>

    <!-- æç°æ¨¡æ€æ¡† -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ’° ç”³è¯·æç°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3"><label class="form-label">é‡‘é¢</label><input type="number" class="form-control" id="withdrawAmount" min="1" step="0.01" required></div>
                        <div class="mb-3"><label class="form-label">æ–¹å¼</label><select class="form-select" id="withdrawMethod"><option value="å¾®ä¿¡">å¾®ä¿¡</option><option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option><option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option></select></div>
                        <div class="mb-3"><label class="form-label">è´¦å·</label><input type="text" class="form-control" id="withdrawAccount" required></div>
                        <div class="mb-3"><label class="form-label">å¤‡æ³¨</label><input type="text" class="form-control" id="withdrawNote"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-success" id="submitWithdrawBtn">æäº¤</button></div>
            </div>
        </div>
    </div>

    <!-- å®¡é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“„ å®¡é˜…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div id="modalPostInfo"></div><hr>
                    <h6>ğŸ“ å†…å®¹</h6><div id="modalContent" class="border p-3 bg-light" style="max-height:200px; overflow:auto;"></div><hr>
                    <h6>ğŸ’¬ æ‰¹å¤</h6><div id="modalReviews" class="mb-3"></div>
                    <div id="reviewInputArea" class="mt-2">
                        <textarea id="reviewComment" class="form-control" rows="2" placeholder="æ‰¹å¤..."></textarea>
                        <div class="mt-2"><button class="btn btn-sm btn-success" id="submitReviewApprove">é€šè¿‡</button><button class="btn btn-sm btn-warning" id="submitReviewReject">é€€å›</button><button class="btn btn-sm btn-secondary" id="submitReviewComment">è¯„è®º</button></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ç»„åˆ«æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">â• æ–°å¢ç»„åˆ«</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" class="form-control" id="newGroupName" placeholder="ç»„åˆ«åç§°"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="submitAddGroup">æ·»åŠ </button></div></div></div>
    </div>

    <!-- æœˆåº¦ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="monthlyStatsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“Š æœˆåº¦ç¨¿è´¹ç»Ÿè®¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">é€‰æ‹©æœˆä»½</label><input type="month" class="form-control" id="statsMonth"></div>
                    <div id="monthlyStatsContent"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // ---------- å­˜å‚¨é”® ----------
            const STORAGE_USERS = 'wanlian_users';
            const STORAGE_POSTS = 'wanlian_posts';
            const STORAGE_PROGRESS = 'wanlian_progress';
            const STORAGE_ROYALTIES = 'wanlian_royalties';
            const STORAGE_NOTICES = 'wanlian_notices';
            const STORAGE_DISCUSS = 'wanlian_discuss';
            const STORAGE_GROUPS = 'wanlian_groups';
            const STORAGE_WITHDRAWALS = 'wanlian_withdrawals';
            const STORAGE_NOTIFICATIONS = 'wanlian_notifications';

            // å†…å­˜ç¼“å­˜ + é»˜è®¤å€¼
            let _cachedUsers = null, _cachedPosts = null, _cachedProgress = null, _cachedRoyalties = null,
                _cachedNotices = null, _cachedDiscuss = null, _cachedGroups = null, _cachedWithdrawals = null, _cachedNotifications = null;

            function getUsers() { return _cachedUsers || (_cachedUsers = JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]')); }
            function saveUsers(users) { _cachedUsers = users; localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
            function getPosts() { return _cachedPosts || (_cachedPosts = JSON.parse(localStorage.getItem(STORAGE_POSTS) || '[]')); }
            function savePosts(posts) { _cachedPosts = posts; localStorage.setItem(STORAGE_POSTS, JSON.stringify(posts)); }
            function getProgress() { return _cachedProgress || (_cachedProgress = JSON.parse(localStorage.getItem(STORAGE_PROGRESS) || '[]')); }
            function saveProgress(prog) { _cachedProgress = prog; localStorage.setItem(STORAGE_PROGRESS, JSON.stringify(prog)); }
            function getRoyalties() { return _cachedRoyalties || (_cachedRoyalties = JSON.parse(localStorage.getItem(STORAGE_ROYALTIES) || '[]')); }
            function saveRoyalties(r) { _cachedRoyalties = r; localStorage.setItem(STORAGE_ROYALTIES, JSON.stringify(r)); }
            function getNotices() { return _cachedNotices || (_cachedNotices = JSON.parse(localStorage.getItem(STORAGE_NOTICES) || '[]')); }
            function saveNotices(n) { _cachedNotices = n; localStorage.setItem(STORAGE_NOTICES, JSON.stringify(n)); }
            function getDiscuss() { return _cachedDiscuss || (_cachedDiscuss = JSON.parse(localStorage.getItem(STORAGE_DISCUSS) || '[]')); }
            function saveDiscuss(d) { _cachedDiscuss = d; localStorage.setItem(STORAGE_DISCUSS, JSON.stringify(d)); }
            function getGroups() { return _cachedGroups || (_cachedGroups = JSON.parse(localStorage.getItem(STORAGE_GROUPS) || '["ä»™ä¾ ç»„","ç„å¹»ç»„","éƒ½å¸‚ç»„","ç»¼åˆç®¡ç†ç»„","å†…å®¹å®¡æ ¸ç»„","é¡¹ç›®æ‰§è¡Œç»„"]')); }
            function saveGroups(g) { _cachedGroups = g; localStorage.setItem(STORAGE_GROUPS, JSON.stringify(g)); }
            function getWithdrawals() { return _cachedWithdrawals || (_cachedWithdrawals = JSON.parse(localStorage.getItem(STORAGE_WITHDRAWALS) || '[]')); }
            function saveWithdrawals(w) { _cachedWithdrawals = w; localStorage.setItem(STORAGE_WITHDRAWALS, JSON.stringify(w)); }
            function getNotifications() { return _cachedNotifications || (_cachedNotifications = JSON.parse(localStorage.getItem(STORAGE_NOTIFICATIONS) || '[]')); }
            function saveNotifications(n) { _cachedNotifications = n; localStorage.setItem(STORAGE_NOTIFICATIONS, JSON.stringify(n)); }

            // ---------- å…¨å±€å˜é‡ ----------
            let currentUser = null;
            let activeSection = 'dashboard';
            const ADMIN_GROUPS = ["ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"];

            // æƒé™åˆ¤æ–­
            function isBoss() { return currentUser?.role === 'boss'; }
            function isAdmin() { return currentUser?.role === 'admin'; }
            function isManager() { return currentUser?.role === 'manager'; }
            function isAdminOrBoss() { return isAdmin() || isBoss(); }
            function isManagerOrAbove() { return isManager() || isAdminOrBoss(); }
            function canViewAllGroups() { return isManagerOrAbove(); }
            function canManageAllGroups() { return isAdminOrBoss(); }
            function canApproveWithdrawals() { return isAdminOrBoss(); }
            function canPublishNotice() { return isAdminOrBoss(); }

            // åˆ·æ–°å½“å‰è§†å›¾ï¼ˆå¼‚æ­¥ï¼‰
            function refreshCurrentSection() { setTimeout(() => renderSection(activeSection), 0); }

            // æ·»åŠ é€šçŸ¥
            function addNotification(targetUser, message) {
                const notifs = getNotifications();
                notifs.push({ id: Date.now(), targetUser, message, time: new Date().toLocaleString(), read: false });
                saveNotifications(notifs);
            }

            // åŒæ­¥å½“å‰ç”¨æˆ·ï¼ˆæ ¹æ®ä¾§è¾¹æ æ˜¾ç¤ºçš„æ˜µç§°ï¼‰
            function syncCurrentUser() {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar) return;
                const strong = sidebar.querySelector('.text-white-50 strong');
                if (!strong) return;
                const nickname = strong.innerText;
                currentUser = getUsers().find(u => u.nickname === nickname) || null;
            }

            // ---------- åˆå§‹åŒ–æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œåˆ™åˆ›å»ºé»˜è®¤è€æ¿è´¦å·ï¼‰----------
            function initDefaultData() {
                const users = getUsers();
                if (users.length === 0) {
                    // åˆ›å»ºé»˜è®¤è€æ¿ï¼šé‚¹ç§¦é›„ï¼Œè´¦å·laobanï¼Œå¯†ç 080415zqxï¼Œæ˜µç§°ä¼šé•¿
                    users.push({
                        account: 'laoban',
                        password: '080415zqx',
                        nickname: 'ä¼šé•¿',
                        role: 'boss',
                        group: 'ç»¼åˆç®¡ç†ç»„',
                        extraGroups: []
                    });
                    saveUsers(users);
                }
                // ç¡®ä¿è¿›åº¦è¡¨å­˜åœ¨
                const groups = getGroups();
                let progress = getProgress();
                groups.forEach(g => {
                    if (!progress.some(p => p.group === g)) {
                        progress.push({ group: g, outlineDone: false, weekWords: 0, target: 28000 });
                    }
                });
                saveProgress(progress);
            }
            initDefaultData();

            // ---------- äº‹ä»¶å§”æ‰˜ ----------
            document.addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;

                // ä½¿ç”¨å¯¹è±¡æ˜ å°„å¿«é€Ÿå¤„ç†
                const idHandlers = {
                    loginBtn: handleLogin,
                    registerBtn: handleRegister,
                    logoutBtnSide: handleLogout,
                    newPostBtn: handleNewPost,
                    submitPostBtn: handleSubmitPost,
                    newWithdrawBtn: () => new bootstrap.Modal(document.getElementById('withdrawModal')).show(),
                    submitWithdrawBtn: handleWithdrawSubmit,
                    newRoyaltyBtn: handleNewRoyalty,
                    monthlyStatsBtn: showMonthlyStats,
                    publishNoticeBtn: handlePublishNotice,
                    addGroupBtn: () => new bootstrap.Modal(document.getElementById('addGroupModal')).show(),
                    submitAddGroup: handleAddGroup,
                    saveGlobalTarget: handleSaveTarget,
                    backupBtn: handleBackup,
                    submitReviewApprove: () => handleReview('approve'),
                    submitReviewReject: () => handleReview('reject'),
                    submitReviewComment: () => handleReview('comment'),
                    sendDiscussBtn: () => handleSendDiscuss('group'),
                    sendGlobalDiscussBtn: () => handleSendDiscuss('global'),
                    sendAllGroupsBtn: () => handleSendDiscuss('allGroups')
                };
                if (idHandlers[target.id]) {
                    e.preventDefault();
                    idHandlers[target.id](e);
                    return;
                }

                // class å¤„ç†
                if (target.classList.contains('view-post')) handleViewPost(e);
                else if (target.classList.contains('edit-status')) handleEditStatus(e);
                else if (target.classList.contains('delete-royalty')) handleDeleteRoyalty(e);
                else if (target.classList.contains('approve-withdraw')) handleApproveWithdraw(e);
                else if (target.classList.contains('reject-withdraw')) handleRejectWithdraw(e);
                else if (target.classList.contains('edit-notice')) handleEditNotice(e);
                else if (target.classList.contains('delete-notice')) handleDeleteNotice(e);
                else if (target.classList.contains('mark-read')) handleMarkRead(e);
                else if (target.classList.contains('edit-progress')) handleEditProgress(e);
                else if (target.classList.contains('change-group') || target.classList.contains('add-group') ||
                         target.classList.contains('set-manager') || target.classList.contains('set-admin') ||
                         target.classList.contains('demote-member') || target.classList.contains('demote-manager') ||
                         target.classList.contains('delete-member'))
                    handleMemberAction(e);
            });

            // å­—æ•°ç»Ÿè®¡é˜²æŠ–
            let wordCountTimer;
            document.getElementById('postContent')?.addEventListener('input', function() {
                clearTimeout(wordCountTimer);
                wordCountTimer = setTimeout(() => {
                    const text = this.value;
                    const chinese = text.replace(/[^\u4e00-\u9fa5]/g, '').length;
                    document.getElementById('wordCount').innerText = chinese;
                }, 200);
            });

            // æœˆä»½ç»Ÿè®¡æ›´æ–°
            document.getElementById('statsMonth')?.addEventListener('change', updateMonthlyStats);

            // ---------- æ ¸å¿ƒå¤„ç†å‡½æ•° ----------
            function handleLogin(e) {
                const account = document.getElementById('loginAccount').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const user = getUsers().find(u => u.account === account && u.password === pwd);
                if (user) {
                    currentUser = user;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    renderApp();
                } else alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
            }

            function handleRegister(e) {
                const nickname = document.getElementById('regNickname').value.trim();
                const account = document.getElementById('regAccount').value.trim();
                const pwd = document.getElementById('regPassword').value.trim();
                const confirm = document.getElementById('regConfirm').value.trim();
                const group = document.getElementById('regGroup').value;
                if (!nickname || !account || !pwd || !confirm) return document.getElementById('regMessage').innerText = 'æ‰€æœ‰å­—æ®µå¿…å¡«';
                if (!/^[A-Za-z]+$/.test(account)) return document.getElementById('regMessage').innerText = 'è´¦å·éœ€çº¯è‹±æ–‡';
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return document.getElementById('regMessage').innerText = 'å¯†ç éœ€å­—æ¯+æ•°å­—';
                if (pwd !== confirm) return document.getElementById('regMessage').innerText = 'å¯†ç ä¸ä¸€è‡´';
                const users = getUsers();
                if (users.some(u => u.account === account)) return document.getElementById('regMessage').innerText = 'è´¦å·å·²å­˜åœ¨';
                const newUser = { account, password: pwd, nickname, role: 'member', group, extraGroups: [] };
                users.push(newUser);
                saveUsers(users);
                currentUser = newUser;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                renderApp();
            }

            function handleLogout(e) {
                e.preventDefault();
                currentUser = null;
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            }

            function handleNewPost(e) {
                e.preventDefault();
                const groups = getGroups();
                const available = isAdminOrBoss() ? groups : [currentUser.group];
                const select = document.getElementById('postGroup');
                select.innerHTML = '';
                available.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g; opt.textContent = g;
                    if (g === currentUser.group) opt.selected = true;
                    select.appendChild(opt);
                });
                document.getElementById('postTitle').value = '';
                document.getElementById('postDescription').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('postTags').value = '';
                document.getElementById('wordCount').innerText = '0';
                new bootstrap.Modal(document.getElementById('writerPostModal')).show();
            }

            function handleSubmitPost(e) {
                const title = document.getElementById('postTitle').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const group = document.getElementById('postGroup').value;
                if (!title || !content) return alert('æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º');
                const words = content.replace(/[^\u4e00-\u9fa5]/g, '').length;
                if (words === 0) return alert('è‡³å°‘åŒ…å«ä¸­æ–‡å­—ç¬¦');
                const posts = getPosts();
                posts.push({
                    id: Date.now(), group, title, author: currentUser.nickname,
                    time: new Date().toISOString().slice(0,10), words, content,
                    description: document.getElementById('postDescription').value.trim(),
                    tags: document.getElementById('postTags').value.split(',').map(s=>s.trim()).filter(Boolean),
                    reviews: []
                });
                savePosts(posts);
                const prog = getProgress().find(p => p.group === group);
                if (prog) { prog.weekWords += words; saveProgress(getProgress()); }
                bootstrap.Modal.getInstance(document.getElementById('writerPostModal')).hide();
                refreshCurrentSection();
            }

            function handleViewPost(e) {
                const id = e.target.closest('.view-post').dataset.id;
                const post = getPosts().find(p => p.id == id);
                if (!post) return;
                document.getElementById('modalPostInfo').innerHTML = `<h6>${post.title} by ${post.author} (${post.group}) å­—æ•°:${post.words}</h6>`;
                document.getElementById('modalContent').innerText = post.content || 'ï¼ˆæ— æ–‡æ¡ˆï¼‰';
                const reviewsDiv = document.getElementById('modalReviews');
                reviewsDiv.innerHTML = post.reviews?.length ? post.reviews.map(r => `<div class="border p-2 mb-2"><span class="badge ${r.action==='é€šè¿‡'?'bg-success':r.action==='é€€å›'?'bg-danger':'bg-secondary'}">${r.action}</span> <strong>${r.reviewer}</strong>: ${r.comment} <small>${r.time}</small></div>`).join('') : '<p class="text-muted">æš‚æ— æ‰¹å¤</p>';
                document.getElementById('reviewInputArea').style.display = isManagerOrAbove() ? 'block' : 'none';
                document.getElementById('reviewModal').dataset.postId = id;
                new bootstrap.Modal(document.getElementById('reviewModal')).show();
            }

            function handleReview(action) {
                const modal = document.getElementById('reviewModal');
                const postId = modal.dataset.postId;
                const comment = document.getElementById('reviewComment').value.trim();
                if (!comment && action !== 'comment') return alert('è¯·å¡«å†™æ‰¹å¤');
                const posts = getPosts();
                const post = posts.find(p => p.id == postId);
                if (!post) return;
                if (!post.reviews) post.reviews = [];
                const actionName = action === 'approve' ? 'é€šè¿‡' : action === 'reject' ? 'é€€å›' : 'è¯„è®º';
                post.reviews.push({ reviewer: currentUser.nickname, action: actionName, comment: comment || 'ï¼ˆæ— ï¼‰', time: new Date().toLocaleString() });
                savePosts(posts);
                if (action === 'reject') addNotification(post.author, `ç¨¿ä»¶ã€Š${post.title}ã€‹è¢«é€€å›ã€‚æ‰¹å¤ï¼š${comment||'æ— '}`);
                bootstrap.Modal.getInstance(modal).hide();
                refreshCurrentSection();
            }

            function handleWithdrawSubmit(e) {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const method = document.getElementById('withdrawMethod').value;
                const account = document.getElementById('withdrawAccount').value.trim();
                if (!amount || amount <= 0 || !account) return alert('è¯·å¡«å†™å®Œæ•´');
                const wd = getWithdrawals();
                wd.push({ id: Date.now(), user: currentUser.nickname, amount, method, account, note: document.getElementById('withdrawNote').value.trim(), time: new Date().toLocaleString(), status: 'å¾…å¤„ç†' });
                saveWithdrawals(wd);
                getUsers().filter(u => u.role === 'boss' || u.role === 'admin').forEach(admin => addNotification(admin.nickname, `ç”¨æˆ· ${currentUser.nickname} æäº¤äº† Â¥${amount} æç°ç”³è¯·`));
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                refreshCurrentSection();
            }

            function handleNewRoyalty(e) {
                const user = prompt('æˆå‘˜ç¬”å', currentUser.nickname); if (!user) return;
                const amount = parseFloat(prompt('é‡‘é¢')); if (amount <= 0) return;
                const group = prompt('ç»„åˆ«', currentUser.group) || currentUser.group;
                const r = getRoyalties();
                r.push({ id: Date.now(), user, group, amount, status: 'å¾…ç¡®è®¤', time: new Date().toISOString().slice(0,10) });
                saveRoyalties(r);
                refreshCurrentSection();
            }

            function showMonthlyStats() {
                const modal = new bootstrap.Modal(document.getElementById('monthlyStatsModal'));
                const month = document.getElementById('statsMonth');
                const now = new Date();
                month.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                updateMonthlyStats();
                modal.show();
            }

            function updateMonthlyStats() {
                const month = document.getElementById('statsMonth').value;
                if (!month) return;
                const royalties = getRoyalties();
                const stats = {};
                royalties.forEach(r => {
                    if (r.time?.startsWith(month)) {
                        if (!stats[r.user]) stats[r.user] = { å·²å‘:0,å¾…ç¡®è®¤:0,æå–ä¸­:0,æ€»è®¡:0 };
                        stats[r.user][r.status] = (stats[r.user][r.status]||0) + r.amount;
                        stats[r.user].æ€»è®¡ += r.amount;
                    }
                });
                const remaining = royalties.filter(r => r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0);
                let html = `<p>æœˆä»½ï¼š${month} å‰©ä½™å¾…å‘ï¼šÂ¥${remaining}</p><table class="table table-sm"><thead><tr><th>æˆå‘˜</th><th>å·²å‘</th><th>å¾…ç¡®è®¤</th><th>æå–ä¸­</th><th>æ€»è®¡</th></tr></thead><tbody>`;
                if (Object.keys(stats).length) {
                    Object.keys(stats).sort().forEach(u => html += `<tr><td>${u}</td><td>Â¥${stats[u].å·²å‘}</td><td>Â¥${stats[u].å¾…ç¡®è®¤}</td><td>Â¥${stats[u].æå–ä¸­}</td><td>Â¥${stats[u].æ€»è®¡}</td></tr>`);
                } else html += '<tr><td colspan="5" class="text-center">æ— è®°å½•</td></tr>';
                html += '</tbody></table>';
                document.getElementById('monthlyStatsContent').innerHTML = html;
            }

            function handlePublishNotice(e) {
                if (!canPublishNotice()) return alert('æƒé™ä¸è¶³');
                const title = prompt('æ ‡é¢˜'); if (!title) return;
                const content = prompt('æ­£æ–‡', '');
                const top = confirm('ç½®é¡¶ï¼Ÿ');
                const notices = getNotices();
                notices.push({ id: Date.now(), title, content: content||'', publisher: currentUser.nickname, role: currentUser.role, time: new Date().toISOString().slice(0,10), top });
                saveNotices(notices);
                refreshCurrentSection();
            }

            function handleEditNotice(e) {
                if (!canPublishNotice()) return alert('æƒé™ä¸è¶³');
                const id = e.target.closest('.edit-notice').dataset.id;
                const notices = getNotices();
                const n = notices.find(n => n.id == id);
                if (!n) return;
                const newTitle = prompt('ç¼–è¾‘æ ‡é¢˜', n.title);
                if (newTitle === null) return;
                const newContent = prompt('ç¼–è¾‘æ­£æ–‡', n.content||'');
                n.title = newTitle.trim() || n.title;
                n.content = newContent?.trim() || '';
                saveNotices(notices);
                refreshCurrentSection();
            }

            function handleDeleteNotice(e) {
                const id = e.target.closest('.delete-notice').dataset.id;
                const notices = getNotices();
                const n = notices.find(n => n.id == id);
                if (!canPublishNotice() && n.publisher !== currentUser.nickname) return alert('æ— æƒåˆ é™¤');
                if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                saveNotices(notices.filter(n => n.id != id));
                refreshCurrentSection();
            }

            function handleMarkRead(e) {
                const id = e.target.closest('.mark-read').dataset.id;
                const notifs = getNotifications();
                const idx = notifs.findIndex(n => n.id == id);
                if (idx !== -1) notifs[idx].read = true;
                saveNotifications(notifs);
                refreshCurrentSection();
            }

            function handleMemberAction(e) {
                const btn = e.target.closest('button');
                const account = btn.dataset.account;
                if (!account) return;
                const users = getUsers();
                const user = users.find(u => u.account === account);
                if (!user) return;
                const groups = getGroups();

                if (btn.classList.contains('change-group')) {
                    const newGroup = prompt('æ–°ä¸»ç»„', user.group);
                    if (!newGroup) return;
                    if (ADMIN_GROUPS.includes(newGroup) && !isBoss()) return alert('åªæœ‰è€æ¿å¯è°ƒå…¥ç®¡ç†ç»„');
                    if (groups.includes(newGroup)) { user.group = newGroup; saveUsers(users); refreshCurrentSection(); }
                } else if (btn.classList.contains('add-group')) {
                    const extra = prompt('å…¼ä»»ç»„', '');
                    if (!extra) return;
                    if (ADMIN_GROUPS.includes(extra) && !isBoss()) return alert('åªæœ‰è€æ¿å¯æ·»åŠ ç®¡ç†ç»„');
                    if (groups.includes(extra) && extra !== user.group && !user.extraGroups.includes(extra)) {
                        user.extraGroups.push(extra); saveUsers(users); refreshCurrentSection();
                    }
                } else if (btn.classList.contains('set-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®ç®¡ç†å‘˜');
                    user.role = 'manager'; saveUsers(users); refreshCurrentSection(); 
                } else if (btn.classList.contains('set-admin')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯è®¾ç½®é«˜çº§ç®¡ç†å‘˜');
                    user.role = 'admin'; saveUsers(users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-member')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'member'; saveUsers(users); refreshCurrentSection(); 
                } else if (btn.classList.contains('demote-manager')) { 
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯é™çº§');
                    user.role = 'manager'; saveUsers(users); refreshCurrentSection(); 
                } else if (btn.classList.contains('delete-member')) {
                    if (!isBoss()) return alert('åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜');
                    if (user.account === currentUser.account) return alert('ä¸èƒ½åˆ é™¤è‡ªå·±');
                    if (!confirm(`ç¡®å®šåˆ é™¤æˆå‘˜ ${user.nickname}ï¼ˆè´¦å·ï¼š${user.account}ï¼‰å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æˆå‘˜çš„æ‰€æœ‰æŠ•ç¨¿ã€ç¨¿è´¹è®°å½•ã€æç°ç”³è¯·å’Œäº¤æµæ¶ˆæ¯ã€‚`)) return;
                    
                    const nickname = user.nickname;
                    const posts = getPosts().filter(p => p.author !== nickname);
                    savePosts(posts);
                    const royalties = getRoyalties().filter(r => r.user !== nickname);
                    saveRoyalties(royalties);
                    const withdrawals = getWithdrawals().filter(w => w.user !== nickname);
                    saveWithdrawals(withdrawals);
                    const discuss = getDiscuss().filter(d => d.user !== nickname);
                    saveDiscuss(discuss);
                    const newUsers = users.filter(u => u.account !== account);
                    saveUsers(newUsers);
                    refreshCurrentSection();
                }
            }

            function handleEditProgress(e) {
                const btn = e.target.closest('.edit-progress');
                const group = btn.dataset.group;
                let prog = getProgress();
                const item = prog.find(p => p.group === group);
                if (!item) return;
                const newWords = prompt('ä¿®æ”¹æœ¬å‘¨å­—æ•°', item.weekWords);
                if (newWords && !isNaN(newWords)) item.weekWords = parseInt(newWords);
                const outline = confirm('å¤§çº²å·²å®Œæˆï¼Ÿ');
                item.outlineDone = outline;
                saveProgress(prog);
                refreshCurrentSection();
            }

            function handleEditStatus(e) {
                const id = e.target.closest('.edit-status').dataset.id;
                let rs = getRoyalties();
                const r = rs.find(r => r.id == id);
                if (!r) return;
                const ns = prompt('æ–°çŠ¶æ€ï¼šå·²å‘/å¾…ç¡®è®¤/æå–ä¸­', r.status);
                if (ns && ['å·²å‘','å¾…ç¡®è®¤','æå–ä¸­'].includes(ns)) { r.status = ns; saveRoyalties(rs); refreshCurrentSection(); }
            }

            function handleDeleteRoyalty(e) {
                const id = e.target.closest('.delete-royalty').dataset.id;
                if (!confirm('åˆ é™¤ï¼Ÿ')) return;
                saveRoyalties(getRoyalties().filter(r => r.id != id));
                refreshCurrentSection();
            }

            function handleApproveWithdraw(e) {
                const id = e.target.closest('.approve-withdraw').dataset.id;
                let ws = getWithdrawals();
                const w = ws.find(w => w.id == id);
                if (w) { w.status = 'å·²é€šè¿‡'; saveWithdrawals(ws); addNotification(w.user, `æç° Â¥${w.amount} å·²é€šè¿‡`); refreshCurrentSection(); }
            }

            function handleRejectWithdraw(e) {
                const id = e.target.closest('.reject-withdraw').dataset.id;
                let ws = getWithdrawals();
                const w = ws.find(w => w.id == id);
                if (w) { w.status = 'å·²æ‹’ç»'; saveWithdrawals(ws); addNotification(w.user, `æç° Â¥${w.amount} è¢«æ‹’ç»`); refreshCurrentSection(); }
            }

            function handleAddGroup(e) {
                const newGroup = document.getElementById('newGroupName').value.trim();
                if (!newGroup) return;
                const groups = getGroups();
                if (groups.includes(newGroup)) return alert('å·²å­˜åœ¨');
                groups.push(newGroup);
                saveGroups(groups);
                let prog = getProgress();
                if (!prog.some(p => p.group === newGroup)) prog.push({ group: newGroup, outlineDone: false, weekWords: 0, target: 28000 });
                saveProgress(prog);
                bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
                document.getElementById('newGroupName').value = '';
                refreshCurrentSection();
            }

            function handleSaveTarget(e) {
                const newTarget = parseInt(document.getElementById('globalTarget').value, 10);
                if (newTarget > 0) {
                    let prog = getProgress();
                    prog.forEach(p => p.target = newTarget);
                    saveProgress(prog);
                    alert('ç›®æ ‡å·²æ›´æ–°');
                    refreshCurrentSection();
                }
            }

            function handleBackup(e) {
                const data = {
                    users: getUsers(), posts: getPosts(), progress: getProgress(),
                    royalties: getRoyalties(), notices: getNotices(), discuss: getDiscuss(),
                    groups: getGroups(), withdrawals: getWithdrawals(), notifications: getNotifications()
                };
                localStorage.setItem('backup_' + Date.now(), JSON.stringify(data));
                alert('å¤‡ä»½å®Œæˆ');
            }

            function handleSendDiscuss(type) {
                let group, inputId;
                if (type === 'group') {
                    group = currentUser.group;
                    inputId = 'discussInput';
                } else if (type === 'global') {
                    group = 'å…¨å±€äº¤æµåŒº';
                    inputId = 'globalDiscussInput';
                } else if (type === 'allGroups') {
                    const select = document.getElementById('allGroupsSelect');
                    if (!select) return;
                    group = select.value;
                    inputId = 'allGroupsDiscussInput';
                } else return;
                const input = document.getElementById(inputId);
                if (!input) return;
                const text = input.value.trim();
                if (!text) return;
                const discuss = getDiscuss();
                discuss.push({ group: group, user: currentUser.nickname, message: text, time: new Date().toLocaleString() });
                saveDiscuss(discuss);
                input.value = '';
                refreshCurrentSection();
            }

            // ---------- æ¸²æŸ“å‡½æ•° ----------
            function renderApp() {
                const sidebar = document.getElementById('sidebar');
                const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                let links = [
                    { sec:'dashboard', icon:'speedometer2', name:'ä»ªè¡¨ç›˜' },
                    { sec:'posts', icon:'pencil-square', name:'æŠ•ç¨¿ç®¡ç†' },
                    { sec:'groupPanel', icon:'people', name:'æˆ‘çš„ç»„' },
                    { sec:'discuss', icon:'chat-dots', name:'ç»„å†…äº¤æµåŒº' },
                    { sec:'globalDiscuss', icon:'globe', name:'ğŸ“¢ æ€»äº¤æµåŒº' }
                ];
                if (isManagerOrAbove()) {
                    links.push({ sec:'allGroupsDiscuss', icon:'list-columns', name:'ç®¡ç†Â·è·¨ç»„äº¤æµ' });
                }
                links.push(
                    { sec:'progress', icon:'bar-chart', name:'è€ƒæ ¸è¿›åº¦' },
                    { sec:'royalty', icon:'cash-stack', name:'ç¨¿è´¹/æå–' },
                    { sec:'members', icon:'person-lines-fill', name:'äººå‘˜åå•' },
                    { sec:'notices', icon:'megaphone', name:'é€šçŸ¥å…¬å‘Š' }
                );
                if (isBoss()) {
                    links.push({ sec:'settings', icon:'gear', name:'è®¾ç½®ç®¡ç†' });
                }
                sidebar.innerHTML = `
                    <h4 class="text-center mb-4 text-light">ğŸ“š ä¸‡è”ç½‘æ–‡</h4>
                    <div class="mb-3 text-white-50 small">æ¬¢è¿ï¼Œ<strong>${currentUser.nickname}</strong> <span class="badge ${roleClass[currentUser.role]}">${roleMap[currentUser.role]}</span></div>
                    <nav>
                        ${links.map(l => `<a href="#" class="nav-link ${activeSection===l.sec?'active':''}" data-section="${l.sec}"><i class="bi bi-${l.icon}"></i> ${l.name}</a>`).join('')}
                        <hr class="bg-secondary"><a href="#" id="logoutBtnSide"><i class="bi bi-box-arrow-right"></i> é€€å‡º</a>
                    </nav>
                `;
                sidebar.querySelectorAll('nav a[data-section]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        activeSection = a.dataset.section;
                        sidebar.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
                        a.classList.add('active');
                        renderSection(activeSection);
                    });
                });
                renderSection(activeSection);
            }

            function renderSection(section) {
                const main = document.getElementById('mainContent');
                const fns = {
                    dashboard: renderDashboard,
                    posts: renderPosts,
                    groupPanel: renderGroupPanel,
                    discuss: renderDiscuss,
                    globalDiscuss: renderGlobalDiscuss,
                    allGroupsDiscuss: renderAllGroupsDiscuss,
                    progress: renderProgress,
                    royalty: renderRoyalty,
                    members: renderMembers,
                    notices: renderNotices,
                    settings: renderSettings
                };
                if (fns[section]) fns[section](main);
            }

            function renderDashboard(container) {
                const posts = getPosts(); const users = getUsers(); const r = getRoyalties(); const wd = getWithdrawals();
                const totalPosts = posts.length; const totalWords = posts.reduce((a,p)=>a+p.words,0);
                const pendingR = r.filter(r=>r.status!=='å·²å‘').length; const pendingW = wd.filter(w=>w.status==='å¾…å¤„ç†').length;
                const notifs = getNotifications().filter(n=>n.targetUser===currentUser.nickname && !n.read);
                container.innerHTML = `
                    <div class="alert alert-info">å®‰å…¨é˜²æŠ¤å·²å¯ç”¨ Â· å…¨å‘˜äº’åŠ¨ä¸­</div>
                    ${notifs.length ? `<div class="alert alert-warning">æ‚¨æœ‰ ${notifs.length} æ¡æœªè¯»é€šçŸ¥<div class="mt-2">${notifs.map(n=>`<div class="border-bottom pb-1">${n.message} <small>${n.time}</small> <button class="btn btn-sm btn-outline-primary mark-read float-end" data-id="${n.id}">æ ‡ä¸ºå·²è¯»</button></div>`).join('')}</div></div>` : ''}
                    <div class="row"><div class="col-12"><h2>ğŸ“‹ ä»ªè¡¨ç›˜</h2><p>ç¨¿è´¹å¾…å¤„ç†:${pendingR} æç°å¾…å®¡æ ¸:${pendingW}</p></div>${[
                        ['æ€»æŠ•ç¨¿',totalPosts,'primary'],['å®Œæˆå­—æ•°(ä¸‡)',(totalWords/10000).toFixed(1),'success'],
                        ['å¾…å‘ç¨¿è´¹','Â¥'+r.filter(r=>r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0),'warning'],
                        ['æˆå‘˜æ€»æ•°',users.length,'danger']
                    ].map(([t,v,c])=>`<div class="col-md-3"><div class="card text-white bg-${c}"><div class="card-body"><h5 class="card-title">${t}</h5><p class="display-6">${v}</p></div></div></div>`).join('')}</div>
                `;
            }

            function renderPosts(container) {
                const posts = getPosts();
                const filtered = canViewAllGroups() ? posts : posts.filter(p => p.group===currentUser.group || currentUser.extraGroups?.includes(p.group));
                container.innerHTML = `
                    <div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ“ ${canViewAllGroups()?'å…¨éƒ¨æŠ•ç¨¿':'æœ¬ç»„æŠ•ç¨¿'}</span><span class="badge bg-secondary">${canViewAllGroups()?'æ‰€æœ‰ç»„':currentUser.group}</span></div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>ç»„åˆ«</th><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>æ—¶é—´</th><th>å­—æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>
                        ${filtered.map(p=>`<tr><td>${p.group}</td><td>${p.title}</td><td>${p.author}</td><td>${p.time}</td><td>${p.words}</td><td><i class="bi bi-eye btn btn-sm btn-outline-secondary view-post" data-id="${p.id}"></i> å®¡é˜…</td></tr>`).join('')}
                        ${filtered.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æŠ•ç¨¿</td></tr>'}
                    </tbody></table></div><button class="btn btn-sm btn-outline-primary" id="newPostBtn">+ æ–°æŠ•ç¨¿</button></div></div>
                `;
            }

            function renderGroupPanel(container) {
                const posts = getPosts().filter(p => p.group === currentUser.group);
                container.innerHTML = `<div class="card"><div class="card-header">ğŸ§˜ ${currentUser.group} Â· æœ¬ç»„æŠ•ç¨¿</div><div class="card-body"><ul class="list-group">${posts.map(p=>`<li class="list-group-item d-flex justify-content-between">${p.title} ä½œè€…: ${p.author} <span>${p.words}å­—</span></li>`).join('')||'<li class="list-group-item text-muted">æš‚æ— </li>'}</ul></div></div>`;
            }

            function renderDiscuss(container) {
                const msgs = getDiscuss().filter(m => m.group === currentUser.group);
                container.innerHTML = `
                    <div class="card"><div class="card-header">ğŸ’¬ ${currentUser.group} Â· äº¤æµåŒº</div>
                    <div class="card-body discuss-messages">${msgs.map(m=>`<div class="msg-item"><strong>${m.user}:</strong> ${m.message} <small class="float-end">${m.time}</small></div>`).join('')||'<div class="text-muted">æš‚æ— æ¶ˆæ¯</div>'}</div>
                    <div class="card-footer d-flex gap-2"><input type="text" class="form-control" id="discussInput" placeholder="å‘è¨€..."><button class="btn btn-sm btn-primary" id="sendDiscussBtn">å‘é€</button></div></div>
                `;
            }

            function renderGlobalDiscuss(container) {
                const msgs = getDiscuss().filter(m => m.group === 'å…¨å±€äº¤æµåŒº');
                container.innerHTML = `
                    <div class="card"><div class="card-header">ğŸŒ æ€»äº¤æµåŒº Â· æ‰€æœ‰äººå¯è§</div>
                    <div class="card-body discuss-messages">${msgs.map(m=>`<div class="msg-item"><strong>${m.user}:</strong> ${m.message} <small class="float-end">${m.time}</small></div>`).join('')||'<div class="text-muted">æš‚æ— æ¶ˆæ¯</div>'}</div>
                    <div class="card-footer d-flex gap-2"><input type="text" class="form-control" id="globalDiscussInput" placeholder="å‘è¨€..."><button class="btn btn-sm btn-primary" id="sendGlobalDiscussBtn">å‘é€</button></div></div>
                `;
            }

            function renderAllGroupsDiscuss(container) {
                if (!isManagerOrAbove()) {
                    container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>';
                    return;
                }
                const allMsgs = getDiscuss().filter(m => m.group !== 'å…¨å±€äº¤æµåŒº');
                const sorted = [...allMsgs].sort((a,b) => new Date(b.time) - new Date(a.time));
                const groups = getGroups();
                container.innerHTML = `
                    <div class="card"><div class="card-header">ğŸ‘¥ ç®¡ç†Â·è·¨ç»„äº¤æµåŒº (å¯å‘ä»»æ„ç»„å‘é€æ¶ˆæ¯)</div>
                    <div class="card-body discuss-messages">${sorted.map(m=>`<div class="msg-item"><span class="badge bg-secondary">${m.group}</span> <strong>${m.user}:</strong> ${m.message} <small class="float-end">${m.time}</small></div>`).join('')||'<div class="text-muted">æš‚æ— æ¶ˆæ¯</div>'}</div>
                    <div class="card-footer d-flex gap-2">
                        <select class="form-select" id="allGroupsSelect" style="width: auto; max-width:200px;">
                            ${groups.map(g => `<option value="${g}">${g}</option>`).join('')}
                        </select>
                        <input type="text" class="form-control" id="allGroupsDiscussInput" placeholder="å‘æ‰€é€‰ç»„å‘é€æ¶ˆæ¯...">
                        <button class="btn btn-sm btn-primary" id="sendAllGroupsBtn">å‘é€</button>
                    </div></div>
                `;
            }

            function renderProgress(container) {
                let prog = getProgress();
                const canView = canViewAllGroups();
                let filtered = canView ? prog : prog.filter(p => p.group === currentUser.group);
                container.innerHTML = `
                    <div class="card"><div class="card-header">ğŸ“Š è€ƒæ ¸è¿›åº¦ ${canView?'<span class="badge bg-info">ç®¡ç†å‘˜å¯ç¼–è¾‘</span>':''}</div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead><tr><th>ç»„åˆ«</th><th>å¤§çº²</th><th>æœ¬å‘¨å­—æ•°</th><th>ç›®æ ‡</th><th>è¿›åº¦</th>${canView?'<th>æ“ä½œ</th>':''}</tr></thead><tbody>
                        ${filtered.map(p => {
                            const percent = Math.min(100, Math.round(p.weekWords/p.target*100));
                            return `<tr><td>${p.group}</td><td>${p.outlineDone?'âœ…':'â³'}</td><td>${p.weekWords}</td><td>${p.target}</td><td><div class="progress"><div class="progress-bar" style="width:${percent}%">${percent}%</div></div></td>${canView?`<td><button class="btn btn-sm btn-outline-secondary edit-progress" data-group="${p.group}">ç¼–è¾‘</button></td>`:''}</tr>`;
                        }).join('')}
                    </tbody></table></div></div></div>
                `;
            }

            function renderRoyalty(container) {
                const r = getRoyalties(); const w = getWithdrawals(); const now = new Date(); const month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const monthly = w.filter(w=>w.status==='å·²é€šè¿‡' && w.time.startsWith(month)).reduce((s,w)=>s+w.amount,0);
                const userR = r.filter(rr => isManagerOrAbove() ? true : rr.user === currentUser.nickname);
                container.innerHTML = `
                    <div class="row"><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>ğŸ’° ç¨¿è´¹è®°å½•</span><span>${isAdminOrBoss()?'<button class="btn btn-sm btn-info me-2" id="monthlyStatsBtn">ğŸ“Š æœˆåº¦ç»Ÿè®¡</button>':''}${isManagerOrAbove()?'<button class="btn btn-sm btn-primary" id="newRoyaltyBtn">+ å‘æ”¾</button>':''}</span></div>
                    <div class="card-body"><ul class="list-group">${userR.map(rr=>`<li class="list-group-item d-flex justify-content-between"><span><strong>${rr.user}</strong> Â· ${rr.group}  Â¥${rr.amount}</span><span class="badge ${rr.status==='å·²å‘'?'bg-success':rr.status==='å¾…ç¡®è®¤'?'bg-warning':'bg-secondary'}">${rr.status}</span><span>${isManagerOrAbove()?`<button class="btn btn-sm btn-outline-success edit-status" data-id="${rr.id}">æ”¹</button><button class="btn btn-sm btn-outline-danger delete-royalty" data-id="${rr.id}">åˆ </button>`:''}</span></li>`).join('')}</ul></div></div></div>
                    <div class="col-md-6"><div class="card"><div class="card-header">ğŸ’³ æç°ç”³è¯·</div><div class="card-body"><p>æœˆåº¦æµæ°´ï¼šÂ¥${monthly} (${month})</p><button class="btn btn-sm btn-success" id="newWithdrawBtn">ç”³è¯·æç°</button><hr><h6>å†å²è®°å½•</h6><ul class="list-group" style="max-height:200px; overflow:auto">${w.filter(w=>w.user===currentUser.nickname||isManagerOrAbove()).map(w=>`<li class="list-group-item d-flex justify-content-between"><span>${w.user} Â¥${w.amount} (${w.method})</span><span class="badge ${w.status==='å·²é€šè¿‡'?'bg-success':w.status==='å·²æ‹’ç»'?'bg-danger':'bg-warning'}">${w.status}</span>${canApproveWithdrawals()&&w.status==='å¾…å¤„ç†'?`<span><button class="btn btn-sm btn-success approve-withdraw" data-id="${w.id}">é€šè¿‡</button><button class="btn btn-sm btn-danger reject-withdraw" data-id="${w.id}">æ‹’ç»</button></span>`:''}</li>`).join('')}</ul></div></div></div></div>
                `;
            }

            function renderMembers(container) {
                const users = getUsers(); const groups = getGroups(); const canManage = isManagerOrAbove(); const isBossUser = isBoss();
                let tabs = '<ul class="nav nav-tabs">' + groups.map((g,i)=>`<li class="nav-item"><button class="nav-link ${i===0?'active':''}" data-bs-toggle="tab" data-bs-target="#group${i}">${g}</button></li>`).join('') + '</ul><div class="tab-content mt-3">';
                groups.forEach((g,i) => {
                    const members = users.filter(u=>u.group===g);
                    tabs += `<div class="tab-pane fade ${i===0?'show active':''}" id="group${i}"><table class="table table-sm"><thead><tr><th>å§“å</th><th>è´¦å·</th><th>ä¸»ç»„</th><th>å…¼ä»»</th><th>è§’è‰²</th>${canManage?'<th>æ“ä½œ</th>':''}</tr></thead><tbody>`;
                    members.forEach(u => {
                        const roleMap = { boss:'è€æ¿', admin:'é«˜çº§ç®¡ç†å‘˜', manager:'æ™®é€šç®¡ç†å‘˜', member:'æˆå‘˜' };
                        const roleClass = { boss:'role-boss', admin:'role-admin', manager:'role-manager', member:'role-member' };
                        tabs += `<tr><td>${u.nickname}</td><td>${u.account}</td><td><span class="badge bg-primary">${u.group}</span></td><td>${u.extraGroups?.join(', ')||''}</td><td><span class="badge ${roleClass[u.role]}">${roleMap[u.role]}</span></td>`;
                        if (canManage && u.account !== currentUser.account) {
                            tabs += `<td>`;
                            if (canManageAllGroups() || (currentUser.role==='manager' && u.group===currentUser.group)) {
                                tabs += `<button class="btn btn-outline-secondary btn-permission change-group" data-account="${u.account}">æ¢ç»„</button><button class="btn btn-outline-info btn-permission add-group" data-account="${u.account}">åŠ ç»„</button>`;
                            }
                            if (isBossUser) {
                                if (u.role === 'member') {
                                    tabs += `<button class="btn btn-outline-warning btn-permission set-manager" data-account="${u.account}">è®¾ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                } else if (u.role === 'manager') {
                                    tabs += `<button class="btn btn-outline-primary btn-permission set-admin" data-account="${u.account}">è®¾ä¸ºé«˜çº§ç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                } else if (u.role === 'admin') {
                                    tabs += `<button class="btn btn-outline-danger btn-permission demote-manager" data-account="${u.account}">é™ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                    tabs += `<button class="btn btn-outline-secondary btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                }
                                tabs += `<button class="btn btn-outline-danger btn-permission delete-member" data-account="${u.account}">åˆ é™¤æˆå‘˜</button>`;
                            }
                            tabs += `</td>`;
                        } else if (canManage && u.account === currentUser.account) {
                            tabs += '<td><span class="text-muted">è‡ªå·±</span></td>';
                        } else {
                            tabs += '<td></td>';
                        }
                        tabs += `</tr>`;
                    });
                    tabs += members.length?'':'<tr><td colspan="6" class="text-center">æš‚æ— æˆå‘˜</td></tr>';
                    tabs += '</tbody></table></div>';
                });
                tabs += '</div>';
                if (canManage) tabs += `<div class="mt-2"><button class="btn btn-sm btn-success" id="addMemberBtn">+ æ–°å¢æˆå‘˜</button></div>`;
                container.innerHTML = `<div class="card"><div class="card-header"><i class="bi bi-people"></i> äººå‘˜åå• Â· å…±${groups.length}ç»„</div><div class="card-body">${tabs}<p class="small text-muted mt-2">åªæœ‰è€æ¿å¯åˆ é™¤æˆå‘˜</p></div></div>`;
                document.getElementById('addMemberBtn')?.addEventListener('click', function() {
                    const account = prompt('è´¦å·(çº¯è‹±æ–‡)'); if (!account || !/^[A-Za-z]+$/.test(account)) return alert('è´¦å·éœ€çº¯è‹±æ–‡');
                    const pwd = prompt('å¯†ç (å­—æ¯+æ•°å­—)'); if (!pwd || !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) return alert('å¯†ç éœ€å­—æ¯æ•°å­—');
                    const nickname = prompt('ç¬”å'); if (!nickname) return;
                    let group = prompt('ä¸»ç»„åˆ«', currentUser.group); if (!group || !groups.includes(group)) return alert('æ— æ•ˆç»„åˆ«');
                    const users = getUsers();
                    if (users.some(u=>u.account===account)) return alert('è´¦å·å·²å­˜åœ¨');
                    users.push({ account, password: pwd, nickname, role: 'member', group, extraGroups: [] });
                    saveUsers(users);
                    refreshCurrentSection();
                });
            }

            // ä¿®å¤é€šçŸ¥æ¸²æŸ“ï¼šä¸ºæ‰€æœ‰å­—æ®µæä¾›é»˜è®¤å€¼ï¼Œé¿å…å› ç¼ºå°‘å­—æ®µå¯¼è‡´é¡µé¢ç™½å±
            function renderNotices(container) {
                const notices = getNotices();
                const canPub = canPublishNotice();
                let html = `<div class="card"><div class="card-header d-flex justify-content-between"><span><i class="bi bi-megaphone"></i> é€šçŸ¥å…¬å‘Š</span><span class="badge bg-warning">å‘å¸ƒ:é«˜çº§ç®¡ç†å‘˜åŠè€æ¿</span></div><div class="card-body">`;
                if (notices.length === 0) {
                    html += '<div class="text-muted">æš‚æ— å…¬å‘Š</div>';
                } else {
                    notices.forEach(n => {
                        // ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰é»˜è®¤å€¼ï¼Œé¿å… undefined å¯¼è‡´æ¸²æŸ“é”™è¯¯
                        const title = n.title || 'æ— æ ‡é¢˜';
                        const publisher = n.publisher || 'ç³»ç»Ÿ';
                        const time = n.time || '';
                        const content = n.content || '';
                        const topFlag = n.top ? '<span class="badge bg-info me-2">ç½®é¡¶</span>' : '';
                        const editBtn = canPub ? `<button class="btn btn-sm btn-outline-primary me-1 edit-notice" data-id="${n.id}">ç¼–è¾‘</button>` : '';
                        const deleteBtn = (canPub || n.publisher === currentUser?.nickname) ? `<button class="btn btn-sm btn-outline-danger delete-notice" data-id="${n.id}">åˆ é™¤</button>` : '';
                        html += `<div class="alert alert-secondary d-flex flex-wrap justify-content-between align-items-center" data-id="${n.id}">
                            <div style="flex:1"><div><strong>ğŸ“¢ ${title}</strong> <small>(${publisher} ${time})</small></div>
                            <div class="small text-muted" title="${content}">${content.length > 50 ? content.slice(0,50)+'â€¦' : content}</div></div>
                            <div>${topFlag}${editBtn}${deleteBtn}</div>
                        </div>`;
                    });
                }
                if (canPub) html += '<button class="btn btn-sm btn-danger mt-2" id="publishNoticeBtn">å‘å¸ƒæ–°é€šçŸ¥</button>';
                html += '</div></div>';
                container.innerHTML = html;
            }

            function renderSettings(container) {
                if (!isBoss()) { container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>'; return; }
                const groups = getGroups();
                container.innerHTML = `
                    <div class="card"><div class="card-header">âš™ï¸ è®¾ç½®ç®¡ç† Â· ä»…è€æ¿</div><div class="card-body">
                    <div class="row"><div class="col-md-4"><h6>æ¯å‘¨ç›®æ ‡å­—æ•°</h6><input id="globalTarget" class="form-control" value="28000"></div>
                    <div class="col-md-4"><h6>å®‰å…¨é€‰é¡¹</h6><div class="form-check"><input class="form-check-input" type="checkbox" checked> å¯ç”¨CSRF</div></div>
                    <div class="col-md-4"><h6>ç»„åˆ«ç®¡ç†</h6><p>å½“å‰ç»„åˆ«ï¼š${groups.join('ã€')}</p><button class="btn btn-outline-primary btn-sm" id="addGroupBtn">æ–°å¢ç»„åˆ«</button> <button class="btn btn-outline-secondary btn-sm" id="backupBtn">å¤‡ä»½æ•°æ®</button></div></div>
                    <button class="btn btn-primary mt-2" id="saveGlobalTarget">ä¿å­˜ç›®æ ‡</button></div></div>
                `;
            }

            // åˆå§‹åŒ–æ³¨å†Œä¸‹æ‹‰æ¡†
            function fillRegGroup() {
                const select = document.getElementById('regGroup');
                const groups = getGroups().filter(g => !ADMIN_GROUPS.includes(g));
                select.innerHTML = groups.map(g => `<option>${g}</option>`).join('');
            }
            fillRegGroup();

            // å¯åŠ¨æ—¶æ˜¾ç¤ºç™»å½•ç•Œé¢
            window.addEventListener('load', () => {
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            });
        })();
    </script>
</body>
</html>