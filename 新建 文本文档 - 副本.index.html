<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡è”ç½‘æ–‡ Â· å·¥ä½œå®¤å†…éƒ¨ç³»ç»Ÿï¼ˆè€æ¿æƒé™å…¨åŠŸèƒ½ç‰ˆï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https: 'unsafe-inline'; style-src 'self' https: 'unsafe-inline';">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #1e2a3a; color: #fff; }
        .sidebar a { color: #b0c4de; text-decoration: none; padding: 0.5rem 1rem; display: block; border-radius: 0.25rem; margin: 0.2rem 0; }
        .sidebar a:hover, .sidebar a.active { background: #2c3e50; color: #fff; }
        .content { padding: 2rem; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.05); border: none; margin-bottom: 1.5rem; }
        .login-container { max-width: 900px; margin: 3rem auto; }
        .login-card { border: none; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .permission-tag { background-color: #e2e6ea; color: #1e2a3a; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; margin-right: 0.2rem; display: inline-block; }
        .btn-permission { padding: 0.2rem 0.5rem; font-size: 0.7rem; margin: 2px; }
        .role-boss { background-color: #dc3545; color: white; }
        .role-admin { background-color: #0d6efd; color: white; }      /* é«˜çº§ç®¡ç†å‘˜ */
        .role-manager { background-color: #fd7e14; color: white; }    /* æ™®é€šç®¡ç†å‘˜ï¼ˆç»„é•¿ï¼‰ */
        .role-member { background-color: #6c757d; color: white; }
        .table-responsive { background: white; border-radius: 0.5rem; padding: 1rem; }
        .discuss-messages { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
        .msg-item { margin-bottom: 0.75rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; }
        .notification-badge { cursor: pointer; }
        .notification-list { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div id="loginContainer" class="container login-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ” ç™»å½•</h3>
                    <div class="mb-3">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="çº¯è‹±æ–‡">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="æ•°å­—+è‹±æ–‡">
                    </div>
                    <button class="btn btn-primary w-100" id="loginBtn">ç™»å½•</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card login-card p-4">
                    <h3 class="text-center mb-3">ğŸ“ æ³¨å†Œ</h3>
                    <div class="mb-2">
                        <label class="form-label">ç¬”å</label>
                        <input type="text" id="regNickname" class="form-control" placeholder="å¦‚ä½•ç§°å‘¼">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">è´¦å· <span class="text-muted">(çº¯è‹±æ–‡)</span></label>
                        <input type="text" id="regAccount" class="form-control" placeholder="ä¾‹å¦‚: qingya">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">å¯†ç  <span class="text-muted">(æ•°å­—+è‹±æ–‡)</span></label>
                        <input type="password" id="regPassword" class="form-control" placeholder="ä¾‹å¦‚: abc123">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirm" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸»ç»„åˆ« (åˆ›ä½œç»„)</label>
                        <select id="regGroup" class="form-select">
                            <!-- åŠ¨æ€ä»å­˜å‚¨åŠ è½½ -->
                        </select>
                    </div>
                    <button class="btn btn-success w-100" id="registerBtn">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="mt-3 small text-danger" id="regMessage"></div>
                </div>
            </div>
        </div>
        <div class="footer-text text-center mt-4">å®‰å…¨é˜²æŠ¤ Â· è´¦å·çº¯è‹±æ–‡ / å¯†ç æ•°å­—è‹±æ–‡ç»“åˆ</div>
    </div>

    <!-- ä¸»åº”ç”¨åŒºåŸŸ -->
    <div id="appContainer" class="container-fluid p-0 hidden">
        <div class="row g-0">
            <div class="col-md-2 sidebar p-3" id="sidebar"></div>
            <div class="col-md-10 content" id="mainContent"></div>
        </div>
    </div>

    <!-- ä½œå®¶å¹³å°é£æ ¼æŠ•ç¨¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="writerPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“ å‘å¸ƒæ–°ä½œå“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="postForm">
                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="postTitle" placeholder="ä¾‹å¦‚ï¼šé£å‡ä¹‹åç¬¬ä¸‰åä¸€ç« ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç®€ä»‹ / å¯¼è¯­</label>
                            <textarea class="form-control" id="postDescription" rows="2" placeholder="ç”¨å‡ å¥è¯å¸å¼•è¯»è€…..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ­£æ–‡ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="postContent" rows="8" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ­£æ–‡..."></textarea>
                            <div class="form-text mt-1">å­—æ•°ç»Ÿè®¡ï¼š<span id="wordCount">0</span> å­—ï¼ˆä»…ä¸­æ–‡å­—ç¬¦ï¼‰</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ‰€å±ç»„åˆ«</label>
                                <select class="form-select" id="postGroup">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-control" id="postTags" placeholder="ä»™ä¾ , çˆ½æ–‡">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="submitPostBtn">å‘å¸ƒæŠ•ç¨¿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç°ç”³è¯·æ¨¡æ€æ¡†ï¼ˆå¸¦è´¦å·ä¿¡æ¯ï¼‰ -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ’° ç”³è¯·æç°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3">
                            <label class="form-label">æç°é‡‘é¢</label>
                            <input type="number" class="form-control" id="withdrawAmount" min="1" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©æ”¶æ¬¾æ–¹å¼</label>
                            <select class="form-select" id="withdrawMethod">
                                <option value="å¾®ä¿¡">å¾®ä¿¡</option>
                                <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                                <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ”¶æ¬¾è´¦å·</label>
                            <input type="text" class="form-control" id="withdrawAccount" placeholder="å¾®ä¿¡å· / æ”¯ä»˜å®è´¦å· / é“¶è¡Œå¡å·" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control" id="withdrawNote">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" id="submitWithdrawBtn">æäº¤ç”³è¯·</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®¡é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“„ æ–‡æ¡ˆå®¡é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalPostInfo"></div>
                    <hr>
                    <h6>ğŸ“ æ–‡æ¡ˆå†…å®¹</h6>
                    <div id="modalContent" class="border p-3 bg-light" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                    <hr>
                    <h6>ğŸ’¬ å®¡é˜…æ‰¹å¤</h6>
                    <div id="modalReviews" class="mb-3"></div>
                    <div id="reviewInputArea" class="mt-2">
                        <textarea id="reviewComment" class="form-control" rows="2" placeholder="å†™ä¸‹ä½ çš„æ‰¹å¤..."></textarea>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" id="submitReviewApprove">é€šè¿‡</button>
                            <button class="btn btn-sm btn-warning" id="submitReviewReject">é€€å›</button>
                            <button class="btn btn-sm btn-secondary" id="submitReviewComment">ä»…è¯„è®º</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç»„åˆ«æ¨¡æ€æ¡†ï¼ˆä»…è€æ¿ï¼‰ -->
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">â• æ–°å¢ç»„åˆ«</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="newGroupName" placeholder="ç»„åˆ«åç§°ï¼ˆä¾‹å¦‚ï¼šè½»å°è¯´ï¼‰">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="submitAddGroup">æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== å…¨æ–°é‡æ„ä»£ç ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰====================
        (function() {
            // ---------- å­˜å‚¨é”® ----------
            const STORAGE_USERS = 'wanlian_users';
            const STORAGE_POSTS = 'wanlian_posts';
            const STORAGE_PROGRESS = 'wanlian_progress';
            const STORAGE_ROYALTIES = 'wanlian_royalties';
            const STORAGE_NOTICES = 'wanlian_notices';
            const STORAGE_DISCUSS = 'wanlian_discuss';
            const STORAGE_GROUPS = 'wanlian_groups';        // åŠ¨æ€ç»„åˆ«åˆ—è¡¨
            const STORAGE_WITHDRAWALS = 'wanlian_withdrawals'; // æç°ç”³è¯·
            const STORAGE_NOTIFICATIONS = 'wanlian_notifications'; // é€šçŸ¥

            // ---------- é»˜è®¤æ•°æ®åˆå§‹åŒ– ----------
            function initData() {
                // ç»„åˆ«ï¼šåˆå§‹åŒ…å«åˆ›ä½œç»„å’Œç®¡ç†ç»„ï¼Œåç»­å¯åŠ¨æ€å¢åŠ 
                if (!localStorage.getItem(STORAGE_GROUPS)) {
                    const defaultGroups = [
                        "ä¼ ç»Ÿä¿®ä»™", "å¼‚å¸¸æ¡£æ¡ˆ", "è§„åˆ™æ€ªè°ˆ", "ç³»ç»Ÿä¿®ä»™", "å›½è¿å‰¯æœ¬",
                        "çˆ½æ–‡ä¿®ä»™", "å¼‚èƒ½éƒ½å¸‚", "åæ´¾ä¿®ä»™", "å¼±ç³»ç»Ÿæµè­¦æ¢", "åç³»ç»Ÿå¼‚ä¸–ç•Œ", "æœ«ä¸–äº‰éœ¸",
                        "ç»¼åˆç®¡ç†ç»„", "å†…å®¹å®¡æ ¸ç»„", "é¡¹ç›®æ‰§è¡Œç»„"
                    ];
                    localStorage.setItem(STORAGE_GROUPS, JSON.stringify(defaultGroups));
                }

                // ç”¨æˆ·
                if (!localStorage.getItem(STORAGE_USERS)) {
                    const users = [
                        { account: 'laoban', password: '080415zqx', nickname: 'é‚¹ç§¦é›„', role: 'boss', group: 'ç»¼åˆç®¡ç†ç»„', extraGroups: [] },
                        { account: 'zonghe', password: 'abc123', nickname: 'å†³ç­–è€…', role: 'admin', group: 'ç»¼åˆç®¡ç†ç»„', extraGroups: [] },
                        { account: 'shenhe', password: 'abc123', nickname: 'å®¡æ ¸å®˜', role: 'admin', group: 'å†…å®¹å®¡æ ¸ç»„', extraGroups: [] },
                        { account: 'zhixing', password: 'abc123', nickname: 'æ‰§è¡Œè€…', role: 'admin', group: 'é¡¹ç›®æ‰§è¡Œç»„', extraGroups: [] },
                        { account: 'qingya', password: 'abc123', nickname: 'é’å´–', role: 'manager', group: 'ä¼ ç»Ÿä¿®ä»™', extraGroups: ['è§„åˆ™æ€ªè°ˆ'] },
                        { account: 'jingsong', password: 'abc123', nickname: 'æƒŠæ‚š', role: 'manager', group: 'è§„åˆ™æ€ªè°ˆ', extraGroups: [] },
                        { account: 'yunzhongzi', password: 'abc123', nickname: 'äº‘ä¸­å­', role: 'member', group: 'ä¼ ç»Ÿä¿®ä»™', extraGroups: [] },
                        { account: 'heimao', password: 'abc123', nickname: 'é»‘çŒ«', role: 'member', group: 'è§„åˆ™æ€ªè°ˆ', extraGroups: [] },
                        { account: 'feitu', password: 'abc123', nickname: 'åºŸåœŸ', role: 'member', group: 'æœ«ä¸–äº‰éœ¸', extraGroups: [] },
                        { account: 'yaolao', password: 'abc123', nickname: 'è¯è€', role: 'member', group: 'ä¼ ç»Ÿä¿®ä»™', extraGroups: [] },
                    ];
                    localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
                }

                // æŠ•ç¨¿
                if (!localStorage.getItem(STORAGE_POSTS)) {
                    const posts = [
                        { id: Date.now() + 1, group: 'ä¼ ç»Ÿä¿®ä»™', title: 'ã€Šé£å‡ä¹‹åã€‹ç¬¬30ç« ', author: 'é’å´–', time: '2025-03-12', words: 4120, content: 'è¿™é‡Œæ˜¯é£å‡ä¹‹åç¬¬ä¸‰åç« çš„æ­£æ–‡å†…å®¹â€¦â€¦', description: 'é£å‡ä¹‹åçš„ä¸–ç•Œ', tags: ['ä»™ä¾ '], reviews: [] },
                        { id: Date.now() + 2, group: 'è§„åˆ™æ€ªè°ˆ', title: 'ã€Šåˆ«ç†¬å¤œã€‹å‰¯æœ¬', author: 'é»‘çŒ«', time: '2025-03-12', words: 3870, content: 'åˆ«ç†¬å¤œçš„è§„åˆ™æ€ªè°ˆæ•…äº‹â€¦â€¦', description: '', tags: [], reviews: [] },
                    ];
                    localStorage.setItem(STORAGE_POSTS, JSON.stringify(posts));
                }

                // è€ƒæ ¸è¿›åº¦ï¼ˆåŸºäºç»„åˆ«åŠ¨æ€ç”Ÿæˆï¼‰
                if (!localStorage.getItem(STORAGE_PROGRESS)) {
                    const groups = JSON.parse(localStorage.getItem(STORAGE_GROUPS)) || [];
                    const progress = groups.map(g => ({
                        group: g, outlineDone: Math.random() > 0.3, weekWords: Math.floor(Math.random()*15000+10000), target: 28000
                    }));
                    localStorage.setItem(STORAGE_PROGRESS, JSON.stringify(progress));
                }

                // ç¨¿è´¹
                if (!localStorage.getItem(STORAGE_ROYALTIES)) {
                    const royalties = [
                        { id: 1, user: 'é’å´–', group: 'ä¼ ç»Ÿä¿®ä»™', amount: 1200, status: 'å·²å‘' },
                        { id: 2, user: 'é»‘çŒ«', group: 'è§„åˆ™æ€ªè°ˆ', amount: 850, status: 'å¾…ç¡®è®¤' },
                        { id: 3, user: 'åºŸåœŸ', group: 'æœ«ä¸–äº‰éœ¸', amount: 2300, status: 'æå–ä¸­' },
                    ];
                    localStorage.setItem(STORAGE_ROYALTIES, JSON.stringify(royalties));
                }

                // é€šçŸ¥
                if (!localStorage.getItem(STORAGE_NOTICES)) {
                    const notices = [
                        { id: 1, title: 'å…³äº3æœˆç¨¿è´¹å»¶è¿Ÿå‘æ”¾çš„é€šçŸ¥', publisher: 'é‚¹ç§¦é›„', role: 'boss', time: '2025-03-12', top: true },
                        { id: 2, title: 'ä¸‹å‘¨å„ç»„å¿…é¡»å®Œæˆå¤§çº²', publisher: 'é’å´–', role: 'manager', time: '2025-03-10', top: false },
                    ];
                    localStorage.setItem(STORAGE_NOTICES, JSON.stringify(notices));
                }

                // è®¨è®º
                if (!localStorage.getItem(STORAGE_DISCUSS)) {
                    const msgs = [
                        { group: 'ä¼ ç»Ÿä¿®ä»™', user: 'é’å´–', message: 'å¤§çº²ä»Šæ™šäº¤', time: new Date().toLocaleString() },
                        { group: 'ä¼ ç»Ÿä¿®ä»™', user: 'äº‘ä¸­å­', message: 'æ”¶åˆ°', time: new Date().toLocaleString() },
                    ];
                    localStorage.setItem(STORAGE_DISCUSS, JSON.stringify(msgs));
                }

                // æç°ç”³è¯·
                if (!localStorage.getItem(STORAGE_WITHDRAWALS)) {
                    localStorage.setItem(STORAGE_WITHDRAWALS, JSON.stringify([]));
                }

                // é€šçŸ¥ï¼ˆç”¨æˆ·é€šçŸ¥ï¼Œç”¨äºé€€å›/æç°æé†’ï¼‰
                if (!localStorage.getItem(STORAGE_NOTIFICATIONS)) {
                    localStorage.setItem(STORAGE_NOTIFICATIONS, JSON.stringify([]));
                }
            }
            initData();

            // ---------- å…¨å±€å˜é‡ ----------
            let currentUser = null;
            let activeSection = 'dashboard';

            // è¾…åŠ©å‡½æ•°
            function getUsers() { return JSON.parse(localStorage.getItem(STORAGE_USERS)) || []; }
            function saveUsers(users) { localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
            function getPosts() { return JSON.parse(localStorage.getItem(STORAGE_POSTS)) || []; }
            function savePosts(posts) { localStorage.setItem(STORAGE_POSTS, JSON.stringify(posts)); }
            function getProgress() { return JSON.parse(localStorage.getItem(STORAGE_PROGRESS)) || []; }
            function saveProgress(prog) { localStorage.setItem(STORAGE_PROGRESS, JSON.stringify(prog)); }
            function getRoyalties() { return JSON.parse(localStorage.getItem(STORAGE_ROYALTIES)) || []; }
            function saveRoyalties(r) { localStorage.setItem(STORAGE_ROYALTIES, JSON.stringify(r)); }
            function getNotices() { return JSON.parse(localStorage.getItem(STORAGE_NOTICES)) || []; }
            function saveNotices(n) { localStorage.setItem(STORAGE_NOTICES, JSON.stringify(n)); }
            function getDiscuss() { return JSON.parse(localStorage.getItem(STORAGE_DISCUSS)) || []; }
            function saveDiscuss(d) { localStorage.setItem(STORAGE_DISCUSS, JSON.stringify(d)); }
            function getGroups() { return JSON.parse(localStorage.getItem(STORAGE_GROUPS)) || []; }
            function saveGroups(g) { localStorage.setItem(STORAGE_GROUPS, JSON.stringify(g)); }
            function getWithdrawals() { return JSON.parse(localStorage.getItem(STORAGE_WITHDRAWALS)) || []; }
            function saveWithdrawals(w) { localStorage.setItem(STORAGE_WITHDRAWALS, JSON.stringify(w)); }
            function getNotifications() { return JSON.parse(localStorage.getItem(STORAGE_NOTIFICATIONS)) || []; }
            function saveNotifications(n) { localStorage.setItem(STORAGE_NOTIFICATIONS, JSON.stringify(n)); }

            // æƒé™åˆ¤æ–­
            function isBoss() { return currentUser && currentUser.role === 'boss'; }
            function isAdmin() { return currentUser && currentUser.role === 'admin'; }      // é«˜çº§ç®¡ç†å‘˜
            function isManager() { return currentUser && currentUser.role === 'manager'; }  // æ™®é€šç®¡ç†å‘˜
            function isMember() { return currentUser && currentUser.role === 'member'; }
            function isAdminOrBoss() { return isAdmin() || isBoss(); }
            function isManagerOrAbove() { return isManager() || isAdminOrBoss(); }
            function canViewAllGroups() { return isManagerOrAbove(); }
            function canManageAllGroups() { return isAdminOrBoss(); }  // é«˜çº§ç®¡ç†å‘˜å’Œè€æ¿å¯è·¨ç»„
            function canPromote() { return isBoss(); }                 // åªæœ‰è€æ¿å¯ä»¥ææ‹”/é™çº§
            function canAccessSettings() { return isBoss(); }          // åªæœ‰è€æ¿è®¿é—®è®¾ç½®
            function canManageGroups() { return isBoss(); }            // åªæœ‰è€æ¿å¢åˆ ç»„åˆ«
            function canApproveWithdrawals() { return isAdminOrBoss(); } // é«˜çº§ç®¡ç†å‘˜å’Œè€æ¿å¯å®¡æ ¸æç°

            // åˆ·æ–°å½“å‰è§†å›¾
            function refreshCurrentSection() { renderSection(activeSection); }

            // æ·»åŠ é€šçŸ¥ï¼ˆç”¨æˆ·é€šçŸ¥ï¼‰
            function addNotification(targetUser, message) {
                const notifs = getNotifications();
                notifs.push({
                    id: Date.now(),
                    targetUser,
                    message,
                    time: new Date().toLocaleString(),
                    read: false
                });
                saveNotifications(notifs);
            }

            // æ¸²æŸ“åº”ç”¨ä¸»ç•Œé¢
            function renderApp() {
                const sidebar = document.getElementById('sidebar');
                const roleMap = { boss: 'è€æ¿', admin: 'é«˜çº§ç®¡ç†å‘˜', manager: 'æ™®é€šç®¡ç†å‘˜', member: 'æˆå‘˜' };
                const roleClassMap = { boss: 'role-boss', admin: 'role-admin', manager: 'role-manager', member: 'role-member' };

                sidebar.innerHTML = `
                    <h4 class="text-center mb-4 text-light">ğŸ“š ä¸‡è”ç½‘æ–‡</h4>
                    <div class="mb-3 text-white-50 small">æ¬¢è¿ï¼Œ<strong>${currentUser.nickname}</strong> 
                        <span class="badge ${roleClassMap[currentUser.role]}">${roleMap[currentUser.role]}</span>
                    </div>
                    <nav>
                        <a href="#" class="nav-link ${activeSection === 'dashboard' ? 'active' : ''}" data-section="dashboard"><i class="bi bi-speedometer2"></i> ä»ªè¡¨ç›˜</a>
                        <a href="#" class="nav-link ${activeSection === 'posts' ? 'active' : ''}" data-section="posts"><i class="bi bi-pencil-square"></i> æŠ•ç¨¿ç®¡ç†</a>
                        <a href="#" class="nav-link ${activeSection === 'groupPanel' ? 'active' : ''}" data-section="groupPanel"><i class="bi bi-people"></i> æˆ‘çš„ç»„ (${currentUser.group})</a>
                        <a href="#" class="nav-link ${activeSection === 'discuss' ? 'active' : ''}" data-section="discuss"><i class="bi bi-chat-dots"></i> ç»„å†…äº¤æµåŒº</a>
                        <a href="#" class="nav-link ${activeSection === 'progress' ? 'active' : ''}" data-section="progress"><i class="bi bi-bar-chart"></i> è€ƒæ ¸è¿›åº¦</a>
                        <a href="#" class="nav-link ${activeSection === 'royalty' ? 'active' : ''}" data-section="royalty"><i class="bi bi-cash-stack"></i> ç¨¿è´¹/æå–</a>
                        <a href="#" class="nav-link ${activeSection === 'members' ? 'active' : ''}" data-section="members"><i class="bi bi-person-lines-fill"></i> äººå‘˜åå•</a>
                        <a href="#" class="nav-link ${activeSection === 'notices' ? 'active' : ''}" data-section="notices"><i class="bi bi-megaphone"></i> é€šçŸ¥å…¬å‘Š</a>
                        ${canAccessSettings() ? '<a href="#" class="nav-link '+(activeSection === 'settings' ? 'active' : '')+'" data-section="settings"><i class="bi bi-gear"></i> è®¾ç½®ç®¡ç†</a>' : ''}
                        <hr class="bg-secondary">
                        <a href="#" id="logoutBtnSide"><i class="bi bi-box-arrow-right"></i> é€€å‡º</a>
                    </nav>
                `;

                sidebar.querySelectorAll('nav a[data-section]').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = a.dataset.section;
                        activeSection = section;
                        sidebar.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
                        a.classList.add('active');
                        renderSection(section);
                    });
                });

                document.getElementById('logoutBtnSide').addEventListener('click', (e) => {
                    e.preventDefault();
                    currentUser = null;
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('appContainer').classList.add('hidden');
                });

                renderSection(activeSection);
            }

            function renderSection(section) {
                const main = document.getElementById('mainContent');
                activeSection = section;
                switch(section) {
                    case 'dashboard': renderDashboard(main); break;
                    case 'posts': renderPosts(main); break;
                    case 'groupPanel': renderGroupPanel(main); break;
                    case 'discuss': renderDiscuss(main); break;
                    case 'progress': renderProgress(main); break;
                    case 'royalty': renderRoyalty(main); break;
                    case 'members': renderMembers(main); break;
                    case 'notices': renderNotices(main); break;
                    case 'settings': renderSettings(main); break;
                    default: renderDashboard(main);
                }
            }

            // ---------- ä»ªè¡¨ç›˜ï¼ˆé›†æˆé€šçŸ¥åŒºåŸŸï¼‰----------
            function renderDashboard(container) {
                const posts = getPosts();
                const users = getUsers();
                const royalties = getRoyalties();
                const withdrawals = getWithdrawals();
                const totalPosts = posts.length;
                const totalWords = posts.reduce((acc, p) => acc + p.words, 0);
                const pendingRoyalties = royalties.filter(r => r.status !== 'å·²å‘').length;
                const pendingWithdrawals = withdrawals.filter(w => w.status === 'å¾…å¤„ç†').length;

                // å½“å‰ç”¨æˆ·æœªè¯»é€šçŸ¥
                const userNotifs = getNotifications().filter(n => n.targetUser === currentUser.nickname && !n.read);

                let notifHtml = '';
                if (userNotifs.length > 0) {
                    notifHtml = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="bi bi-bell"></i> æ‚¨æœ‰ <strong>${userNotifs.length}</strong> æ¡æœªè¯»é€šçŸ¥
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            <div class="mt-2 notification-list">
                                ${userNotifs.map(n => `
                                    <div class="border-bottom pb-1 mb-1">
                                        <i class="bi bi-envelope"></i> ${n.message} <small class="text-muted">${n.time}</small>
                                        <button class="btn btn-sm btn-outline-primary mark-read float-end" data-id="${n.id}">æ ‡ä¸ºå·²è¯»</button>
                                    </div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="bi bi-shield-check"></i> å®‰å…¨é˜²æŠ¤å·²å¯ç”¨
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    ${notifHtml}
                    <div class="row">
                        <div class="col-12"><h2>ğŸ“‹ ä»ªè¡¨ç›˜</h2><p class="text-secondary">æœ¬å‘¨æ€»ä½“è¿›åº¦ | ç¨¿è´¹å¾…å¤„ç†: ${pendingRoyalties}ç¬” | æç°å¾…å®¡æ ¸: ${pendingWithdrawals}</p></div>
                        <div class="col-md-3"><div class="card text-white bg-primary"><div class="card-body"><h5 class="card-title">æ€»æŠ•ç¨¿</h5><p class="display-6">${totalPosts}</p></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-success"><div class="card-body"><h5 class="card-title">å®Œæˆå­—æ•° (ä¸‡)</h5><p class="display-6">${(totalWords/10000).toFixed(1)}</p></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-warning"><div class="card-body"><h5 class="card-title">å¾…å‘ç¨¿è´¹</h5><p class="display-6">Â¥${royalties.filter(r => r.status!=='å·²å‘').reduce((s,r)=>s+r.amount,0)}</p></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-danger"><div class="card-body"><h5 class="card-title">æˆå‘˜æ€»æ•°</h5><p class="display-6">${users.length}</p></div></div></div>
                    </div>
                `;

                // æ ‡è®°å·²è¯»äº‹ä»¶
                container.querySelectorAll('.mark-read').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.dataset.id;
                        let notifs = getNotifications();
                        const idx = notifs.findIndex(n => n.id == id);
                        if (idx !== -1) notifs[idx].read = true;
                        saveNotifications(notifs);
                        refreshCurrentSection();
                    });
                });
            }

            // ---------- æŠ•ç¨¿ç®¡ç†ï¼ˆä½œå®¶å¹³å°é£æ ¼ï¼‰----------
            function renderPosts(container) {
                const posts = getPosts();
                const canViewAll = canViewAllGroups();
                let filteredPosts = canViewAll ? posts : posts.filter(p => p.group === currentUser.group || (currentUser.extraGroups || []).includes(p.group));

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between">
                            <span>ğŸ“ ${canViewAll ? 'å…¨éƒ¨æŠ•ç¨¿' : 'æœ¬ç»„æŠ•ç¨¿'}</span>
                            <span class="badge bg-secondary">${canViewAll ? 'æ‰€æœ‰ç»„' : currentUser.group}</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>ç»„åˆ«</th><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>æŠ•ç¨¿æ—¶é—´</th><th>å­—æ•°</th><th>æ“ä½œ</th></tr></thead>
                                    <tbody>
                                        ${filteredPosts.map(p => `<tr><td>${p.group}</td><td>${p.title}</td><td>${p.author}</td><td>${p.time}</td><td>${p.words}</td><td><i class="bi bi-eye btn btn-sm btn-outline-secondary view-post" data-id="${p.id}"></i> å®¡é˜…</td></tr>`).join('')}
                                        ${filteredPosts.length === 0 ? '<tr><td colspan="6" class="text-center text-muted">æš‚æ— æŠ•ç¨¿</td></tr>' : ''}
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" id="newPostBtn">+ æ–°æŠ•ç¨¿</button>
                        </div>
                    </div>
                `;

                // æ–°æŠ•ç¨¿æŒ‰é’®ï¼šæ‰“å¼€è‡ªå®šä¹‰æ¨¡æ€æ¡†
                document.getElementById('newPostBtn')?.addEventListener('click', () => {
                    const groupSelect = document.getElementById('postGroup');
                    const groups = getGroups();
                    groupSelect.innerHTML = '';
                    groups.forEach(g => {
                        const option = document.createElement('option');
                        option.value = g;
                        option.textContent = g;
                        if (currentUser && g === currentUser.group) option.selected = true;
                        groupSelect.appendChild(option);
                    });
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postDescription').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postTags').value = '';
                    document.getElementById('wordCount').innerText = '0';
                    new bootstrap.Modal(document.getElementById('writerPostModal')).show();
                });

                // å®¡é˜…æŒ‰é’®
                container.querySelectorAll('.view-post').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const postId = btn.dataset.id;
                        const post = getPosts().find(p => p.id == postId);
                        if (!post) return;
                        // å¡«å……æ¨¡æ€æ¡†
                        document.getElementById('modalPostInfo').innerHTML = `<h6>${post.title}  by ${post.author} (${post.group}) å­—æ•°:${post.words}</h6>`;
                        document.getElementById('modalContent').innerText = post.content || 'ï¼ˆæ— æ–‡æ¡ˆå†…å®¹ï¼‰';
                        const reviewsDiv = document.getElementById('modalReviews');
                        reviewsDiv.innerHTML = '';
                        if (post.reviews && post.reviews.length) {
                            post.reviews.forEach(r => {
                                const badge = r.action === 'é€šè¿‡' ? 'bg-success' : (r.action === 'é€€å›' ? 'bg-danger' : 'bg-secondary');
                                reviewsDiv.innerHTML += `<div class="border p-2 mb-2"><span class="badge ${badge}">${r.action}</span> <strong>${r.reviewer}</strong>: ${r.comment} <small class="text-muted">${r.time}</small></div>`;
                            });
                        } else {
                            reviewsDiv.innerHTML = '<p class="text-muted">æš‚æ— æ‰¹å¤</p>';
                        }
                        document.getElementById('reviewInputArea').style.display = isManagerOrAbove() ? 'block' : 'none';
                        document.getElementById('reviewModal').dataset.postId = postId;
                        new bootstrap.Modal(document.getElementById('reviewModal')).show();
                    });
                });
            }

            // æäº¤æŠ•ç¨¿
            document.getElementById('submitPostBtn')?.addEventListener('click', () => {
                const title = document.getElementById('postTitle').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const group = document.getElementById('postGroup').value;
                const description = document.getElementById('postDescription').value.trim();
                const tags = document.getElementById('postTags').value.split(',').map(s => s.trim()).filter(s => s);
                if (!title || !content) { alert('æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º'); return; }
                const words = content.replace(/[^\u4e00-\u9fa5]/g, '').length;
                if (words === 0) { alert('æ­£æ–‡ä¸­è‡³å°‘éœ€è¦åŒ…å«ä¸­æ–‡å­—ç¬¦'); return; }

                const posts = getPosts();
                const newPost = {
                    id: Date.now(),
                    group, title, author: currentUser.nickname,
                    time: new Date().toISOString().slice(0,10),
                    words, content, description, tags,
                    reviews: []
                };
                posts.push(newPost);
                savePosts(posts);

                // æ›´æ–°è¿›åº¦
                const progress = getProgress();
                const progItem = progress.find(p => p.group === group);
                if (progItem) {
                    progItem.weekWords += words;
                    saveProgress(progress);
                }

                bootstrap.Modal.getInstance(document.getElementById('writerPostModal')).hide();
                refreshCurrentSection();
            });

            // å®¡é˜…æ‰¹å¤
            function addReview(action) {
                const modalEl = document.getElementById('reviewModal');
                const postId = modalEl.dataset.postId;
                if (!postId) return;
                const comment = document.getElementById('reviewComment').value.trim();
                if (!comment && action !== 'è¯„è®º') { alert('è¯·å¡«å†™æ‰¹å¤å†…å®¹'); return; }
                const posts = getPosts();
                const post = posts.find(p => p.id == postId);
                if (!post) return;
                if (!post.reviews) post.reviews = [];
                post.reviews.push({
                    reviewer: currentUser.nickname,
                    action: action,
                    comment: comment || 'ï¼ˆæ— å†…å®¹ï¼‰',
                    time: new Date().toLocaleString()
                });
                savePosts(posts);

                if (action === 'é€€å›') {
                    addNotification(post.author, `æ‚¨çš„ç¨¿ä»¶ã€Š${post.title}ã€‹è¢«é€€å›ã€‚æ‰¹å¤ï¼š${comment || 'æ— '}`);
                }
                bootstrap.Modal.getInstance(modalEl).hide();
                refreshCurrentSection();
            }
            document.getElementById('submitReviewApprove')?.addEventListener('click', () => addReview('é€šè¿‡'));
            document.getElementById('submitReviewReject')?.addEventListener('click', () => addReview('é€€å›'));
            document.getElementById('submitReviewComment')?.addEventListener('click', () => addReview('è¯„è®º'));

            // æˆ‘çš„ç»„ (ç®€ç•¥)
            function renderGroupPanel(container) {
                const posts = getPosts().filter(p => p.group === currentUser.group);
                container.innerHTML = `
                    <div class="card"><div class="card-header bg-white fw-bold">ğŸ§˜ ${currentUser.group} Â· æœ¬ç»„æŠ•ç¨¿</div>
                    <div class="card-body"><ul class="list-group">${posts.map(p => `<li class="list-group-item d-flex justify-content-between">${p.title} ä½œè€…: ${p.author} <span>${p.words}å­—</span></li>`).join('')}${posts.length === 0 ? '<li class="list-group-item text-center text-muted">æš‚æ— æœ¬ç»„æŠ•ç¨¿</li>' : ''}</ul></div></div>
                `;
            }

            // äº¤æµåŒº
            function renderDiscuss(container) {
                const group = currentUser.group;
                let msgs = getDiscuss().filter(m => m.group === group);
                container.innerHTML = `
                    <div class="card"><div class="card-header bg-white fw-bold">ğŸ’¬ ${group} Â· äº¤æµåŒº</div>
                    <div class="card-body discuss-messages" id="discussMsgContainer">${msgs.map(m => `<div class="msg-item" data-msg-time="${m.time}"><strong>${m.user}:</strong> ${m.message} <small class="text-muted float-end">${m.time}</small></div>`).join('')}${msgs.length === 0 ? '<div class="text-muted">æš‚æ— æ¶ˆæ¯</div>' : ''}</div>
                    <div class="card-footer bg-white d-flex gap-2"><input type="text" id="discussInput" class="form-control form-control-sm" placeholder="å‘è¨€..."><button class="btn btn-sm btn-primary" id="sendDiscussBtn">å‘é€</button></div></div>
                `;
                document.getElementById('sendDiscussBtn')?.addEventListener('click', () => {
                    const text = document.getElementById('discussInput').value.trim();
                    if (!text) return;
                    const discuss = getDiscuss();
                    discuss.push({ group: currentUser.group, user: currentUser.nickname, message: text, time: new Date().toLocaleString() });
                    saveDiscuss(discuss);
                    refreshCurrentSection();
                });
            }

            // è€ƒæ ¸è¿›åº¦
            function renderProgress(container) {
                let progress = getProgress();
                const canViewAll = canViewAllGroups();
                let filtered = canViewAll ? progress : progress.filter(p => p.group === currentUser.group);
                container.innerHTML = `
                    <div class="card"><div class="card-header bg-white fw-bold">ğŸ“Š è€ƒæ ¸è¿›åº¦ Â· æœ¬å‘¨ (ç›®æ ‡28000å­—/ç»„) ${canViewAll ? '<span class="badge bg-info">ç®¡ç†å‘˜å¯ç¼–è¾‘</span>' : ''}</div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead><tr><th>ç»„åˆ«</th><th>å¤§çº²å®Œæˆ</th><th>æœ¬å‘¨å·²å†™å­—æ•°</th><th>ç›®æ ‡</th><th>è¿›åº¦</th>${canViewAll ? '<th>æ“ä½œ</th>' : ''}</tr></thead><tbody>
                        ${filtered.map(p => {
                            const percent = Math.min(100, Math.round(p.weekWords/p.target*100));
                            return `<tr><td>${p.group}</td><td>${p.outlineDone ? 'âœ…' : 'â³'}</td><td>${p.weekWords}</td><td>${p.target}</td><td><div class="progress"><div class="progress-bar" style="width:${percent}%">${percent}%</div></div></td>${canViewAll ? `<td><button class="btn btn-sm btn-outline-secondary edit-progress" data-group="${p.group}">ç¼–è¾‘</button></td>` : ''}</tr>`;
                        }).join('')}
                    </tbody></table></div></div></div>
                `;
                if (canViewAll) {
                    container.querySelectorAll('.edit-progress').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const group = btn.dataset.group;
                            let prog = getProgress();
                            let item = prog.find(p => p.group === group);
                            if (!item) return;
                            const newWords = prompt('ä¿®æ”¹æœ¬å‘¨å­—æ•°', item.weekWords);
                            if (newWords && !isNaN(newWords)) item.weekWords = parseInt(newWords);
                            const outline = confirm('å¤§çº²å·²å®Œæˆï¼Ÿç‚¹å‡»ç¡®å®šä»£è¡¨âœ…ï¼Œå–æ¶ˆä»£è¡¨â³');
                            item.outlineDone = outline;
                            saveProgress(prog);
                            refreshCurrentSection();
                        });
                    });
                }
            }

            // ç¨¿è´¹/æå–ï¼ˆå¢å¼ºï¼šæç°ç”³è¯·å¸¦è´¦å·ï¼Œæœˆåº¦æµæ°´ç»Ÿè®¡ï¼‰
            function renderRoyalty(container) {
                const royalties = getRoyalties();
                const withdrawals = getWithdrawals();
                const userRoyalties = royalties.filter(r => isManagerOrAbove() ? true : r.user === currentUser.nickname);
                // è®¡ç®—æœˆåº¦æµæ°´ï¼ˆå½“å‰æœˆï¼‰
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const monthlyWithdrawals = withdrawals.filter(w => w.status === 'å·²é€šè¿‡' && w.time.startsWith(currentMonth));
                const totalMonthly = monthlyWithdrawals.reduce((sum, w) => sum + w.amount, 0);

                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white fw-bold d-flex justify-content-between">
                                    <span>ğŸ’° ç¨¿è´¹è®°å½•</span>
                                    ${isManagerOrAbove() ? '<button class="btn btn-sm btn-primary" id="newRoyaltyBtn">+ å‘æ”¾æ–°ç¨¿è´¹</button>' : ''}
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="royaltyList">
                                        ${userRoyalties.map(r => `
                                            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="${r.id}">
                                                <span><strong>${r.user}</strong> Â· ${r.group}  Â¥${r.amount}</span>
                                                <span class="badge ${r.status === 'å·²å‘' ? 'bg-success' : (r.status==='å¾…ç¡®è®¤'?'bg-warning':'bg-secondary')}">${r.status}</span>
                                                <span class="btn-group btn-group-sm">
                                                    ${isManagerOrAbove() ? '<button class="btn btn-outline-success btn-sm edit-status" data-id="'+r.id+'">æ”¹çŠ¶æ€</button>' : ''}
                                                    ${isManagerOrAbove() ? '<button class="btn btn-outline-danger btn-sm delete-royalty" data-id="'+r.id+'">åˆ é™¤</button>' : ''}
                                                </span>
                                            </li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white fw-bold">ğŸ’³ æç°ç”³è¯·</div>
                                <div class="card-body">
                                    <p>æœˆåº¦æµæ°´ï¼ˆå·²é€šè¿‡ï¼‰ï¼š<strong>Â¥ ${totalMonthly}</strong> (${currentMonth})</p>
                                    <button class="btn btn-sm btn-success" id="newWithdrawBtn">ç”³è¯·æç°</button>
                                    <hr>
                                    <h6>å†å²æç°è®°å½•</h6>
                                    <ul class="list-group" style="max-height:200px; overflow-y:auto">
                                        ${withdrawals.filter(w => w.user === currentUser.nickname || isManagerOrAbove()).map(w => `
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>${w.user} Â¥${w.amount} (${w.method}: ${w.account})</span>
                                                <span class="badge ${w.status === 'å·²é€šè¿‡' ? 'bg-success' : (w.status==='å·²æ‹’ç»'?'bg-danger':'bg-warning')}">${w.status}</span>
                                                ${canApproveWithdrawals() && w.status === 'å¾…å¤„ç†' ? `
                                                    <span>
                                                        <button class="btn btn-sm btn-success approve-withdraw" data-id="${w.id}">é€šè¿‡</button>
                                                        <button class="btn btn-sm btn-danger reject-withdraw" data-id="${w.id}">æ‹’ç»</button>
                                                    </span>` : ''}
                                            </li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('newRoyaltyBtn')?.addEventListener('click', () => {
                    const user = prompt('è¾“å…¥æˆå‘˜ç¬”å', currentUser.nickname);
                    if (!user) return;
                    const amount = parseFloat(prompt('é‡‘é¢', '500'));
                    if (amount <= 0) return;
                    const group = prompt('ç»„åˆ«', currentUser.group) || currentUser.group;
                    const royalties = getRoyalties();
                    royalties.push({ id: Date.now(), user, group, amount, status: 'å¾…ç¡®è®¤' });
                    saveRoyalties(royalties);
                    refreshCurrentSection();
                });

                document.getElementById('newWithdrawBtn')?.addEventListener('click', () => {
                    // æ˜¾ç¤ºæç°æ¨¡æ€æ¡†
                    new bootstrap.Modal(document.getElementById('withdrawModal')).show();
                });

                // æäº¤æç°ç”³è¯·
                document.getElementById('submitWithdrawBtn')?.addEventListener('click', () => {
                    const amount = parseFloat(document.getElementById('withdrawAmount').value);
                    const method = document.getElementById('withdrawMethod').value;
                    const account = document.getElementById('withdrawAccount').value.trim();
                    const note = document.getElementById('withdrawNote').value.trim();
                    if (!amount || amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
                    if (!account) { alert('è¯·è¾“å…¥æ”¶æ¬¾è´¦å·'); return; }
                    const withdrawals = getWithdrawals();
                    const newW = {
                        id: Date.now(),
                        user: currentUser.nickname,
                        amount,
                        method,
                        account,
                        note,
                        time: new Date().toLocaleString(),
                        status: 'å¾…å¤„ç†'
                    };
                    withdrawals.push(newW);
                    saveWithdrawals(withdrawals);
                    // é€šçŸ¥è€æ¿å’Œé«˜çº§ç®¡ç†å‘˜
                    const users = getUsers();
                    users.filter(u => u.role === 'boss' || u.role === 'admin').forEach(admin => {
                        addNotification(admin.nickname, `ç”¨æˆ· ${currentUser.nickname} æäº¤äº† Â¥${amount} çš„æç°ç”³è¯·ã€‚`);
                    });
                    bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                    refreshCurrentSection();
                });

                // å®¡æ ¸æç°
                container.querySelectorAll('.approve-withdraw').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        let ws = getWithdrawals();
                        const w = ws.find(w => w.id == id);
                        if (w) w.status = 'å·²é€šè¿‡';
                        saveWithdrawals(ws);
                        addNotification(w.user, `æ‚¨çš„æç°ç”³è¯· Â¥${w.amount} å·²é€šè¿‡å®¡æ ¸ã€‚`);
                        refreshCurrentSection();
                    });
                });
                container.querySelectorAll('.reject-withdraw').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        let ws = getWithdrawals();
                        const w = ws.find(w => w.id == id);
                        if (w) w.status = 'å·²æ‹’ç»';
                        saveWithdrawals(ws);
                        addNotification(w.user, `æ‚¨çš„æç°ç”³è¯· Â¥${w.amount} å·²è¢«æ‹’ç»ã€‚`);
                        refreshCurrentSection();
                    });
                });

                // ç¨¿è´¹çŠ¶æ€ä¿®æ”¹/åˆ é™¤
                container.querySelectorAll('.edit-status').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.dataset.id;
                        let rs = getRoyalties();
                        const r = rs.find(r => r.id == id);
                        if (!r) return;
                        const newStatus = prompt('è¾“å…¥æ–°çŠ¶æ€ï¼šå·²å‘ / å¾…ç¡®è®¤ / æå–ä¸­', r.status);
                        if (newStatus && ['å·²å‘', 'å¾…ç¡®è®¤', 'æå–ä¸­'].includes(newStatus)) {
                            r.status = newStatus;
                            saveRoyalties(rs);
                            refreshCurrentSection();
                        }
                    });
                });
                container.querySelectorAll('.delete-royalty').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.dataset.id;
                        if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                        let rs = getRoyalties();
                        rs = rs.filter(r => r.id != id);
                        saveRoyalties(rs);
                        refreshCurrentSection();
                    });
                });
            }

            // äººå‘˜åå•ï¼ˆå¢å¼ºï¼šè€æ¿å¯è®¾ç½®ç®¡ç†å‘˜ï¼‰
            function renderMembers(container) {
                const users = getUsers();
                const groups = getGroups();
                const canManage = isManagerOrAbove();
                const canManageAll = canManageAllGroups();
                const isBossUser = isBoss();

                let tabsHtml = '<ul class="nav nav-tabs" id="groupTabs">';
                groups.forEach((g, idx) => {
                    tabsHtml += `<li class="nav-item"><button class="nav-link ${idx===0?'active':''}" data-bs-toggle="tab" data-bs-target="#group${idx}">${g}</button></li>`;
                });
                tabsHtml += '</ul><div class="tab-content mt-3">';

                groups.forEach((g, idx) => {
                    const membersInGroup = users.filter(u => u.group === g);
                    tabsHtml += `<div class="tab-pane fade ${idx===0?'show active':''}" id="group${idx}">`;
                    tabsHtml += `<table class="table table-sm align-middle"><thead><tr><th>å§“å</th><th>è´¦å·</th><th>ä¸»ç»„åˆ«</th><th>å…¼ä»»ç»„</th><th>è§’è‰²</th>${canManage ? '<th>æ“ä½œ</th>' : ''}</tr></thead><tbody>`;

                    membersInGroup.forEach(u => {
                        const roleMap = { boss: 'è€æ¿', admin: 'é«˜çº§ç®¡ç†å‘˜', manager: 'æ™®é€šç®¡ç†å‘˜', member: 'æˆå‘˜' };
                        const roleClassMap = { boss: 'role-boss', admin: 'role-admin', manager: 'role-manager', member: 'role-member' };
                        const extraGroups = u.extraGroups ? u.extraGroups.join(', ') : '';

                        tabsHtml += `<tr>
                            <td>${u.nickname}</td>
                            <td>${u.account}</td>
                            <td><span class="badge bg-primary">${u.group}</span></td>
                            <td>${extraGroups}</td>
                            <td><span class="badge ${roleClassMap[u.role]}">${roleMap[u.role]}</span></td>`;

                        if (canManage && u.account !== currentUser.account) {
                            tabsHtml += `<td>`;
                            if ((canManageAll) || (currentUser.role === 'manager' && u.group === currentUser.group)) {
                                tabsHtml += `<button class="btn btn-outline-secondary btn-permission change-group" data-account="${u.account}">æ¢ç»„</button>
                                             <button class="btn btn-outline-info btn-permission add-group" data-account="${u.account}">åŠ ç»„</button>`;
                            }
                            if (isBossUser) {
                                // è€æ¿å¯ä»¥è®¾ç½®è§’è‰²ï¼šæˆå‘˜ -> æ™®é€šç®¡ç†å‘˜ï¼Œæ™®é€šç®¡ç†å‘˜ -> é«˜çº§ç®¡ç†å‘˜ï¼Œé«˜çº§ç®¡ç†å‘˜ -> æˆå‘˜ç­‰
                                if (u.role === 'member') {
                                    tabsHtml += `<button class="btn btn-outline-warning btn-permission set-manager" data-account="${u.account}">è®¾ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                } else if (u.role === 'manager') {
                                    tabsHtml += `<button class="btn btn-outline-primary btn-permission set-admin" data-account="${u.account}">è®¾ä¸ºé«˜çº§ç®¡ç†å‘˜</button>`;
                                    tabsHtml += `<button class="btn btn-outline-danger btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                } else if (u.role === 'admin') {
                                    tabsHtml += `<button class="btn btn-outline-danger btn-permission demote-manager" data-account="${u.account}">é™ä¸ºæ™®é€šç®¡ç†å‘˜</button>`;
                                    tabsHtml += `<button class="btn btn-outline-secondary btn-permission demote-member" data-account="${u.account}">é™ä¸ºæˆå‘˜</button>`;
                                }
                            }
                            tabsHtml += `</td>`;
                        } else if (canManage && u.account === currentUser.account) {
                            tabsHtml += '<td><span class="text-muted">è‡ªå·±</span></td>';
                        } else {
                            tabsHtml += '<td></td>';
                        }
                        tabsHtml += `</tr>`;
                    });

                    tabsHtml += membersInGroup.length===0 ? '<tr><td colspan="6" class="text-center text-muted">è¯¥ç»„æš‚æ— æˆå‘˜</td></tr>' : '';
                    tabsHtml += '</tbody></table></div>';
                });
                tabsHtml += '</div>';
                tabsHtml += `<div class="mt-2">${canManage ? '<button class="btn btn-sm btn-success" id="addMemberBtn">+ æ–°å¢æˆå‘˜</button>' : ''}</div>`;

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between">
                            <span><i class="bi bi-people"></i> äººå‘˜åå• Â· å…±${groups.length}ç»„</span>
                        </div>
                        <div class="card-body">
                            ${tabsHtml}
                            <p class="text-muted small mt-2"><i class="bi bi-info-circle"></i> æ¢ç»„/åŠ ç»„: ç®¡ç†å‘˜å¯æ“ä½œæœ¬ç»„ï¼Œé«˜çº§ç®¡ç†å‘˜å’Œè€æ¿å¯è·¨ç»„ã€‚è§’è‰²è®¾ç½®ä»…è€æ¿å¯ç”¨ã€‚</p>
                        </div>
                    </div>
                `;

                container.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const account = target.dataset.account;
                    if (!account) return;
                    const users = getUsers();
                    const user = users.find(u => u.account === account);
                    if (!user) return;

                    if (target.classList.contains('change-group')) {
                        const newGroup = prompt('è¾“å…¥æ–°ä¸»ç»„', user.group);
                        if (newGroup && groups.includes(newGroup)) {
                            user.group = newGroup;
                            saveUsers(users);
                            refreshCurrentSection();
                        } else alert('æ— æ•ˆç»„å');
                    }
                    else if (target.classList.contains('add-group')) {
                        const extra = prompt('è¾“å…¥å…¼ä»»ç»„', '');
                        if (extra && groups.includes(extra) && extra !== user.group && !user.extraGroups.includes(extra)) {
                            user.extraGroups.push(extra);
                            saveUsers(users);
                            refreshCurrentSection();
                        } else alert('æ— æ•ˆæˆ–å·²å­˜åœ¨');
                    }
                    else if (target.classList.contains('set-manager')) {
                        user.role = 'manager'; saveUsers(users); refreshCurrentSection();
                    }
                    else if (target.classList.contains('set-admin')) {
                        user.role = 'admin'; saveUsers(users); refreshCurrentSection();
                    }
                    else if (target.classList.contains('demote-member')) {
                        user.role = 'member'; saveUsers(users); refreshCurrentSection();
                    }
                    else if (target.classList.contains('demote-manager')) {
                        user.role = 'manager'; saveUsers(users); refreshCurrentSection();
                    }
                });

                document.getElementById('addMemberBtn')?.addEventListener('click', () => {
                    const account = prompt('è´¦å·(çº¯è‹±æ–‡)');
                    if (!account || !/^[A-Za-z]+$/.test(account)) { alert('è´¦å·éœ€çº¯è‹±æ–‡'); return; }
                    const pwd = prompt('å¯†ç (æ•°å­—+è‹±æ–‡)');
                    if (!pwd || !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) { alert('å¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—'); return; }
                    const nickname = prompt('ç¬”å');
                    if (!nickname) return;
                    let group = prompt('ä¸»ç»„åˆ«', currentUser.group);
                    if (!group || !groups.includes(group)) { alert('ç»„åˆ«æ— æ•ˆ'); return; }
                    const users = getUsers();
                    if (users.some(u => u.account === account)) { alert('è´¦å·å·²å­˜åœ¨'); return; }
                    users.push({ account, password: pwd, nickname, role: 'member', group, extraGroups: [] });
                    saveUsers(users);
                    refreshCurrentSection();
                });
            }

            // é€šçŸ¥å…¬å‘Š
            function renderNotices(container) {
                const notices = getNotices();
                const canPublish = isManagerOrAbove();
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between">
                            <span><i class="bi bi-megaphone"></i> é€šçŸ¥å…¬å‘Š</span>
                            <span class="badge bg-warning">å‘å¸ƒæƒé™: ç®¡ç†å‘˜åŠä»¥ä¸Š</span>
                        </div>
                        <div class="card-body" id="noticeList">
                            ${notices.map(n => `
                                <div class="alert alert-secondary d-flex justify-content-between align-items-center" data-id="${n.id}">
                                    <span>ğŸ“¢ ${n.title} (${n.publisher} å‘å¸ƒ ${n.time})</span>
                                    <span>
                                        ${n.top ? '<span class="badge bg-info me-2">ç½®é¡¶</span>' : ''}
                                        ${(isAdminOrBoss() || n.publisher === currentUser.nickname) ? '<button class="btn btn-sm btn-outline-danger delete-notice" data-id="'+n.id+'">åˆ é™¤</button>' : ''}
                                    </span>
                                </div>`).join('')}
                            ${notices.length === 0 ? '<div class="text-center text-muted">æš‚æ— å…¬å‘Š</div>' : ''}
                            ${canPublish ? '<button class="btn btn-sm btn-danger mt-2" id="publishNoticeBtn">å‘å¸ƒæ–°é€šçŸ¥</button>' : ''}
                        </div>
                    </div>
                `;
                document.getElementById('publishNoticeBtn')?.addEventListener('click', () => {
                    const title = prompt('é€šçŸ¥æ ‡é¢˜');
                    if (!title) return;
                    const top = confirm('æ˜¯å¦ç½®é¡¶ï¼Ÿ');
                    const notices = getNotices();
                    notices.push({ id: Date.now(), title, publisher: currentUser.nickname, role: currentUser.role, time: new Date().toISOString().slice(0,10), top });
                    saveNotices(notices);
                    refreshCurrentSection();
                });
                container.querySelectorAll('.delete-notice').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.dataset.id;
                        let notices = getNotices().filter(n => n.id != id);
                        saveNotices(notices);
                        refreshCurrentSection();
                    });
                });
            }

            // è®¾ç½®ç®¡ç†ï¼ˆä»…è€æ¿ï¼Œå¢åŠ ç»„åˆ«ï¼‰
            function renderSettings(container) {
                if (!canAccessSettings()) {
                    container.innerHTML = '<div class="alert alert-danger">æ— æƒè®¿é—®</div>';
                    return;
                }
                const groups = getGroups();
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-white fw-bold">âš™ï¸ è®¾ç½®ç®¡ç† Â· ä»…è€æ¿å¯è§</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4"><h6>æ¯å‘¨ç›®æ ‡å­—æ•°</h6><input id="globalTarget" class="form-control" value="28000"></div>
                                <div class="col-md-4"><h6>å®‰å…¨é€‰é¡¹</h6><div class="form-check"><input class="form-check-input" type="checkbox" checked> å¯ç”¨CSRF</div></div>
                                <div class="col-md-4"><h6>ç»„åˆ«ç®¡ç†</h6>
                                    <p>å½“å‰ç»„åˆ«ï¼š${groups.join('ã€')}</p>
                                    <button class="btn btn-outline-primary btn-sm" id="addGroupBtn">æ–°å¢ç»„åˆ«</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="backupBtn">å¤‡ä»½æ•°æ®</button>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-2" id="saveGlobalTarget">ä¿å­˜ç›®æ ‡</button>
                        </div>
                    </div>
                `;
                document.getElementById('saveGlobalTarget')?.addEventListener('click', () => {
                    const newTarget = parseInt(document.getElementById('globalTarget').value, 10);
                    if (newTarget > 0) {
                        let prog = getProgress();
                        prog.forEach(p => p.target = newTarget);
                        saveProgress(prog);
                        alert('å…¨å±€ç›®æ ‡å·²æ›´æ–°');
                        refreshCurrentSection();
                    }
                });
                document.getElementById('backupBtn')?.addEventListener('click', () => {
                    const data = {
                        users: getUsers(),
                        posts: getPosts(),
                        progress: getProgress(),
                        royalties: getRoyalties(),
                        notices: getNotices(),
                        discuss: getDiscuss(),
                        groups: getGroups(),
                        withdrawals: getWithdrawals(),
                        notifications: getNotifications()
                    };
                    localStorage.setItem('backup_' + Date.now(), JSON.stringify(data));
                    alert('æ•°æ®å¤‡ä»½å·²ä¿å­˜åˆ°localStorage');
                });
                document.getElementById('addGroupBtn')?.addEventListener('click', () => {
                    new bootstrap.Modal(document.getElementById('addGroupModal')).show();
                });
            }

            // æ·»åŠ ç»„åˆ«æäº¤
            document.getElementById('submitAddGroup')?.addEventListener('click', () => {
                const newGroup = document.getElementById('newGroupName').value.trim();
                if (!newGroup) return;
                const groups = getGroups();
                if (groups.includes(newGroup)) { alert('ç»„åˆ«å·²å­˜åœ¨'); return; }
                groups.push(newGroup);
                saveGroups(groups);
                // åŒæ­¥è¿›åº¦è¡¨
                let prog = getProgress();
                if (!prog.some(p => p.group === newGroup)) {
                    prog.push({ group: newGroup, outlineDone: false, weekWords: 0, target: 28000 });
                    saveProgress(prog);
                }
                bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
                document.getElementById('newGroupName').value = '';
                refreshCurrentSection();
            });

            // ---------- ç™»å½•/æ³¨å†Œ ----------
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const regMessage = document.getElementById('regMessage');

            // å¡«å……æ³¨å†Œç»„åˆ«
            function fillRegGroup() {
                const select = document.getElementById('regGroup');
                const groups = getGroups();
                select.innerHTML = '';
                groups.filter(g => !g.includes('ç®¡ç†ç»„')).forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    select.appendChild(opt);
                });
            }
            fillRegGroup();

            loginBtn.addEventListener('click', () => {
                const account = document.getElementById('loginAccount').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const users = getUsers();
                const user = users.find(u => u.account === account && u.password === pwd);
                if (user) {
                    currentUser = user;
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    renderApp();
                } else {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
                }
            });

            registerBtn.addEventListener('click', () => {
                const nickname = document.getElementById('regNickname').value.trim();
                const account = document.getElementById('regAccount').value.trim();
                const pwd = document.getElementById('regPassword').value.trim();
                const confirm = document.getElementById('regConfirm').value.trim();
                const group = document.getElementById('regGroup').value;

                if (!nickname || !account || !pwd || !confirm) {
                    regMessage.innerText = 'æ‰€æœ‰å­—æ®µå‡ä¸ºå¿…å¡«';
                    return;
                }
                if (!/^[A-Za-z]+$/.test(account)) {
                    regMessage.innerText = 'è´¦å·å¿…é¡»ä¸ºçº¯è‹±æ–‡å­—æ¯';
                    return;
                }
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/.test(pwd)) {
                    regMessage.innerText = 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œä¸”åªèƒ½ä½¿ç”¨å­—æ¯æ•°å­—';
                    return;
                }
                if (pwd !== confirm) {
                    regMessage.innerText = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
                    return;
                }
                const users = getUsers();
                if (users.some(u => u.account === account)) {
                    regMessage.innerText = 'è´¦å·å·²å­˜åœ¨';
                    return;
                }
                const newUser = {
                    account, password: pwd, nickname, role: 'member', group, extraGroups: []
                };
                users.push(newUser);
                saveUsers(users);
                currentUser = newUser;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                renderApp();
            });

            window.addEventListener('load', () => {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            });
        })();
    // ==================== è¡¥ä¸ï¼šå¢å¼ºé€šçŸ¥å…¬å‘Šï¼ˆç¼–è¾‘æ­£æ–‡ã€æƒé™ä¿®æ­£ï¼‰====================
(function patchNotices() {
    // ç¡®ä¿å½“å‰ç”¨æˆ·ä¿¡æ¯å¯ç”¨ï¼ˆä»åŸç³»ç»ŸåŒæ­¥ï¼‰
    let currentUser = null;
    function syncUser() {
        const sidebar = document.querySelector('#sidebar');
        if (!sidebar) return;
        const welcomeText = sidebar.querySelector('.text-white-50 strong');
        if (!welcomeText) return;
        const nickname = welcomeText.innerText;
        const users = JSON.parse(localStorage.getItem('wanlian_users')) || [];
        currentUser = users.find(u => u.nickname === nickname) || null;
    }

    // è¾…åŠ©ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºé«˜çº§ç®¡ç†å‘˜æˆ–è€æ¿
    function isAdminOrBoss() {
        return currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss');
    }

    // è·å–é€šçŸ¥ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼Œè¡¥ä¸Šcontentå­—æ®µï¼‰
    function getNotices() {
        return (JSON.parse(localStorage.getItem('wanlian_notices')) || []).map(n => ({
            content: '',  // é»˜è®¤æ­£æ–‡
            ...n
        }));
    }
    function saveNotices(notices) {
        localStorage.setItem('wanlian_notices', JSON.stringify(notices));
    }

    // åˆ·æ–°å½“å‰è§†å›¾ï¼ˆè§¦å‘åŸç³»ç»Ÿé‡æ–°æ¸²æŸ“ï¼‰
    function refreshView() {
        const activeLink = document.querySelector('#sidebar nav a.active');
        if (activeLink) activeLink.click();
    }

    // å¢å¼ºä¸€æ¡é€šçŸ¥é¡¹ï¼šæ·»åŠ æ­£æ–‡æ˜¾ç¤ºå’Œç¼–è¾‘æŒ‰é’®
    function enhanceNoticeItem(noticeDiv, notice) {
        if (!noticeDiv || noticeDiv._enhanced) return;
        noticeDiv._enhanced = true;

        // æ·»åŠ æ­£æ–‡é¢„è§ˆï¼ˆéšè—åœ¨å°å­—ä¸­ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºï¼‰
        const contentPreview = document.createElement('div');
        contentPreview.className = 'small text-muted mt-1 text-truncate';
        contentPreview.style.maxWidth = '400px';
        contentPreview.title = notice.content || 'ï¼ˆæ— æ­£æ–‡ï¼‰';
        contentPreview.innerText = notice.content ? notice.content.substring(0, 50) + (notice.content.length > 50 ? 'â€¦' : '') : 'ï¼ˆæ— æ­£æ–‡ï¼‰';
        noticeDiv.querySelector('span:first-child')?.appendChild(contentPreview);

        // å¦‚æœæ˜¯é«˜çº§ç®¡ç†å‘˜æˆ–è€æ¿ï¼Œæ·»åŠ ç¼–è¾‘æŒ‰é’®
        if (isAdminOrBoss()) {
            const actionSpan = noticeDiv.querySelector('span:last-child');
            if (actionSpan && !actionSpan.querySelector('.edit-notice')) {
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-outline-primary ms-2 edit-notice';
                editBtn.dataset.id = notice.id;
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘';
                actionSpan.appendChild(editBtn);

                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = editBtn.dataset.id;
                    const notices = getNotices();
                    const notice = notices.find(n => n.id == id);
                    if (!notice) return;

                    // å¼¹å‡ºç¼–è¾‘æ¡†
                    const newTitle = prompt('ç¼–è¾‘æ ‡é¢˜', notice.title);
                    if (newTitle === null) return;
                    const newContent = prompt('ç¼–è¾‘æ­£æ–‡', notice.content || '');
                    if (newContent === null) return;

                    notice.title = newTitle.trim() || notice.title;
                    notice.content = newContent.trim();
                    saveNotices(notices);
                    refreshView();
                });
            }
        }
    }

    // åŠ«æŒå‘å¸ƒæŒ‰é’®ï¼Œæ›¿æ¢ä¸ºè‡ªå®šä¹‰å¼¹çª—ï¼ˆæ”¯æŒæ­£æ–‡ï¼‰
    function hijackPublishButton() {
        const publishBtn = document.getElementById('publishNoticeBtn');
        if (!publishBtn) return;

        // ç§»é™¤åŸäº‹ä»¶ï¼ˆé€šè¿‡å…‹éš†æ›¿æ¢ï¼‰
        const newBtn = publishBtn.cloneNode(true);
        publishBtn.parentNode.replaceChild(newBtn, publishBtn);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isAdminOrBoss()) {
                alert('åªæœ‰é«˜çº§ç®¡ç†å‘˜å’Œè€æ¿å¯ä»¥å‘å¸ƒé€šçŸ¥');
                return;
            }
            const title = prompt('è¾“å…¥é€šçŸ¥æ ‡é¢˜');
            if (!title) return;
            const content = prompt('è¾“å…¥é€šçŸ¥æ­£æ–‡ï¼ˆå¯ç•™ç©ºï¼‰');
            const top = confirm('æ˜¯å¦ç½®é¡¶ï¼Ÿ');

            const notices = getNotices();
            notices.push({
                id: Date.now(),
                title,
                content: content || '',
                publisher: currentUser.nickname,
                role: currentUser.role,
                time: new Date().toISOString().slice(0, 10),
                top
            });
            saveNotices(notices);
            refreshView();
        });
    }

    // å¯åŠ¨ MutationObserver ç›‘å¬ä¸»å†…å®¹åŒºï¼Œå½“é€šçŸ¥åˆ—è¡¨å‡ºç°æ—¶è¿›è¡Œå¢å¼º
    const mainContent = document.getElementById('mainContent');
    if (!mainContent) return;

    const observer = new MutationObserver(() => {
        // åŒæ­¥å½“å‰ç”¨æˆ·
        syncUser();
        if (!currentUser) return;

        // åŠ«æŒå‘å¸ƒæŒ‰é’®ï¼ˆæ¯æ¬¡æ¸²æŸ“åé‡æ–°ç»‘å®šï¼‰
        hijackPublishButton();

        // æŸ¥æ‰¾æ‰€æœ‰é€šçŸ¥é¡¹
        const noticeItems = mainContent.querySelectorAll('.alert-secondary[data-id]');
        if (noticeItems.length === 0) return;

        // è·å–æœ€æ–°é€šçŸ¥æ•°æ®
        const notices = getNotices();
        noticeItems.forEach(div => {
            const id = div.dataset.id;
            const notice = notices.find(n => n.id == id);
            if (notice) enhanceNoticeItem(div, notice);
        });
    });

    observer.observe(mainContent, { childList: true, subtree: true });
})();
// ==================== è¡¥ä¸ç»“æŸ ====================
	</script>
</body>
</html>